<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>第 24 章 MySQL の拡張</title><link rel="stylesheet" type="text/css" href="mvl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="MySQL 5.6 リファレンスマニュアル"><link rel="up" href="index.html" title="MySQL 5.6 リファレンスマニュアル"><link rel="prev" href="connectors-apis.html" title="第 23 章 Connector および API"><link rel="next" href="mysql-enterprise.html" title="第 25 章 MySQL Enterprise Edition">
<script language="javascript" type="text/javascript">
  function addOnload(theFunc)
  {
    var previous = window.onload;
    if (typeof window.onload != 'function')
    {
      window.onload = theFunc;
    }
    else
    {
      window.onload = function()
      {
        previous();
        theFunc();
      }
    }
  }

  addOnload(function()
  {
    var base = new Date(1442918127*1000);
    var now = new Date();
    var diff = ((now-base)/1000)/(24*3600);

    if (diff > 90) {
      var nodes = document.getElementsByClassName('titlepage');
      nodes[0].innerHTML = '<p style="border: 5px #ff0000 solid; padding: 5px; margin 5px">' +
        'This copy of the manual is more than 90 days old. We encourage you to download a ' +
        'new version from <a href="http://dev.mysql.com">dev.mysql.com/doc</a>.</p>' + nodes[0].innerHTML;
    }
  });
</script>
<noscript></noscript>
</head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 24 章 MySQL の拡張</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="connectors-apis.html">前</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="mysql-enterprise.html">次へ</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="extending-mysql"></a>第 24 章 MySQL の拡張</h1></div></div></div><div class="toc"><p><b>目次</b></p><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#mysql-internals">24.1 MySQL の内部仕様</a></span></dt><dd><dl><dt><span class="section"><a href="extending-mysql.html#mysql-threads">24.1.1 MySQL のスレッド</a></span></dt><dt><span class="section"><a href="extending-mysql.html#mysql-test-suite">24.1.2 MySQL テストスイート</a></span></dt></dl></dd><dt><span class="section"><a href="extending-mysql.html#plugin-api">24.2 MySQL プラグイン API</a></span></dt><dd><dl><dt><span class="section"><a href="extending-mysql.html#plugin-api-characteristics">24.2.1 プラグイン API の特徴</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-api-components">24.2.2 プラグイン API のコンポーネント</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-types">24.2.3 プラグインのタイプ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-plugins">24.2.4 プラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-services">24.2.5 プラグインのための MySQL サービス</a></span></dt></dl></dd><dt><span class="section"><a href="extending-mysql.html#adding-functions">24.3 MySQL への新しい関数の追加</a></span></dt><dd><dl><dt><span class="section"><a href="extending-mysql.html#udf-features">24.3.1 ユーザー定義関数インタフェースの機能</a></span></dt><dt><span class="section"><a href="extending-mysql.html#adding-udf">24.3.2 新しいユーザー定義関数の追加</a></span></dt><dt><span class="section"><a href="extending-mysql.html#adding-native-function">24.3.3 新しいネイティブ関数の追加</a></span></dt></dl></dd><dt><span class="section"><a href="extending-mysql.html#porting">24.4 MySQL のデバッグおよび移植</a></span></dt><dd><dl><dt><span class="section"><a href="extending-mysql.html#debugging-server">24.4.1 MySQL サーバーのデバッグ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#debugging-client">24.4.2 MySQL クライアントのデバッグ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#dbug-package">24.4.3 DBUG パッケージ</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mysql-internals"></a>24.1 MySQL の内部仕様</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#mysql-threads">24.1.1 MySQL のスレッド</a></span></dt><dt><span class="section"><a href="extending-mysql.html#mysql-test-suite">24.1.2 MySQL テストスイート</a></span></dt></dl></div><a class="indexterm" name="idm139978998546400"></a><a class="indexterm" name="idm139978998544976"></a><p>
      この章では、MySQL コードを記述するときに知っておく必要がある多くの事柄について説明します。MySQL 開発の動向を調べたり貢献したりするには、<a class="xref" href="installing.html#installing-development-tree" title="2.9.3 開発ソースツリーを使用して MySQL をインストールする">セクション2.9.3「開発ソースツリーを使用して MySQL をインストールする」</a>の手順に従ってください。MySQL の内部仕様について興味がある場合、弊社の <code class="literal">internals</code> メーリングリストに登録することもお勧めします。このリストのトラフィックは比較的少なめです。登録する方法については、<a class="xref" href="introduction.html#mailing-lists" title="1.6.1 MySQL メーリングリスト">セクション1.6.1「MySQL メーリングリスト」</a>を参照してください。オラクルの多くの MySQL 開発者が <code class="literal">internals</code> リストに登録されており、弊社は MySQL コードを記述するユーザーを支援しています。コードについて質問したり、MySQL プロジェクトに貢献すると思われるパッチを送信したりするときに、このリストを気軽に利用してください。
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mysql-threads"></a>24.1.1 MySQL のスレッド</h3></div></div></div><p>
        MySQL サーバーは次のスレッドを作成します。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            接続マネージャースレッドは、サーバーが待機しているネットワークインタフェース上でクライアントの接続要求を処理します。どのプラットフォームでも、1 つのマネージャースレッドが TCP/IP 接続要求を処理します。Unix では、このマネージャースレッドは Unix ソケットファイルの接続要求も処理します。Windows では、1 つのマネージャースレッドが共有メモリーの接続要求を処理し、別のマネージャースレッドが名前付きパイプの接続要求を処理します。サーバーは、待機していないインタフェースを処理するためのスレッドを作成しません。たとえば、Windows サーバーで名前付きパイプ接続のサポートが有効になっていない場合、これらの接続を処理するスレッドは作成されません。
          </p></li><li class="listitem"><p>
            接続マネージャースレッドは、各クライアント接続を、その接続の認証および要求を処理する専用スレッドに関連付けます。マネージャースレッドは、必要に応じて新しいスレッドを作成しますが、まずスレッドキャッシュを調べて接続に使用できるスレッドが含まれているかどうかを確認することによって、それを回避することを試みます。接続が終了すると、スレッドキャッシュが満杯でない場合は、そのスレッドがスレッドキャッシュに返されます。
          </p><p>
            スレッドのリソースを制御するパラメータの調整については、<a class="xref" href="optimization.html#connection-threads" title="8.11.5.1 MySQL のクライアント接続のためのスレッドの使用方法">セクション8.11.5.1「MySQL のクライアント接続のためのスレッドの使用方法」</a>を参照してください。
          </p></li><li class="listitem"><p>
            マスターレプリケーションサーバーでは、スレーブサーバーからの接続はクライアント接続のように扱われ、接続されているスレーブごとに 1 つのスレッドがあります。
          </p></li><li class="listitem"><p>
            スレーブレプリケーションサーバー上では、マスターサーバーに接続してそこから更新を読み取るための I/O スレッドが開始されます。マスターから読み取られた更新を適用するための SQL スレッドが開始されます。これらの 2 つのスレッドは別個に実行され、別個に開始および停止できます。
          </p></li><li class="listitem"><p>
            シグナルスレッドはすべてのシグナルを処理します。通常、このスレッドは、アラームの処理、および長時間アイドル状態になっている接続をタイムアウトさせる <code class="literal">process_alarm()</code> の呼び出しも行います。
          </p></li><li class="listitem"><p>
            <code class="literal">InnoDB</code> が使用される場合は、デフォルトでは追加の読み取りスレッドおよび書き込みスレッドが存在します。これらの数は、<code class="literal">innodb_read_io_threads</code> および <code class="literal">innodb_write_io_threads</code> パラメータによって制御されます。<a class="xref" href="innodb-storage-engine.html#innodb-parameters" title="14.12 InnoDB の起動オプションおよびシステム変数">セクション14.12「InnoDB の起動オプションおよびシステム変数」</a>を参照してください。
          </p></li><li class="listitem"><p>
            <span class="command"><strong>mysqld</strong></span> が <code class="option">-DUSE_ALARM_THREAD</code> を指定してコンパイルされている場合は、アラームを処理する専用のスレッドが作成されます。これが使用されるのは、<code class="literal">sigwait()</code> に問題があるシステムの場合、および専用のシグナル処理スレッドを使用せずにアプリケーションで <code class="literal">thr_alarm()</code> コードを使用する場合のみです。
          </p></li><li class="listitem"><p>
            サーバーが <code class="option">--flush_time=<em class="replaceable"><code>val</code></em></code> オプションを指定して起動された場合、<em class="replaceable"><code>val</code></em> 秒ごとにすべてのテーブルをフラッシュする専用のスレッドが作成されます。
          </p></li><li class="listitem"><p>
            <code class="literal">INSERT DELAYED</code> ステートメントが発行された各テーブルには、独自のスレッドが作成されます。<a class="xref" href="sql-syntax.html#insert-delayed" title="13.2.5.2 INSERT DELAYED 構文">セクション13.2.5.2「INSERT DELAYED 構文」</a>を参照してください。
          </p></li><li class="listitem"><p>
            イベントスケジューラがアクティブである場合は、スケジューラの 1 つスレッド、および現在実行されている各イベントのそれぞれのスレッドが存在します。<a class="xref" href="stored-programs-views.html#events-overview" title="20.4.1 イベントスケジューラの概要">セクション20.4.1「イベントスケジューラの概要」</a>を参照してください。
          </p></li></ul></div><p>
        <span class="command"><strong>mysqladmin processlist</strong></span> は、接続、<code class="literal">INSERT DELAYED</code>、レプリケーション、およびイベントスレッドのみを表示します。
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mysql-test-suite"></a>24.1.2 MySQL テストスイート</h3></div></div></div><a class="indexterm" name="idm139978998506880"></a><a class="indexterm" name="idm139978998504720"></a><p>
        Unix ソースおよびバイナリ配布に付属するテストシステムを使用することによって、ユーザーおよび開発者は MySQL コードのリグレッションテストを実行できます。これらのテストは Unix 上で実行できます。
      </p><p>
        独自のテストケースを記述することもできます。システム要件を含む MySQL テストフレームワークについては、<a class="ulink" href="http://dev.mysql.com/doc/mysqltest/2.0/en/" target="_top">http://dev.mysql.com/doc/mysqltest/2.0/en/</a> から入手できるマニュアルを参照してください。
      </p><p>
        現在のテストケースのセットは MySQL のすべてをテストするわけではありませんが、SQL 処理コードのほとんどの明らかなバグやオペレーティングシステムまたはライブラリの問題を捕捉し、レプリケーションのテストに関してはかなり徹底しています。テストによってコードの 100% がカバーされることを目標としています。弊社はテストスイートへの貢献を歓迎しています。使用しているシステムで重要な機能を検査するテストに貢献すれば、使用しているアプリケーションが将来のすべての MySQL リリースで動作することが保証されます。
      </p><p>
        テストシステムは、テスト言語インタプリタ (<span class="command"><strong>mysqltest</strong></span>)、すべてのテストを実行する Perl スクリプト (<span class="command"><strong>mysql-test-run.pl</strong></span>)、特別なテスト言語で記述された実際のテストケース、およびそれらの予期される結果で構成されています。ビルド後にシステム上でテストスイートを実行するには、ソースのルートディレクトリから <span class="command"><strong>make test</strong></span> と入力するか、場所を <code class="filename">mysql-test</code> ディレクトリに変更して、<span class="command"><strong>./mysql-test-run.pl</strong></span> と入力します。バイナリ配布をインストールした場合は、インストールルートディレクトリの下にある <code class="filename">mysql-test</code> ディレクトリ (<code class="filename">/usr/local/mysql/mysql-test</code> など) に場所を変更して、<span class="command"><strong>./mysql-test-run.pl</strong></span> を実行します。すべてのテストが成功します。成功しないものがあれば原因を調べ、MySQL 内のバグを示す場合は問題を報告してください。<a class="xref" href="introduction.html#bug-reports" title="1.7 質問またはバグをレポートする方法">セクション1.7「質問またはバグをレポートする方法」</a>を参照してください。
      </p><p>
        1 つのテストに失敗する場合は、<code class="option">--force</code> オプションを指定して <span class="command"><strong>mysql-test-run.pl</strong></span> を実行し、ほかのテストも失敗するかどうかを確認してください。
      </p><p>
        テストスイートを実行するマシン上で <span class="command"><strong>mysqld</strong></span> のコピーが実行中である場合、それがポート <code class="literal">9306</code> または <code class="literal">9307</code> を使用していなければ、停止する必要はありません。これらのいずれかのポートが使用中である場合、環境変数 <code class="literal">MTR_BUILD_THREAD</code> を適切な値に設定します。こうすることで、テストスイートは、マスター、スレーブ、および NDB のポートに別のセットを使用します。例:
      </p><pre class="programlisting">
shell&gt; export MTR_BUILD_THREAD=31
shell&gt; ./mysql-test-run.pl [<em class="replaceable"><code>options</code></em>] [<em class="replaceable"><code>test_name</code></em>]
</pre><p>
        <code class="filename">mysql-test</code> ディレクトリでは、<span class="command"><strong>./mysql-test-run.pl <em class="replaceable"><code>test_name</code></em></strong></span> を指定することで個々のテストケースを実行できます。
      </p><p>
        テストスイートについて質問がある場合、または貢献するテストケースがある場合は、MySQL <code class="literal">internals</code> メーリングリストに電子メールメッセージを送信してください。<a class="xref" href="introduction.html#mailing-lists" title="1.6.1 MySQL メーリングリスト">セクション1.6.1「MySQL メーリングリスト」</a> を参照してください。
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="plugin-api"></a>24.2 MySQL プラグイン API</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#plugin-api-characteristics">24.2.1 プラグイン API の特徴</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-api-components">24.2.2 プラグイン API のコンポーネント</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-types">24.2.3 プラグインのタイプ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-plugins">24.2.4 プラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-services">24.2.5 プラグインのための MySQL サービス</a></span></dt></dl></div><a class="indexterm" name="idm139978998476272"></a><a class="indexterm" name="idm139978998474848"></a><p>
      MySQL は、サーバーコンポーネントの作成を可能にするプラグイン API をサポートします。プラグインはサーバー起動時にロードしたり、実行時にサーバーを再起動せずにロードおよびアンロードしたりできます。API は汎用的なものであり、プラグインが実行できる動作を指定しません。このインタフェースによってサポートされるコンポーネントには、ストレージエンジン、全文パーサープラグイン、サーバー拡張機能、およびその他のコンポーネントがあります。
    </p><p>
      たとえば、全文パーサープラグインは、組み込みの全文パーサーの代わりに使用したり、強化したりするために使用できます。プラグインは、組み込みパーサーによって使用されるものと異なるルールを使用して、テキストを単語に構文解析できます。これは、組み込みパーサーが予期する特性と異なる特性を持つテキストを構文解析する必要がある場合に役立ちます。
    </p><p>
      プラグインインタフェースは、以前のユーザー定義関数 (UDF) インタフェースよりも汎用的です。

    </p><p>
      プラグインインタフェースは <code class="literal">mysql</code> データベースの <code class="literal">plugin</code> テーブルを使用して、<code class="literal">INSTALL PLUGIN</code> ステートメントによって永続的にインストールされているプラグインに関する情報を記録します。このテーブルは、MySQL インストール処理の一部として作成されます。プラグインは、<code class="option">--plugin-load</code> オプションを指定して単一のサーバーを起動することによってもインストールできます。この方法でインストールされたプラグインは、<code class="literal">plugin</code> テーブルに記録されません。<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>を参照してください。
    </p><p>
      MySQL 5.6 では、サーバープラグイン用の API のほかにクライアントプラグイン用の API もサポートされています。これは、たとえば、サーバー側プラグインとクライアント側プラグインが連係して、クライアントがサーバーにさまざまな認証方式を使用して接続できるようにする認証プラグインによって使用されます。
    </p><h3><a name="idm139978998461776"></a>追加のリソース</h3><p>
      Sergei Golubchik および Andrew Hutchings 共著の『<em class="citetitle">MySQL 5.1 Plugin Development</em>』には、プラグイン API に関する豊富な情報が記載されています。この書籍の表題には MySQL Server 5.1 と記載されていますが、書籍内の大半の情報は以降のバージョンにも同様に当てはまります。
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="plugin-api-characteristics"></a>24.2.1 プラグイン API の特徴</h3></div></div></div><p>
        サーバープラグイン API には次の特徴があります。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            すべてのプラグインにはいくつかの共通点があります。
          </p><p>
            各プラグインには、SQL ステートメント内で参照可能な名前のほかに、ほかの情報を提供する作成者および説明などのメタデータがあります。この情報は、<code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルまたは <code class="literal">SHOW PLUGINS</code> ステートメントを使用して調査できます。
          </p></li><li class="listitem"><p>
            プラグインフレームワークは、別の種類のプラグインに対応するために拡張可能です。
          </p><p>
            プラグイン API の一部の特性はすべてのタイプのプラグインに共通していますが、API ではタイプ固有のインタフェース要素も使用できるため、異なるタイプのプラグインを作成できます。ある用途を持つプラグインは、それ自体の要件にもっとも適したインタフェースを持っているため、ほかのプラグインタイプの要件には適していない可能性があります。
          </p><p>
            ストレージエンジン、全文パーサー、<code class="literal">INFORMATION_SCHEMA</code> テーブルなどのさまざまなタイプのプラグイン用のインタフェースが存在します。ほかのインタフェースも追加できます。
          </p></li><li class="listitem"><p>
            プラグインは情報をユーザーに公開します。
          </p><p>
            プラグインは、<code class="literal">SHOW VARIABLES</code> および <code class="literal">SHOW STATUS</code> ステートメントを使用して得られるシステム変数およびステータス変数を実装できます。
          </p></li><li class="listitem"><p>
            プラグイン API にはバージョン情報が含まれています。
          </p><p>
            プラグイン API に含まれているバージョン情報によって、プラグインライブラリおよびそれに含まれる各プラグインが、ライブラリのビルドに使用された API バージョンを自己認識できます。API がその後変更されるとバージョン番号が変更されますが、サーバーは対象となるプラグインライブラリのバージョン情報を検査して、そのライブラリ内のプラグインをサポートしているかどうかを判別できます。
          </p><p>
            バージョン番号には 2 つのタイプがあります。1 つ目は、全般的なプラグインフレームワーク自体のバージョン番号です。各プラグインライブラリには、この種類のバージョン番号が含まれています。2 つ目のタイプのバージョンは個々のプラグインに適用されます。特定のタイプの各プラグインにはそのインタフェースのバージョンがあるため、ライブラリ内の各プラグインにはタイプ固有のバージョン番号があります。たとえば、全文パーサープラグインを含むライブラリには全般的なプラグイン API バージョン番号があり、そのプラグインには全文プラグインインタフェースに固有のバージョン番号があります。
          </p></li><li class="listitem"><p>
            プラグイン API はセキュリティー制約を実装します。
          </p><p>
            プラグインライブラリは特定の専用ディレクトリにインストールする必要があり、ディレクトリの場所はサーバーによって制御され、実行時に変更することはできません。また、ライブラリには、それがプラグインライブラリであることを識別する特定のシンボルが含まれている必要があります。サーバーは、プラグインとしてビルドされていないものをプラグインとしてロードしません。
          </p></li><li class="listitem"><p>
            プラグインはサーバーサービスにアクセスできます。
          </p><p>
            サービスインタフェースは、プラグインが通常の関数呼び出しを使用してアクセスできるサーバー機能を公開します。詳細は、<a class="xref" href="extending-mysql.html#plugin-services" title="24.2.5 プラグインのための MySQL サービス">セクション24.2.5「プラグインのための MySQL サービス」</a>を参照してください。
          </p></li></ul></div><p>
        サーバープラグイン API は、それに置き換わる前のユーザー定義関数 (UDF) API といくつかの点で似ていますが、古いインタフェースよりさまざまな点で優れています。たとえば、UDF にはバージョン情報がありません。また、新しいプラグインインタフェースには、以前の UDF インタフェースでのセキュリティー問題がありません。プラグインでない UDF を記述するための以前のインタフェースでは、システムのダイナミックリンカーによって検索されたすべてのディレクトリからライブラリをロードでき、UDF ライブラリを識別するシンボルは比較的特定性の低いものでした。
      </p><p>
        クライアントプラグイン API には類似したアーキテクチャー上の特徴がありますが、クライアントプラグインはサーバープラグインのようにサーバーに直接アクセスしません。
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="plugin-api-components"></a>24.2.2 プラグイン API のコンポーネント</h3></div></div></div><p>
        サーバープラグインの実装は、いくつかのコンポーネントで構成されています。
      </p><p>
        SQL ステートメント:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">INSTALL PLUGIN</code> はプラグインを <code class="literal">mysql.plugin</code> テーブルに登録し、プラグインコードをロードします。
          </p></li><li class="listitem"><p>
            <code class="literal">UNINSTALL PLUGIN</code> はプラグインを <code class="literal">mysql.plugin</code> テーブルから登録解除し、プラグインコードをアンロードします。
          </p></li><li class="listitem"><p>
            全文インデックス作成用の <code class="literal">WITH PARSER</code> 句は、全文パーサープラグインを特定の <code class="literal">FULLTEXT</code> インデックスに関連付けます。
          </p></li><li class="listitem"><p>
            <code class="literal">SHOW PLUGINS</code> は、サーバープラグインについての情報を表示します。
          </p></li></ul></div><p>
        コマンド行オプションおよびシステム変数:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="option">--plugin-load</code> オプションを指定すると、サーバー起動時にプラグインをロードできます。
          </p></li><li class="listitem"><p>
            <code class="literal">plugin_dir</code> システム変数は、すべてのプラグインをインストールする必要があるディレクトリの場所を指定します。この変数の値は、サーバー起動時に <code class="option">--plugin_dir=<em class="replaceable"><code>path</code></em></code> オプションで指定できます。<span class="command"><strong>mysql_config --plugindir</strong></span> を指定すると、デフォルトのプラグインディレクトリのパス名が表示されます。
          </p></li></ul></div><p>
        プラグインのロードについての追加情報は、<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>を参照してください。
      </p><p>
        プラグインに関連するテーブル:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルにはプラグイン情報が格納されています。
          </p></li><li class="listitem"><p>
            <code class="literal">mysql.plugin</code> テーブルには、<code class="literal">INSTALL PLUGIN</code> によってインストールされた各プラグインが示され、プラグインを使用するために必要となります。新規に MySQL をインストールする場合、このテーブルはインストール処理中に作成されます。
          </p></li></ul></div><p>
        クライアントプラグインの実装はより単純です。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">mysql_options()</code> C API 関数の場合は、<code class="literal">MYSQL_DEFAULT_AUTH</code> オプションおよび <code class="literal">MYSQL_PLUGIN_DIR</code> オプションを指定すると、クライアントプログラムが認証プラグインをロードできます。
          </p></li><li class="listitem"><p>
            クライアントプラグインを管理できる C API 関数があります。
          </p></li></ul></div><p>
        MySQL がプラグインを実装する方法を調べるには、MySQL ソース配布内の次のソースファイルを参照してください。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="filename">include/mysql</code> ディレクトリの <code class="filename">plugin.h</code> は、パブリックなプラグイン API を公開しています。プラグインライブラリを記述するすべてのユーザーは、このファイルを調査することをお勧めします。<code class="filename">plugin_<em class="replaceable"><code>xxx</code></em>.h</code> ファイルには特定のタイプのプラグインに関する追加情報があります。<code class="filename">client_plugin.h</code> にはクライアントプラグインに固有の情報が含まれています。
          </p></li><li class="listitem"><p>
            <code class="filename">sql</code> ディレクトリ内の <code class="filename">sql_plugin.h</code> および <code class="filename">sql_plugin.cc</code> は、内部プラグインの実装を構成しています。<code class="filename">sql_acl.cc</code> はサーバーが認証プラグインを使用する場所です。プラグイン開発者はこれらのファイルを参照する必要はありません。サーバーがプラグインを処理する方法について知りたい場合は、これらのファイルを参照できます。
          </p></li><li class="listitem"><p>
            <code class="filename">sql-common</code> ディレクトリ内の、<code class="filename">client_plugin.h</code> は C API クライアントプラグイン関数を実装し、<code class="literal">client.c</code> はクライアント認証サポートを実装します。プラグイン開発者はこれらのファイルを参照する必要はありません。サーバーがプラグインを処理する方法について知りたい場合は、これらのファイルを参照できます。
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="plugin-types"></a>24.2.3 プラグインのタイプ</h3></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#storage-engine-plugins">24.2.3.1 ストレージエンジンプラグイン</a></span></dt><dt><span class="section"><a href="extending-mysql.html#full-text-plugins">24.2.3.2 全文パーサープラグイン</a></span></dt><dt><span class="section"><a href="extending-mysql.html#daemon-plugins">24.2.3.3 デーモンプラグイン</a></span></dt><dt><span class="section"><a href="extending-mysql.html#information-schema-plugins">24.2.3.4 INFORMATION_SCHEMA プラグイン</a></span></dt><dt><span class="section"><a href="extending-mysql.html#semisynchronous-replication-plugins">24.2.3.5 準同期レプリケーションプラグイン</a></span></dt><dt><span class="section"><a href="extending-mysql.html#audit-plugins">24.2.3.6 監査プラグイン</a></span></dt><dt><span class="section"><a href="extending-mysql.html#authentication-plugins">24.2.3.7 認証プラグイン</a></span></dt><dt><span class="section"><a href="extending-mysql.html#password-validation-plugins">24.2.3.8 パスワード検証プラグイン</a></span></dt></dl></div><p>
        プラグイン API を使用すると、さまざまな機能が実装されたプラグインを作成できます。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            ストレージエンジン
          </p></li><li class="listitem"><p>
            全文パーサー
          </p></li><li class="listitem"><p>
            デーモン
          </p></li><li class="listitem"><p>
            <code class="literal">INFORMATION_SCHEMA</code> テーブル
          </p></li><li class="listitem"><p>
            準同期レプリケーション
          </p></li><li class="listitem"><p>
            監査
          </p></li><li class="listitem"><p>
            認証
          </p></li></ul></div><p>
        次のセクションでは、これらのプラグインタイプの概要について説明します。
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="storage-engine-plugins"></a>24.2.3.1 ストレージエンジンプラグイン</h4></div></div></div><a class="indexterm" name="idm139978998378016"></a><a class="indexterm" name="idm139978998376528"></a><p>
          MySQL サーバーによって使用されるプラガブルストレージエンジンアーキテクチャーにより、ストレージエンジンをプラグインとして作成し、実行中のサーバーにロードしたりそのサーバーからアンロードしたりできます。このアーキテクチャーの説明については、<a class="xref" href="storage-engines.html#pluggable-storage-overview" title="15.11 MySQL ストレージエンジンアーキテクチャーの概要">セクション15.11「MySQL ストレージエンジンアーキテクチャーの概要」</a>を参照してください。
        </p><p>
          プラグイン API を使用してストレージエンジンを作成するための方法については、「<a class="ulink" href="http://dev.mysql.com/doc/internals/en/custom-engine.html" target="_top">MySQL Internals: Writing a Custom Storage Engine</a>」を参照してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="full-text-plugins"></a>24.2.3.2 全文パーサープラグイン</h4></div></div></div><a class="indexterm" name="idm139978998370000"></a><a class="indexterm" name="idm139978998368544"></a><p>
          MySQL には、全文操作 (インデックス付けされるテキストの構文解析、または検索に使用される用語を判別するためのクエリー文字列の構文解析) のためにデフォルトで使用される組み込みパーサーがあります。全文処理の場合、<span class="quote">「<span class="quote">構文解析</span>」</span>とは、単語を構成する文字シーケンスや単語の境界となる位置を定義するルールに基づいて、テキストまたはクエリー文字列から単語を抽出することを意味します。
        </p><p>
          インデックスを作成するために構文解析するとき、パーサーは各単語をサーバーに渡し、サーバーは単語を全文インデックスに追加します。クエリー文字列を構文解析するとき、パーサーは各単語をサーバーに渡し、サーバーは単語を蓄積して検索に使用します。
        </p><p>
          組み込みの全文パーサーの構文解析プロパティーは、<a class="xref" href="functions.html#fulltext-search" title="12.9 全文検索関数">セクション12.9「全文検索関数」</a>に記載されています。これらのプロパティーには、テキストから単語を抽出する方法を決定するためのルールも含まれています。パーサーは、短い単語または長い単語を除外する <code class="literal">ft_min_word_len</code>、<code class="literal">ft_max_word_len</code> などの特定のシステム変数、および無視される一般的な単語を示すストップワードリストの影響を受けます。
        </p><p>
          プラグイン API を使用すると、独自の全文パーサーを作成して、パーサーの基本的な機能を制御できます。パーサープラグインは 2 つの役割のいずれかで動作できます。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              プラグインを組み込みパーサーの代わりに使用できます。この役割では、プラグインは構文解析する対象の入力データを読み取り、入力データを単語に分割し、単語を (インデックス設定または単語の蓄積のために) サーバーに渡します。
            </p><p>
              この方法でパーサーを使用する 1 つの理由は、入力データを単語に分割する方法を決定するために、組み込みパーサーのルールとは異なるルールを使用する必要がある場合です。たとえば、組み込みパーサーは<span class="quote">「<span class="quote">case-sensitive</span>」</span>というテキストを<span class="quote">「<span class="quote">case</span>」</span>および<span class="quote">「<span class="quote">sensitive</span>」</span>という 2 つの単語で構成されるものとして解釈するが、あるアプリケーションではこのテキストを単一の単語として扱う必要があることもあります。
            </p></li><li class="listitem"><p>
              プラグインは組み込みパーサーのフロントエンドとして動作することによって、組み込みパーサーと連動できます。この役割では、プラグインは入力データからテキストを抽出してテキストをパーサーに渡し、パーサーはその通常の構文解析ルールを使用してテキストを単語に分割します。この構文解析は、特に、<code class="literal">ft_<em class="replaceable"><code>xxx</code></em></code> システム変数およびストップワードリストの影響を受けます。
            </p><p>
              この方法でパーサーを使用する 1 つの理由は、PDF ドキュメント、XML ドキュメント、<code class="filename">.doc</code> ファイルなどのコンテンツにインデックスを設定する必要がある場合です。組み込みパーサーはこれらのタイプの入力データのためのものではありませんが、プラグインを使用してこれらの入力ソースからテキストを抜き出し、テキストを組み込みパーサーに渡すことができます。
            </p></li></ul></div><p>
          パーサープラグインが両方の役割で動作することも可能です。つまり、平文でないテキスト入力からテキストを抽出し (フロントエンドの役割)、テキストを構文解析して単語を得る (組み込みパーサーの代わりとなる) ことができます。
        </p><p>
          全文プラグインは、インデックスごとに全文インデックスに関連付けられます。つまり、パーサープラグインを最初にインストールした状態では、全文操作にパーサープラグインを使用することはできません。単にパーサープラグインが利用可能になるだけです。たとえば、個々の <code class="literal">FULLTEXT</code> インデックスを作成するときに、全文パーサープラグインを <code class="literal">WITH PARSER</code> 句に指定できるようになります。テーブル作成時にそのようなインデックスを作成するには、次のステートメントを実行します。
        </p><pre class="programlisting">
CREATE TABLE t
(
  doc CHAR(255),
  FULLTEXT INDEX (doc) WITH PARSER my_parser
) ENGINE=MyISAM;
</pre><p>
          または、テーブルが作成されたあとにインデックスを追加できます。
        </p><pre class="programlisting">
ALTER TABLE t ADD FULLTEXT INDEX (doc) WITH PARSER my_parser;
</pre><p>
          パーサーをインデックスに関連付けるために SQL を変更する箇所は、<code class="literal">WITH PARSER</code> 句のみです。検索は以前と同様に指定し、クエリーを変更する必要はありません。
        </p><p>
          パーサープラグインを <code class="literal">FULLTEXT</code> インデックスに関連付けると、そのインデックスを使用するためにこのプラグインが必要になります。そのパーサープラグインが削除された場合は、パーサープラグインに関連付けられていたすべてのインデックスが使用できなくなります。プラグインを使用できないテーブルを使用しようとするとエラーになりますが、<code class="literal">DROP TABLE</code> は引き続き実行できます。
        </p><p>
          全文プラグインについては、<a class="xref" href="extending-mysql.html#writing-full-text-plugins" title="24.2.4.4 全文パーサープラグインの作成">セクション24.2.4.4「全文パーサープラグインの作成」</a>を参照してください。MySQL 5.6 では、<code class="literal">MyISAM</code> を使用したフルインデックスプラグインのみがサポートされます。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="daemon-plugins"></a>24.2.3.3 デーモンプラグイン</h4></div></div></div><a class="indexterm" name="idm139978998335952"></a><a class="indexterm" name="idm139978998334496"></a><p>
          デーモンプラグインは、サーバーによって実行されるがサーバーと通信しないコードに使用される単純なタイプのプラグインです。MySQL 配布には、定期的にハートビートメッセージをファイルに書き込むデーモンプラグインの例が含まれています。
        </p><p>
          デーモンプラグインについては、<a class="xref" href="extending-mysql.html#writing-daemon-plugins" title="24.2.4.5 デーモンプラグインの作成">セクション24.2.4.5「デーモンプラグインの作成」</a>を参照してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="information-schema-plugins"></a>24.2.3.4 INFORMATION_SCHEMA プラグイン</h4></div></div></div><a class="indexterm" name="idm139978998328800"></a><a class="indexterm" name="idm139978998327360"></a><p>
          <code class="literal">INFORMATION_SCHEMA</code> プラグインを使用すると、<code class="literal">INFORMATION_SCHEMA</code> データベース経由でユーザーに公開されるサーバーメタデータを含むテーブルを作成できます。たとえば、<code class="literal">InnoDB</code> は、<code class="literal">INFORMATION_SCHEMA</code> プラグインを使用して、現在のトランザクションおよびロックに関する情報が含まれているテーブルを提供しています。
        </p><p>
          <code class="literal">INFORMATION_SCHEMA</code> プラグインについては、<a class="xref" href="extending-mysql.html#writing-information-schema-plugins" title="24.2.4.6 INFORMATION_SCHEMA プラグインの作成">セクション24.2.4.6「INFORMATION_SCHEMA プラグインの作成」</a>を参照してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="semisynchronous-replication-plugins"></a>24.2.3.5 準同期レプリケーションプラグイン</h4></div></div></div><a class="indexterm" name="idm139978998318128"></a><a class="indexterm" name="idm139978998316592"></a><p>
          MySQL レプリケーションはデフォルトでは非同期です。準同期レプリケーションでは、マスター側で実行されたコミットは、トランザクションを実行したセッションに戻る前に、少なくとも 1 つのスレーブがトランザクションのイベントを受け取ってログに記録したことを通知するまでブロックされます。準同期レプリケーションは、補完的なマスタープラグインおよびクライアントプラグインを介して実装されます。<a class="xref" href="replication.html#replication-semisync" title="17.3.8 準同期レプリケーション">セクション17.3.8「準同期レプリケーション」</a>を参照してください。
        </p><p>
          準同期レプリケーションについては、<a class="xref" href="extending-mysql.html#writing-semisynchronous-replication-plugins" title="24.2.4.7 準同期レプリケーションプラグインの作成">セクション24.2.4.7「準同期レプリケーションプラグインの作成」</a>を参照してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="audit-plugins"></a>24.2.3.6 監査プラグイン</h4></div></div></div><a class="indexterm" name="idm139978998310208"></a><a class="indexterm" name="idm139978998308736"></a><p>
          MySQL 5.6 では、サーバー操作に関する情報を関係者に報告できるプラガブルな監査インタフェースがサーバーによって提供されます。現時点では、次の操作について監査通知が行われます (インタフェースは汎用的なものですが、サーバーを変更してほかの情報を報告できます)。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              一般クエリーログへのメッセージの書き込み (ログが有効にされている場合)
            </p></li><li class="listitem"><p>
              エラーログへのメッセージの書き込み
            </p></li><li class="listitem"><p>
              クライアントへのクエリー結果の送信
            </p></li></ul></div><p>
          監査プラグインは、サーバー操作についての通知を受け取るために監査インタフェースに登録できます。監査可能なイベントがサーバー内で発生すると、サーバーは通知が必要であるかどうかを判別します。登録されている各監査プラグインについて、サーバーはプラグインが対象としているイベントクラスに対してイベントを照合し、一致する場合はイベントをプラグインに渡します。
        </p><p>
          このインタフェースでは、監査プラグインが重要だとみなすイベントクラスの操作の通知のみを監査プラグインが受け取り、ほかのものを無視できます。このインタフェースは、操作をイベントクラスまで分類し、さらに各クラス内のイベントサブクラスまで分割します。
        </p><p>
          監査プラグインに監査可能なイベントが通知されると、監査プラグインは現在の THD 構造体へのポインタ、およびイベントについての情報を含む構造へのポインタを受け取ります。プラグインはイベントを検査し、適切な監査アクションを実行します。たとえば、プラグインは、結果セットを生成したステートメント、ログに記録されたステートメント、結果の行数、操作についての現在のユーザー、または失敗した操作のエラーコードを確認できます。
        </p><p>
          監査プラグインについては、<a class="xref" href="extending-mysql.html#writing-audit-plugins" title="24.2.4.8 監査プラグインの作成">セクション24.2.4.8「監査プラグインの作成」</a>を参照してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authentication-plugins"></a>24.2.3.7 認証プラグイン</h4></div></div></div><a class="indexterm" name="idm139978998296256"></a><a class="indexterm" name="idm139978998294784"></a><p>
          MySQL 5.6 はプラガブルな認証をサポートしています。認証プラグインはサーバー側とクライアント側の両方に存在します。サーバー側のプラグインは、クライアントがサーバーに接続するときにクライアントによって使用される認証方式を実装します。クライアント側のプラグインはサーバー側のプラグインと通信して、サーバー側のプラグインが必要とする認証情報を提供します。クライアント側のプラグインは、ユーザーと対話し、サーバーに送信するパスワードやその他の認証情報の要求などのタスクを実行することもあります。<a class="xref" href="security.html#pluggable-authentication" title="6.3.7 プラガブル認証">セクション6.3.7「プラガブル認証」</a>を参照してください。
        </p><p>
          プラガブルな認証では、あるユーザーが別のユーザーの ID を取得するプロキシユーザー機能も使用できます。サーバー側の認証プラグインは、接続するユーザーが使用するべき ID の所有者であるユーザーの名前をサーバーに返すことができます。<a class="xref" href="security.html#proxy-users" title="6.3.9 プロキシユーザー">セクション6.3.9「プロキシユーザー」</a>を参照してください。
        </p><p>
          認証プラグインについては、<a class="xref" href="extending-mysql.html#writing-authentication-plugins" title="24.2.4.9 認証プラグインの作成">セクション24.2.4.9「認証プラグインの作成」</a>を参照してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="password-validation-plugins"></a>24.2.3.8 パスワード検証プラグイン</h4></div></div></div><p>
          MySQL 5.6.6 以降では、サーバーはパスワードをテストするプラグインを記述するためのインタフェースを提供しています。そのようなプラグインは、2 つの機能を実装します。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              パスワードを割り当てるステートメント (<code class="literal">CREATE USER</code>、<code class="literal">GRANT</code>、<code class="literal">SET PASSWORD</code> ステートメントなど) の非常に弱いパスワード、および <code class="literal">PASSWORD()</code> 関数および <code class="literal">OLD_PASSWORD()</code> 関数に引数として指定されたパスワードの拒否。
            </p></li><li class="listitem"><p>
              <code class="literal">VALIDATE_PASSWORD_STRENGTH()</code> SQL 関数でのパスワード候補の強さの評価。
            </p></li></ul></div><p>
          このタイプのプラグインを作成については、<a class="xref" href="extending-mysql.html#writing-password-validation-plugins" title="24.2.4.10 パスワード検証プラグインの作成">セクション24.2.4.10「パスワード検証プラグインの作成」</a>を参照してください。
        </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="writing-plugins"></a>24.2.4 プラグインの作成</h3></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#writing-plugins-overview">24.2.4.1 プラグインの作成の概要</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-data-structures">24.2.4.2 プラグインのデータ構造体</a></span></dt><dt><span class="section"><a href="extending-mysql.html#compiling-plugin-libraries">24.2.4.3 プラグインライブラリのコンパイルおよびインストール</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-full-text-plugins">24.2.4.4 全文パーサープラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-daemon-plugins">24.2.4.5 デーモンプラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-information-schema-plugins">24.2.4.6 INFORMATION_SCHEMA プラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-semisynchronous-replication-plugins">24.2.4.7 準同期レプリケーションプラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-audit-plugins">24.2.4.8 監査プラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-authentication-plugins">24.2.4.9 認証プラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-password-validation-plugins">24.2.4.10 パスワード検証プラグインの作成</a></span></dt></dl></div><p>
        プラグインライブラリを作成するには、ライブラリファイルに含まれるプラグインを示す必要なディスクリプタ情報を提供し、各プラグインのインタフェース関数を記述する必要があります。
      </p><p>
        すべてのサーバープラグインには、プラグイン API に情報を提供する一般ディスクリプタ、および特定のタイプのプラグインにプラグインインタフェースについての情報を提供するタイプ固有のディスクリプタがある必要があります。一般ディスクリプタの構造体は、すべてのプラグインタイプで同じです。タイプ固有のディスクリプタの構造体はプラグインタイプによって異なり、プラグインが実行する必要がある動作の要件によって決定されます。サーバープラグインインタフェースを使用すると、プラグインはステータス変数およびシステム変数を公開することもできます。これらの変数は、<code class="literal">SHOW STATUS</code> ステートメントや <code class="literal">SHOW VARIABLES</code> ステートメント、および対応する <code class="literal">INFORMATION_SCHEMA</code> テーブルを介して表示できます。
      </p><p>
        クライアント側のプラグインの場合、アーキテクチャーは少し異なります。各プラグインにはディスクリプタがある必要がありますが、一般ディスクリプタとタイプ固有のディスクリプタに分割されていません。そうではなく、ディスクリプタはすべてのクライアントプラグインに共通する固定された一連のメンバーで始まり、この共通メンバーのあとに、特定のプラグインタイプを実装するために必要な追加のメンバーが続きます。
      </p><p>
        プラグインは、C または C++ (あるいは C の呼び出し規則を使用できる別の言語) で記述できます。プラグインは動的にロードおよびアンロードされるため、オペレーティングシステムが動的ロードをサポートしている必要があり、呼び出し元アプリケーションを (静的にではなく) 動的にコンパイルしている必要があります。サーバープラグインの場合、これは <span class="command"><strong>mysqld</strong></span> を動的にコンパイルする必要があることを意味します。
      </p><p>
        サーバープラグインには実行中のサーバーの一部となるコードが含まれるため、プラグインを記述するときは、サーバーコードを作成する場合に該当するすべての制約に従う必要があります。たとえば、<code class="literal">libstdc++</code> ライブラリの関数を使用しようとすると、問題が生じることがあります。これらの制約はサーバーの今後のバージョンで変更される場合があるため、サーバーのアップグレードにより、古いサーバー用に作成されたプラグインの改訂が必要になることがあります。これらの制約については、<a class="xref" href="installing.html#source-configuration-options" title="2.9.4 MySQL ソース構成オプション">セクション2.9.4「MySQL ソース構成オプション」</a>および<a class="xref" href="installing.html#compilation-problems" title="2.9.5 MySQL のコンパイルに関する問題">セクション2.9.5「MySQL のコンパイルに関する問題」</a>を参照してください。
      </p><p>
        どのようなアプリケーションがプラグインを使用するかはわからないため、クライアントプラグインの作成者は、呼び出し元アプリケーションが持つシンボルに依存しないようにしてください。
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-plugins-overview"></a>24.2.4.1 プラグインの作成の概要</h4></div></div></div><p>
          次の手順では、プラグインライブラリの作成に必要なステップの概要を示します。以降のセクションでは、プラグインのデータ構造体の設定、および特定のタイプのプラグインの作成について詳しく説明します。
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
              プラグインのソースファイルに、プラグインライブラリが必要とするヘッダーファイルをインクルードします。<code class="filename">plugin.h</code> ファイルは必須であり、ライブラリではほかのファイルも必要になることがあります。例:
            </p><pre class="programlisting">
#include &lt;stdlib.h&gt;
#include &lt;ctype.h&gt;
#include &lt;mysql/plugin.h&gt;
</pre></li><li class="listitem"><p>
              プラグインライブラリファイル用のディスクリプタ情報をセットアップします。サーバープラグインの場合は、ライブラリディスクリプタを記述します。ライブラリディスクリプタには、ファイル内の各サーバープラグインの一般プラグインディスクリプタが含まれている必要があります。詳細は、<a class="xref" href="extending-mysql.html#server-plugin-descriptors" title="24.2.4.2.1 サーバープラグインライブラリおよびプラグインディスクリプタ">セクション24.2.4.2.1「サーバープラグインライブラリおよびプラグインディスクリプタ」</a>を参照してください。また、ライブラリ内の各サーバープラグインのタイプ固有のディスクリプタをセットアップします。各プラグインの一般ディスクリプタは、タイプ固有のディスクリプタを指しています。
            </p><p>
              クライアントプラグインの場合は、クライアントディスクリプタを記述します。詳細は、<a class="xref" href="extending-mysql.html#client-plugin-descriptors" title="24.2.4.2.3 クライアントプラグインディスクリプタ">セクション24.2.4.2.3「クライアントプラグインディスクリプタ」</a>を参照してください。
            </p></li><li class="listitem"><p>
              各プラグインのプラグインインタフェース関数を作成します。たとえば、各プラグインの一般プラグインディスクリプタは、サーバーがプラグインをロードおよびアンロードするときに呼び出す初期化関数および初期化解除関数を指しています。プラグインのタイプ固有のディスクリプタは、インタフェース関数を指していることもあります。
            </p></li><li class="listitem"><p>
              サーバープラグインの場合は、ステータス変数およびシステム変数を設定します (ある場合)。
            </p></li><li class="listitem"><p>
              プラグインライブラリを共有ライブラリとしてコンパイルし、プラグインディレクトリにインストールします。詳細は、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>を参照してください。
            </p></li><li class="listitem"><p>
              サーバープラグインの場合は、プラグインをサーバーに登録します。詳細は、<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>を参照してください。
            </p></li><li class="listitem"><p>
              プラグインをテストして、正しく動作することを確認します。
            </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="plugin-data-structures"></a>24.2.4.2 プラグインのデータ構造体</h4></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#server-plugin-descriptors">24.2.4.2.1 サーバープラグインライブラリおよびプラグインディスクリプタ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#plugin-status-system-variables">24.2.4.2.2 サーバープラグインのステータス変数およびシステム変数</a></span></dt><dt><span class="section"><a href="extending-mysql.html#client-plugin-descriptors">24.2.4.2.3 クライアントプラグインディスクリプタ</a></span></dt></dl></div><p>
          プラグインライブラリファイルには、それに格納されているプラグインを示すディスクリプタ情報が含まれています。
        </p><p>
          プラグインライブラリにサーバープラグインが含まれている場合、プラグインライブラリには次のディスクリプタ情報が含まれている必要があります。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              ライブラリディスクリプタは、ライブラリによって使用される一般的なサーバープラグイン API バージョン番号を示し、ライブラリ内の各サーバープラグインの一般プラグインディスクリプタを含んでいます。このディスクリプタのフレームワークを提供するには、<code class="filename">plugin.h</code> ヘッダーファイルから 2 つのマクロを呼び出します。
            </p><pre class="programlisting">
mysql_declare_plugin(<em class="replaceable"><code>name</code></em>)
 <em class="replaceable"><code>... one or more server plugin descriptors here ...</code></em>
mysql_declare_plugin_end;
</pre><p>
              マクロが展開され、API バージョンの宣言が自動的に提供されます。プラグインディスクリプタを指定する必要があります。
            </p></li><li class="listitem"><p>
              ライブラリディスクリプタ内の各一般的なサーバープラグインは、<code class="literal">st_mysql_plugin</code> 構造体によって記述されます。このプラグインのディスクリプタ構造体には、すべてのタイプのサーバープラグインに共通する情報 (プラグインタイプを示す値、プラグイン名、作成者、説明、ライセンスタイプ、サーバーがプラグインをロードおよびアンロードするときに呼び出す初期化関数と初期化解除関数へのポインタ、およびプラグインが実装するステータス変数またはシステム変数へのポインタ) が含まれています。
            </p></li><li class="listitem"><p>
              ライブラリディスクリプタ内の各一般的なサーバープラグインディスクリプタには、タイプ固有のプラグインディスクリプタへのポインタも含まれています。プラグインはタイプごとに独自の API を持つことがあるため、タイプ固有のディスクリプタの構造体はプラグインタイプによって異なります。タイプ固有のプラグインディスクリプタには、タイプ固有の API バージョン番号およびそのプラグインタイプを実装するために必要な関数へのポインタが含まれています。たとえば、全文パーサープラグインには、初期化関数と初期化解除関数、およびメインの構文解析関数があります。サーバーはプラグインを使用してテキストを構文解析するときに、これらの関数を呼び出します。
            </p></li></ul></div><p>
          プラグインライブラリには、ライブラリ内の各プラグインの一般ディスクリプタおよびタイプ固有のディスクリプタによって参照されるインタフェース関数も格納されています。
        </p><p>
          プラグインライブラリにクライアントプラグインが格納されている場合は、そのプラグインのディスクリプタが含まれている必要があります。そのディスクリプタはすべてのクライアントプラグインに共通する固定された一連のメンバーで始まり、そのあとにプラグインタイプ固有のメンバーが続きます。ディスクリプタフレームワークを提供するには、<code class="filename">client_plugin.h</code> ヘッダーファイルから 2 つのマクロを呼び出します。
        </p><pre class="programlisting">
mysql_declare_client_plugin(<em class="replaceable"><code>plugin_type</code></em>)
   ... <em class="replaceable"><code>members common to all client plugins</code></em> ...
   ... <em class="replaceable"><code>type-specific extra members</code></em> ...
mysql_end_client_plugin;
</pre><p>
          プラグインライブラリには、クライアントディスクリプタによって参照されるインタフェース関数も格納されています。
        </p><p>
          <code class="literal">mysql_declare_plugin()</code> マクロおよび <code class="literal">mysql_declare_client_plugin()</code> マクロは呼び出す方法が若干異なり、これはプラグインライブラリの内容が関係しています。次のガイドラインはこのルールを要約しています。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">mysql_declare_plugin()</code> および <code class="literal">mysql_declare_client_plugin()</code> は同じソースファイル内で使用できます。これは、1 つのプラグインライブラリにサーバープラグインとクライアントプラグインを両方格納できることを意味します。ただし、<code class="literal">mysql_declare_plugin()</code> と <code class="literal">mysql_declare_client_plugin()</code> はそれぞれ 1 回しか使用できません。
            </p></li><li class="listitem"><p>
              <code class="literal">mysql_declare_plugin()</code> は複数のサーバープラグイン宣言が可能であるため、1 つのプラグインライブラリに複数のサーバープラグインを格納できます。
            </p></li><li class="listitem"><p>
              <code class="literal">mysql_declare_client_plugin()</code> は、単一のクライアントプラグイン宣言のみを行うことができます。複数のクライアントプラグインを作成するには、別々のプラグインライブラリを使用する必要があります。
            </p></li></ul></div><p>
          プラグインライブラリに存在して <code class="literal">libmysqlclient</code> に組み込まれていないクライアントプラグインをクライアントプログラムが探す場合、クライアントプログラムはプラグイン名と同じベース名を持つファイルを探します。たとえば、ライブラリのサフィクスとして <code class="filename">.so</code> を使用するシステムで、<code class="literal">auth_xxx</code> という名前のクライアント認証プラグインをプログラムで使用する必要がある場合、プログラムは <code class="filename">auth_xxx.so</code> という名前のファイルを探します。(OS X では、プログラムはまず <code class="filename">auth_xxx.dylib</code> を探し、次に <code class="filename">auth_xxx.so</code> を探します。)このため、プラグインライブラリにクライアントプラグインが格納されている場合、ライブラリはそのプラグインと同じベース名である必要があります。
        </p><p>
          サーバープラグインを格納しているライブラリの場合は異なります。<code class="option">--plugin-load</code> オプションおよび <code class="literal">INSTALL PLUGIN</code> ステートメントはライブラリファイル名を明示的に指定するため、ライブラリ名とライブラリに格納されているサーバープラグインの名前に明示的な関係がある必要はありません。
        </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="server-plugin-descriptors"></a>24.2.4.2.1 サーバープラグインライブラリおよびプラグインディスクリプタ</h5></div></div></div><p>
            サーバープラグインを格納するすべてのプラグインライブラリには、ファイル内の各サーバープラグインの一般プラグインディスクリプタが含まれているライブラリディスクリプタが格納されている必要があります。このセクションでは、サーバープラグイン用のライブラリおよび一般ディスクリプタを記述する方法について説明します。
          </p><p>
            ライブラリディスクリプタは 2 つのシンボルを定義する必要があります。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">_mysql_plugin_interface_version_</code> は全般的なプラグインフレームワークのバージョン番号を指定します。これは <code class="literal">MYSQL_PLUGIN_INTERFACE_VERSION</code> シンボルを使用して指定し、このシンボルは <code class="filename">plugin.h</code> ファイルに定義します。
              </p></li><li class="listitem"><p>
                <code class="literal">_mysql_plugin_declarations_</code> は、プラグイン宣言の配列を定義し、すべてのメンバーが 0 に設定された宣言で終わります。各宣言は、<code class="literal">st_mysql_plugin</code> 構造体のインスタンスです (<code class="filename">plugin.h</code> 内でも定義されます)。ライブラリ内のサーバープラグインごとに、これらのいずれかが必要となります。
              </p></li></ul></div><p>
            サーバーがライブラリ内でこれらの 2 つのシンボルを見つけることができない場合、サーバーはこれを正当なプラグインライブラリとして受け入れず、拒否してエラーを発生させます。これにより、ライブラリをプラグインライブラリとして特別にビルドしないかぎり、プラグイン用にライブラリを使用できなくなります。
          </p><p>
            必須の 2 つのシンボルを定義する通常の方法は、<code class="filename">plugin.h</code> ファイルから <code class="literal">mysql_declare_plugin()</code> マクロおよび <code class="literal">mysql_declare_plugin_end</code> マクロを使用することです。
          </p><pre class="programlisting">
mysql_declare_plugin(<em class="replaceable"><code>name</code></em>)
 <em class="replaceable"><code>... one or more server plugin descriptors here ...</code></em>
mysql_declare_plugin_end;
</pre><p>
            各サーバープラグインには、サーバープラグイン API に情報を提供する一般ディスクリプタが必要となります。一般ディスクリプタの構造体はすべてのプラグインタイプで同じです。<code class="filename">plugin.h</code> ファイル内の <code class="literal">st_mysql_plugin</code> 構造体によって、このディスクリプタが定義されます。
          </p><pre class="programlisting">
struct st_mysql_plugin
{
  int type;             /* the plugin type (a MYSQL_XXX_PLUGIN value)   */
  void *info;           /* pointer to type-specific plugin descriptor   */
  const char *name;     /* plugin name                                  */
  const char *author;   /* plugin author (for I_S.PLUGINS)              */
  const char *descr;    /* general descriptive text (for I_S.PLUGINS)   */
  int license;          /* the plugin license (PLUGIN_LICENSE_XXX)      */
  int (*init)(void *);  /* the function to invoke when plugin is loaded */
  int (*deinit)(void *);/* the function to invoke when plugin is unloaded */
  unsigned int version; /* plugin version (for I_S.PLUGINS)             */
  struct st_mysql_show_var *status_vars;
  struct st_mysql_sys_var **system_vars;
  void * __reserved1;   /* reserved for dependency checking             */
  unsigned long flags;  /* flags for plugin */
};
</pre><p>
            <code class="literal">st_mysql_plugin</code> ディスクリプタ構造体のメンバーは次のように使用します。<code class="literal">char *</code> メンバーは、NULL で終わる文字列として指定してください。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">type</code>: プラグインの型。これは <code class="filename">plugin.h</code> のプラグインタイプ値のいずれかである必要があります。
              </p><pre class="programlisting">
/*
  The allowable types of plugins
*/
#define MYSQL_UDF_PLUGIN             0  /* User-defined function        */
#define MYSQL_STORAGE_ENGINE_PLUGIN  1  /* Storage Engine               */
#define MYSQL_FTPARSER_PLUGIN        2  /* Full-text parser plugin      */
#define MYSQL_DAEMON_PLUGIN          3  /* The daemon/raw plugin type */
#define MYSQL_INFORMATION_SCHEMA_PLUGIN  4  /* The I_S plugin type */
#define MYSQL_AUDIT_PLUGIN           5  /* The Audit plugin type        */
#define MYSQL_REPLICATION_PLUGIN     6  /* The replication plugin type */
#define MYSQL_AUTHENTICATION_PLUGIN  7  /* The authentication plugin type */
...
</pre><p>
                たとえば、全文パーサープラグインの場合、<code class="literal">type</code> 値は <code class="literal">MYSQL_FTPARSER_PLUGIN</code> です。
              </p></li><li class="listitem"><p>
                <code class="literal">info</code>: プラグインのタイプ固有のディスクリプタへのポインタ。このディスクリプタの構造体は、一般プラグインディスクリプタ構造体とは異なり、プラグインの特定のタイプによって異なります。バージョンを制御するために、すべてのプラグインタイプのタイプ固有のディスクリプタの最初のメンバーは、タイプのインタフェースバージョンであることが予期されています。これにより、サーバーはタイプに関係なくすべてのプラグインのタイプ固有のバージョンをチェックできます。ディスクリプタには、バージョン番号のあとに、必要なほかのメンバー (サーバーがプラグインを適切に呼び出すために必要となるコールバック関数やその他の情報など) が含まれています。特定タイプのサーバープラグインの記述に関する以降のセクションでは、それらのタイプ固有のディスクリプタの構造体について説明しています。
              </p></li><li class="listitem"><p>
                <code class="literal">name</code>: プラグイン名を指定する文字列。これは <code class="literal">mysql.plugin</code> テーブルに表示される名前であり、この名前を使用して、SQL ステートメント (<code class="literal">INSTALL PLUGIN</code>、<code class="literal">UNINSTALL PLUGIN</code> など) でプラグインを参照したり、<code class="option">--plugin-load</code> オプションで指定してプラグインを参照したりします。この名前は、<code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルおよび <code class="literal">SHOW PLUGINS</code> の出力にも表示されます。
              </p><p>
                プラグイン名は、サーバーオプション名で始まらないようにしてください。そのようにした場合、サーバーはプラグインの初期化に失敗します。たとえば、サーバーには <code class="option">--socket</code> オプションがあるため、<code class="literal">socket</code>、<code class="literal">socket_plugin</code> などのプラグイン名を使用しないでください。
              </p></li><li class="listitem"><p>
                <code class="literal">author</code>: プラグイン作成者を示す文字列。これには任意の文字列を指定できます。
              </p></li><li class="listitem"><p>
                <code class="literal">desc</code>: プラグインの概要を説明する文字列。これには任意の文字列を指定できます。
              </p></li><li class="listitem"><p>
                <code class="literal">license</code>: プラグインのライセンスタイプ。値には <code class="literal">PLUGIN_LICENSE_PROPRIETARY</code>、<code class="literal">PLUGIN_LICENSE_GPL</code>、または <code class="literal">PLUGIN_LICENSE_BSD</code> のいずれかを指定できます。
              </p></li><li class="listitem"><p>
                <code class="literal">init</code>: 1 回だけ実行される初期化関数であり、そのような関数がない場合は <code class="literal">NULL</code> です。サーバーはプラグインをロードするときにこの関数を実行し、これは <code class="literal">INSTALL PLUGIN</code> で実行されるか、<code class="literal">mysql.plugin</code> テーブルにリストされているプラグインの場合はサーバー起動時に実行されます。この関数は、プラグインを識別するために使用される内部構造体を指している 1 つの引数を受け取ります。成功した場合はゼロ、および失敗した場合はゼロ以外を返します。
              </p></li><li class="listitem"><p>
                <code class="literal">deinit</code>: 1 回だけ実行される初期化解除関数であり、そのような関数がない場合は <code class="literal">NULL</code> です。サーバーはプラグインをアンロードするときにこの関数を実行し、これは <code class="literal">UNINSTALL PLUGIN</code> で実行されるか、<code class="literal">mysql.plugin</code> テーブルにリストされているプラグインの場合はサーバーのシャットダウン時に実行されます。この関数は、プラグインを識別するために使用される内部構造体を指している 1 つの引数を受け取ります。成功した場合はゼロ、および失敗した場合はゼロ以外を返します。
              </p></li><li class="listitem"><p>
                <code class="literal">version</code>: プラグインのバージョン番号。プラグインがインストールされている場合は、この値を <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルから取得できます。この値にはメジャー番号とマイナー番号が含まれています。16 進数の定数として値を記述する場合、形式は <code class="literal">0x<em class="replaceable"><code>MMNN</code></em></code> であり、ここで <em class="replaceable"><code>MM</code></em> および <code class="literal">NN</code> はそれぞれメジャー番号とマイナー番号です。たとえば、<code class="literal">0x0302</code> はバージョン 3.2 を表します。
              </p></li><li class="listitem"><p>
                <code class="literal">status_vars</code>: プラグインに関連付けられているステータス変数の構造体へのポインタであり、そのような変数がない場合は <code class="literal">NULL</code> です。プラグインをインストールすると、これらの変数は <code class="literal">SHOW STATUS</code> ステートメントの出力として表示されます。
              </p><p>
                <code class="literal">status_vars</code> のメンバーは、<code class="literal">NULL</code> ではない場合、ステータス変数を記述する <code class="literal">st_mysql_show_var</code> 構造体の配列を指しています。<a class="xref" href="extending-mysql.html#plugin-status-system-variables" title="24.2.4.2.2 サーバープラグインのステータス変数およびシステム変数">セクション24.2.4.2.2「サーバープラグインのステータス変数およびシステム変数」</a>を参照してください。
              </p></li><li class="listitem"><p>
                <code class="literal">system_vars</code>: プラグインに関連付けられているシステム変数の構造体へのポインタであり、そのような変数がない場合は <code class="literal">NULL</code> です。これらのオプションおよびシステム変数は、プラグイン内の変数を初期化するために使用できます。
              </p><p>
                <code class="literal">system_vars</code> のメンバーは、<code class="literal">NULL</code> ではない場合、システム変数を記述する <code class="literal">st_mysql_sys_var</code> 構造体の配列を指しています。<a class="xref" href="extending-mysql.html#plugin-status-system-variables" title="24.2.4.2.2 サーバープラグインのステータス変数およびシステム変数">セクション24.2.4.2.2「サーバープラグインのステータス変数およびシステム変数」</a>を参照してください。
              </p></li><li class="listitem"><p>
                <code class="literal">__reserved1</code>: 今後利用するためのプレースホルダ。現時点では <code class="literal">NULL</code> を設定してください。
              </p></li><li class="listitem"><p>
                <code class="literal">flags</code>: プラグインフラグ。個々のビットは各種のフラグに対応しています。この値には、該当するフラグの論理和を設定してください。次のフラグを使用できます。
              </p><pre class="programlisting">
#define PLUGIN_OPT_NO_INSTALL   1UL   /* Not dynamically loadable */
#define PLUGIN_OPT_NO_UNINSTALL 2UL   /* Not dynamically unloadable */
</pre><p>
                <code class="literal">PLUGIN_OPT_NO_INSTALL</code> は、<code class="literal">INSTALL PLUGIN</code> ステートメントを使用してプラグインを実行時にロードできないことを示します。これは、<code class="option">--plugin-load</code> オプションを使用してサーバー起動時にロードする必要があるプラグインの場合に適しています。<code class="literal">PLUGIN_OPT_NO_UNINSTALL</code> は、<code class="literal">UNINSTALL PLUGIN</code> ステートメントを使用してプラグインを実行時にアンロードできないことを示します。
              </p><p>
                このメンバーは MySQL 5.6.3 で追加されました。
              </p></li></ul></div><p>
            サーバーは、プラグインをロードおよびアンロードする場合にのみ、一般プラグインディスクリプタ内の <code class="literal">init</code> 関数および <code class="literal">deinit</code> 関数を呼び出します。これらは、SQL ステートメントによってプラグインが起動された場合などのプラグインの使用時には関係がありません。
          </p><p>
            たとえば、<code class="literal">simple_parser</code> という名前の単一の全文パーサープラグインを含むライブラリのディスクリプタ情報は、次のようになります。
          </p><pre class="programlisting">
mysql_declare_plugin(ftexample)
{
  MYSQL_FTPARSER_PLUGIN,      /* type                            */
  &amp;simple_parser_descriptor,  /* descriptor                      */
  "simple_parser",            /* name                            */
  "Oracle Corporation",       /* author                          */
  "Simple Full-Text Parser",  /* description                     */
  PLUGIN_LICENSE_GPL,         /* plugin license                  */
  simple_parser_plugin_init,  /* init function (when loaded)     */
  simple_parser_plugin_deinit,/* deinit function (when unloaded) */
  0x0001,                     /* version                         */
  simple_status,              /* status variables                */
  simple_system_variables,    /* system variables                */
  NULL,
  0
}
mysql_declare_plugin_end;
</pre><p>
            全文パーサープラグインの場合、タイプは <code class="literal">MYSQL_FTPARSER_PLUGIN</code> である必要があります。これは、<code class="literal">FULLTEXT</code> インデックスの作成時に <code class="literal">WITH PARSER</code> 句で使用する場合に、プラグインが正当なものであることを識別する値です。(ほかのプラグインタイプは、この句に対して正当ではありません。)
          </p><p>
            <code class="filename">plugin.h</code> では、<code class="literal">mysql_declare_plugin()</code> マクロおよび <code class="literal">mysql_declare_plugin_end</code> マクロを次のように定義します。
          </p><pre class="programlisting">
#ifndef MYSQL_DYNAMIC_PLUGIN
#define __MYSQL_DECLARE_PLUGIN(NAME, VERSION, PSIZE, DECLS) \
MYSQL_PLUGIN_EXPORT int VERSION= MYSQL_PLUGIN_INTERFACE_VERSION; \
MYSQL_PLUGIN_EXPORT int PSIZE= sizeof(struct st_mysql_plugin); \
MYSQL_PLUGIN_EXPORT struct st_mysql_plugin DECLS[]= {
#else
#define __MYSQL_DECLARE_PLUGIN(NAME, VERSION, PSIZE, DECLS) \
MYSQL_PLUGIN_EXPORT int _mysql_plugin_interface_version_= MYSQL_PLUGIN_INTERFACE_VERSION; \
MYSQL_PLUGIN_EXPORT int _mysql_sizeof_struct_st_plugin_= sizeof(struct st_mysql_plugin); \
MYSQL_PLUGIN_EXPORT struct st_mysql_plugin _mysql_plugin_declarations_[]= {
#endif

#define mysql_declare_plugin(NAME) \
__MYSQL_DECLARE_PLUGIN(NAME, \
                 builtin_ ## NAME ## _plugin_interface_version, \
                 builtin_ ## NAME ## _sizeof_struct_st_plugin, \
                 builtin_ ## NAME ## _plugin)

#define mysql_declare_plugin_end ,{0,0,0,0,0,0,0,0,0,0,0,0,0}}
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">注記</div><p>
              これらの宣言では、<code class="literal">MYSQL_DYNAMIC_PLUGIN</code> シンボルを定義した場合にのみ、<code class="literal">_mysql_plugin_interface_version_</code> シンボルを定義します。これは、プラグインを共有ライブラリとしてビルドするためのコンパイルコマンドの一部として <code class="literal">-DMYSQL_DYNAMIC_PLUGIN</code> を指定する必要があることを意味します。
            </p></div><p>
            上記のようにマクロが使用された場合は、次のコードが展開され、必要なシンボル (<code class="literal">_mysql_plugin_interface_version_</code> および <code class="literal">_mysql_plugin_declarations_</code>) が定義されます。
          </p><pre class="programlisting">
int _mysql_plugin_interface_version_= MYSQL_PLUGIN_INTERFACE_VERSION;
int _mysql_sizeof_struct_st_plugin_= sizeof(struct st_mysql_plugin);
struct st_mysql_plugin _mysql_plugin_declarations_[]= {
{
  MYSQL_FTPARSER_PLUGIN,      /* type                            */
  &amp;simple_parser_descriptor,  /* descriptor                      */
  "simple_parser",            /* name                            */
  "Oracle Corporation",       /* author                          */
  "Simple Full-Text Parser",  /* description                     */
  PLUGIN_LICENSE_GPL,         /* plugin license                  */
  simple_parser_plugin_init,  /* init function (when loaded)     */
  simple_parser_plugin_deinit,/* deinit function (when unloaded) */
  0x0001,                     /* version                         */
  simple_status,              /* status variables                */
  simple_system_variables,    /* system variables                */
  NULL,
  0
}
  ,{0,0,0,0,0,0,0,0,0,0,0,0}}
};
</pre><p>
            前の例では一般ディスクリプタ内に単一のプラグインを宣言しましたが、複数のプラグインを宣言することもできます。<code class="literal">mysql_declare_plugin()</code> と <code class="literal">mysql_declare_plugin_end</code> の間に宣言をカンマで区切って順番にリストします。
          </p><p>
            MySQL サーバープラグインは、C または C++ (あるいは C の呼び出し規則を使用できる別の言語) で記述できます。C++ プラグインを記述する場合に使用するべきではない C++ 機能は、グローバル構造体を初期化するための非定数変数です。<code class="literal">st_mysql_plugin</code> 構造などの構造体のメンバーは、定数変数でのみ初期化してください。前に示した <code class="literal">simple_parser</code> ディスクリプタはこの要件を満たすため、C++ プラグインで許容されます。
          </p><pre class="programlisting">
mysql_declare_plugin(ftexample)
{
  MYSQL_FTPARSER_PLUGIN,      /* type                            */
  &amp;simple_parser_descriptor,  /* descriptor                      */
  "simple_parser",            /* name                            */
  "Oracle Corporation",       /* author                          */
  "Simple Full-Text Parser",  /* description                     */
  PLUGIN_LICENSE_GPL,         /* plugin license                  */
  simple_parser_plugin_init,  /* init function (when loaded)     */
  simple_parser_plugin_deinit,/* deinit function (when unloaded) */
  0x0001,                     /* version                         */
  simple_status,              /* status variables                */
  simple_system_variables,    /* system variables                */
  NULL,
  0
}
mysql_declare_plugin_end;
</pre><p>
            一般ディスクリプタを記述するための別の有効な方法を次に示します。ここでは、プラグイン名、作成者、および説明を指定するために定数変数が使用されています。
          </p><pre class="programlisting">
const char *simple_parser_name = "simple_parser";
const char *simple_parser_author = "Oracle Corporation";
const char *simple_parser_description = "Simple Full-Text Parser";

mysql_declare_plugin(ftexample)
{
  MYSQL_FTPARSER_PLUGIN,      /* type                            */
  &amp;simple_parser_descriptor,  /* descriptor                      */
  simple_parser_name,         /* name                            */
  simple_parser_author,       /* author                          */
  simple_parser_description,  /* description                     */
  PLUGIN_LICENSE_GPL,         /* plugin license                  */
  simple_parser_plugin_init,  /* init function (when loaded)     */
  simple_parser_plugin_deinit,/* deinit function (when unloaded) */
  0x0001,                     /* version                         */
  simple_status,              /* status variables                */
  simple_system_variables,    /* system variables                */
  NULL,
  0
}
mysql_declare_plugin_end;
</pre><p>
            ただし、次の一般ディスクリプタは無効です。ここではプラグイン名、作成者、および説明を指定するために構造体メンバーが使用されていますが、C++ では構造は定数イニシャライザと見なされません。
          </p><pre class="programlisting">
typedef struct
{
  const char *name;
  const char *author;
  const char *description;
} plugin_info;

plugin_info parser_info = {
  "simple_parser",
  "Oracle Corporation",
  "Simple Full-Text Parser"
};

mysql_declare_plugin(ftexample)
{
  MYSQL_FTPARSER_PLUGIN,      /* type                            */
  &amp;simple_parser_descriptor,  /* descriptor                      */
  parser_info.name,           /* name                            */
  parser_info.author,         /* author                          */
  parser_info.description,    /* description                     */
  PLUGIN_LICENSE_GPL,         /* plugin license                  */
  simple_parser_plugin_init,  /* init function (when loaded)     */
  simple_parser_plugin_deinit,/* deinit function (when unloaded) */
  0x0001,                     /* version                         */
  simple_status,              /* status variables                */
  simple_system_variables,    /* system variables                */
  NULL,
  0
}
mysql_declare_plugin_end;
</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="plugin-status-system-variables"></a>24.2.4.2.2 サーバープラグインのステータス変数およびシステム変数</h5></div></div></div><p>
            サーバープラグインインタフェースを使用すると、プラグインが一般プラグインディスクリプタの <code class="literal">status_vars</code> メンバーおよび <code class="literal">system_vars</code> メンバーを使用して、ステータス変数およびシステム変数を公開できます。
          </p><p>
            一般プラグインディスクリプタの <code class="literal">status_vars</code> メンバーは、0 でない場合、<code class="literal">st_mysql_show_var</code> 構造体の配列を指しており、各構造には 1 つのステータス変数が記述されていて、すべてのメンバーが 0 に設定された構造があとに続きます。<code class="literal">st_mysql_show_var</code> 構造体の定義は次のとおりです。
          </p><pre class="programlisting">
struct st_mysql_show_var {
  const char *name;
  char *value;
  enum enum_mysql_show_type type;
};
</pre><p>
            プラグインがインストールされると、プラグイン名と <code class="literal">name</code> 値がアンダースコアで結合されて、<code class="literal">SHOW STATUS</code> によって表示される名前が形成されます。
          </p><p>
            次の表は、許可されるステータス変数の <code class="literal">type</code> 値、および対応する変数を示しています。
          </p><div class="table"><a name="idm139978998063600"></a><p class="title"><b>表 24.1 サーバープラグインのステータス変数のタイプ</b></p><div class="table-contents"><table summary="サーバープラグインのステータス変数のタイプ" border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">変数型</th><th scope="col">意味</th></tr></thead><tbody><tr><td scope="row"><code class="literal">SHOW_BOOL</code></td><td>ブール変数へのポインタ</td></tr><tr><td scope="row"><code class="literal">SHOW_INT</code></td><td>整数変数へのポインタ</td></tr><tr><td scope="row"><code class="literal">SHOW_LONG</code></td><td>long 整数変数へのポインタ</td></tr><tr><td scope="row"><code class="literal">SHOW_LONGLONG</code></td><td>longlong 整数変数へのポインタ</td></tr><tr><td scope="row"><code class="literal">SHOW_CHAR</code></td><td>文字列</td></tr><tr><td scope="row"><code class="literal">SHOW_CHAR_PTR</code></td><td>文字列へのポインタ</td></tr><tr><td scope="row"><code class="literal">SHOW_ARRAY</code></td><td>別の <code class="literal">st_mysql_show_var</code> 配列へのポインタ</td></tr><tr><td scope="row"><code class="literal">SHOW_FUNC</code></td><td>関数へのポインタ</td></tr><tr><td scope="row"><code class="literal">SHOW_DOUBLE</code></td><td>double へのポインタ</td></tr></tbody></table></div></div><br class="table-break"><p>
            <code class="literal">SHOW_FUNC</code> タイプの場合、関数が呼び出されると関数は <code class="literal">out</code> パラメータに値を設定し、表示される変数に関する情報がこのパラメータによって提供されます。関数のシグネチャーは次のようになります。
          </p><pre class="programlisting">
#define SHOW_VAR_FUNC_BUFF_SIZE 1024

typedef int (*mysql_show_var_func) (void *thd,
                                    struct st_mysql_show_var *out,
                                    char *buf);
</pre><p>
            <code class="literal">system_vars</code> メンバーは、0 でない場合、<code class="literal">st_mysql_sys_var</code> 構造体の配列を指しており、各構造には 1 つのシステム変数が記述されていて (これはコマンド行または構成ファイルからも設定できます)、すべてのメンバーが 0 に設定された構造があとに続きます。<code class="literal">st_mysql_sys_var</code> 構造体は次のように定義します。
          </p><pre class="programlisting">
struct st_mysql_sys_var {
 int flags;
 const char *name, *comment;
 int (*check)(THD*, struct st_mysql_sys_var *, void*, st_mysql_value*);
 void (*update)(THD*, struct st_mysql_sys_var *, void*, const void*);
};
</pre><p>
            フラグによって、追加フィールドが必要に応じて付加されます。
          </p><p>
            利便性のため、プラグイン内の新しいシステム変数の作成をより簡単にするための多数のマクロが定義されています。
          </p><p>
            マクロでは次のフィールドを使用できます。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">name</code>: システム変数の引用符で囲まれていない識別子。
              </p></li><li class="listitem"><p>
                <code class="literal">varname</code>: 静的変数の識別子。識別子がない場合は <code class="literal">name</code> フィールドと同じです。
              </p></li><li class="listitem"><p>
                <code class="literal">opt</code>: システム変数に追加で使用されるフラグ。次の表は、許容されるフラグを示しています。
              </p><div class="table"><a name="idm139978998028576"></a><p class="title"><b>表 24.2 サーバープラグインのシステム変数フラグ</b></p><div class="table-contents"><table summary="サーバープラグインのシステム変数フラグ" border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">フラグ値</th><th scope="col">説明</th></tr></thead><tbody><tr><td scope="row"><code class="literal">PLUGIN_VAR_READONLY</code></td><td>システム変数は読み取り専用である</td></tr><tr><td scope="row"><code class="literal">PLUGIN_VAR_NOSYSVAR</code></td><td>システム変数は実行時にユーザーに表示されない</td></tr><tr><td scope="row"><code class="literal">PLUGIN_VAR_NOCMDOPT</code></td><td>システム変数はコマンド行から構成できない</td></tr><tr><td scope="row"><code class="literal">PLUGIN_VAR_NOCMDARG</code></td><td>コマンド行に引数は不要である (通常はブール変数に使用します)</td></tr><tr><td scope="row"><code class="literal">PLUGIN_VAR_RQCMDARG</code></td><td>コマンド行に引数が必要である (これはデフォルトです)</td></tr><tr><td scope="row"><code class="literal"> PLUGIN_VAR_OPCMDARG</code></td><td>コマンド行の引数はオプションである</td></tr><tr><td scope="row"><code class="literal">PLUGIN_VAR_MEMALLOC</code></td><td>文字列変数に使用され、文字列の格納にメモリーが割り当てられることを示す</td></tr></tbody></table></div></div><br class="table-break"></li><li class="listitem"><p>
                <code class="literal">comment</code>: サーバーヘルプメッセージに表示される説明コメント。この変数が非表示の場合は <code class="literal">NULL</code> です。
              </p></li><li class="listitem"><p>
                <code class="literal">check</code>: チェック関数。デフォルトは <code class="literal">NULL</code> です。
              </p></li><li class="listitem"><p>
                <code class="literal">update</code>: 更新関数。デフォルトは <code class="literal">NULL</code> です。
              </p></li><li class="listitem"><p>
                <code class="literal">default</code>: 変数のデフォルト値。
              </p></li><li class="listitem"><p>
                <code class="literal">minimum</code>: 変数の最小値。
              </p></li><li class="listitem"><p>
                <code class="literal">maximum</code>: 変数の最大値。
              </p></li><li class="listitem"><p>
                <code class="literal">blocksize</code>: 変数のブロックサイズ。値が設定されると、もっとも近い <code class="literal">blocksize</code> の倍数に丸められます。
              </p></li></ul></div><p>
            システム変数には、静的変数を使用して直接アクセスするか、<code class="literal">SYSVAR()</code> アクセス機能マクロを使用してアクセスできます。完全性を期すために、<code class="literal">SYSVAR()</code> マクロが提供されています。通常、これはコードがベースとなる変数に直接アクセスできない場合にのみ使用してください。
          </p><p>
            例:
          </p><pre class="programlisting">
static int my_foo;
static MYSQL_SYSVAR_INT(foo_var, my_foo, 
                        PLUGIN_VAR_RQCMDARG, "foo comment", 
                        NULL, NULL, 0, 0, INT_MAX, 0);
 ...
   SYSVAR(foo_var)= value;
   value= SYSVAR(foo_var);
   my_foo= value; 
   value= my_foo;
</pre><p>
            セッション変数には <code class="literal">THDVAR()</code> アクセス機能マクロを介してのみアクセスできます。例:
          </p><pre class="programlisting">
static MYSQL_THDVAR_BOOL(some_flag, 
                         PLUGIN_VAR_NOCMDARG, "flag comment",
                         NULL, NULL, FALSE);
 ...
   if (THDVAR(thd, some_flag))
   {
     do_something();
     THDVAR(thd, some_flag)= FALSE;
   }
</pre><p>
            すべてのグローバルシステム変数およびセッションシステム変数は、使用する前に <span class="command"><strong>mysqld</strong></span> に公開する必要があります。これは、<code class="literal">NULL</code> で終わる変数の配列を作成し、プラグインパブリックインタフェースでそれにリンクすることによって行うことができます。例:
          </p><pre class="programlisting">
static struct st_mysql_sys_var *my_plugin_vars[]= {
  MYSQL_SYSVAR(foo_var),
  MYSQL_SYSVAR(some_flag),
  NULL
};
mysql_declare_plugin(fooplug)
{
  MYSQL_..._PLUGIN,
  &amp;plugin_data,
  "fooplug",
  "foo author",
  "This does foo!",
  PLUGIN_LICENSE_GPL,
  foo_init,
  foo_fini,
  0x0001,
  NULL,
  my_plugin_vars,
  NULL,
  0
}
mysql_declare_plugin_end;</pre><p>
            次の支援マクロを使用すると、さまざまなタイプのシステム変数を宣言できます。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                1 バイトのブール値 (0 = FALSE、1 = TRUE) である <code class="literal">my_bool</code> 型のブールシステム変数。
              </p><pre class="programlisting">
MYSQL_THDVAR_BOOL(name, opt, comment, check, update, default)
MYSQL_SYSVAR_BOOL(name, varname, opt, comment, check, update, default)
</pre></li><li class="listitem"><p>
                NULL で終わる文字列へのポインタである <code class="literal">char*</code> 型の文字列システム変数。
              </p><pre class="programlisting">
MYSQL_THDVAR_STR(name, opt, comment, check, update, default)
MYSQL_SYSVAR_STR(name, varname, opt, comment, check, update, default)
</pre></li><li class="listitem"><p>
                各種の整数システム変数。
              </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                    通常は 4 バイトの符号付きワードである <code class="literal">int</code> システム変数。
                  </p><pre class="programlisting">
MYSQL_THDVAR_INT(name, opt, comment, check, update, default, min, max, blk)
MYSQL_SYSVAR_INT(name, varname, opt, comment, check, update, default,
               minimum, maximum, blocksize)
</pre></li><li class="listitem"><p>
                    通常は 4 バイトの符号なしワードである <code class="literal">unsigned int</code> システム変数。
                  </p><pre class="programlisting">
MYSQL_THDVAR_UINT(name, opt, comment, check, update, default, min, max, blk)
MYSQL_SYSVAR_UINT(name, varname, opt, comment, check, update, default,
                minimum, maximum, blocksize)
</pre></li><li class="listitem"><p>
                    通常は 4 バイトまたは 8 バイトの符号付きワードである <code class="literal">long</code> システム変数。
                  </p><pre class="programlisting">
MYSQL_THDVAR_LONG(name, opt, comment, check, update, default, min, max, blk)
MYSQL_SYSVAR_LONG(name, varname, opt, comment, check, update, default,
                minimum, maximum, blocksize)
</pre></li><li class="listitem"><p>
                    通常は 4 バイトまたは 8 バイトの符号なしワードである <code class="literal">unsigned long</code> システム変数。
                  </p><pre class="programlisting">
MYSQL_THDVAR_ULONG(name, opt, comment, check, update, default, min, max, blk)
MYSQL_SYSVAR_ULONG(name, varname, opt, comment, check, update, default,
                 minimum, maximum, blocksize)
</pre></li><li class="listitem"><p>
                    通常は 8 バイトの符号付きワードである <code class="literal">long long</code> システム変数。
                  </p><pre class="programlisting">
MYSQL_THDVAR_LONGLONG(name, opt, comment, check, update,
                    default, minimum, maximum, blocksize)
MYSQL_SYSVAR_LONGLONG(name, varname, opt, comment, check, update, 
                    default, minimum, maximum, blocksize)
</pre></li><li class="listitem"><p>
                    通常は 8 バイトの符号なしワードである <code class="literal">unsigned long long</code> システム変数。
                  </p><pre class="programlisting">
MYSQL_THDVAR_ULONGLONG(name, opt, comment, check, update, 
                     default, minimum, maximum, blocksize)
MYSQL_SYSVAR_ULONGLONG(name, varname, opt, comment, check, update,
                     default, minimum, maximum, blocksize)
</pre></li><li class="listitem"><p>
                    通常は 4 バイトまたは 8 バイトの符号なしワードである <code class="literal">unsigned long</code> システム変数。設定可能な値の範囲は <code class="literal">typelib</code> 内の要素の数の序数であり、0 から始まります。
                  </p><pre class="programlisting">
MYSQL_THDVAR_ENUM(name, opt, comment, check, update, default, typelib)
MYSQL_SYSVAR_ENUM(name, varname, opt, comment, check, update,
                default, typelib)
</pre></li><li class="listitem"><p>
                    通常は 8 バイトの符号なしワードである <code class="literal">unsigned long long</code> システム変数。各ビットは <code class="literal">typelib</code> 内の要素を表します。
                  </p><pre class="programlisting">
MYSQL_THDVAR_SET(name, opt, comment, check, update, default, typelib)
MYSQL_SYSVAR_SET(name, varname, opt, comment, check, update,
               default, typelib)
</pre></li></ul></div></li></ul></div><p>
            内部的には、変更されることがあるすべてのプラグインシステム変数は <code class="literal">HASH</code> 構造体に格納されます。
          </p><p>
            サーバーのコマンド行でのヘルプテキストの表示は、コマンド行オプションに関係するすべての変数の <code class="literal">DYNAMIC_ARRAY</code> をコンパイルしてそれらをソートし、それを繰り返して各オプションを表示することによって処理されます。
          </p><p>
            コマンド行オプションが処理されると、<code class="literal">handle_option()</code> 関数 (<code class="filename">my_getopt.c</code>) によって <code class="literal">argv</code> から削除され、実質的にその役割が終わります。
          </p><p>
            サーバーはプラグインのインストール処理中 (プラグインが正常にロードされた直後、かつプラグインの初期化関数が呼び出される前) にコマンド行オプションを処理します。
          </p><p>
            実行時にロードされるプラグインは構成オプションを利用できないため、使用可能なデフォルト値がある必要があります。プラグインをインストールすると、<span class="command"><strong>mysqld</strong></span> の初期化時にロードされ、構成オプションをコマンド行または <code class="filename">my.cnf</code> 内に設定できます。
          </p><p>
            プラグインで <code class="literal">thd</code> パラメータを読み取り専用にすることを検討してください。
          </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="client-plugin-descriptors"></a>24.2.4.2.3 クライアントプラグインディスクリプタ</h5></div></div></div><p>
            各クライアントプラグインには、クライアントプラグイン API に情報を提供するディスクリプタが必要となります。ディスクリプタの構造体は、すべてのクライアントプラグインに共通する固定された一連のメンバーで始まり、プラグインタイプ固有のメンバーがあとに続きます。
          </p><p>
            <code class="filename">client_plugin.h</code> ファイル内の <code class="literal">st_mysql_client_plugin</code> 構造体は、共通メンバーが含まれている<span class="quote">「<span class="quote">一般的な</span>」</span>ディスクリプタを定義します。
          </p><pre class="programlisting">
struct st_mysql_client_plugin
{
  int type;
  unsigned int interface_version;
  const char *name;
  const char *author;
  const char *desc;
  unsigned int version[3];
  const char *license;
  void *mysql_api;
  int (*init)(char *, size_t, int, va_list);
  int (*deinit)();
  int (*options)(const char *option, const void *);
};
</pre><p>
            <code class="literal">st_mysql_client_plugin</code> ディスクリプタ構造体の共通メンバーは、次のように使用します。<code class="literal">char *</code> メンバーは、NULL で終わる文字列として指定してください。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">type</code>: プラグインの型。これは <code class="filename">client_plugin.h</code> のプラグインタイプ値 (<code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN</code> など) のいずれかである必要があります。
              </p></li><li class="listitem"><p>
                <code class="literal">interface_version</code>: プラグインインタフェースのバージョン。たとえば、認証プラグインの場合、これは <code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN_INTERFACE_VERSION</code> です。
              </p></li><li class="listitem"><p>
                <code class="literal">name</code>: プラグイン名を指定する文字列。これは、<code class="literal">MYSQL_DEFAULT_AUTH</code> オプションを指定して <code class="literal">mysql_options()</code> を呼び出すか、MySQL クライアントプログラムに <code class="option">--default-auth</code> オプションを指定するときにプラグインを参照するための名前です。
              </p></li><li class="listitem"><p>
                <code class="literal">author</code>: プラグイン作成者を示す文字列。これには任意の文字列を指定できます。
              </p></li><li class="listitem"><p>
                <code class="literal">desc</code>: プラグインの概要を説明する文字列。これには任意の文字列を指定できます。
              </p></li><li class="listitem"><p>
                <code class="literal">version</code>: メジャー、マイナー、およびその下のバージョンを示す 3 つの整数の配列であるプラグインバージョン。たとえば、<code class="literal">{1,2,3}</code> はバージョン 1.2.3 を示します。
              </p></li><li class="listitem"><p>
                <code class="literal">license</code>: ライセンスタイプを指定する文字列。
              </p></li><li class="listitem"><p>
                <code class="literal">mysql_api</code>: 内部で使用されます。プラグインディスクリプタでは <code class="literal">NULL</code> に指定します。
              </p></li><li class="listitem"><p>
                <code class="literal">init</code>: 1 回だけ実行される初期化関数であり、そのような関数がない場合は <code class="literal">NULL</code> です。クライアントライブラリはプラグインをロードするときにこの関数を実行します。関数は、成功した場合はゼロ、および失敗した場合はゼロ以外を返します。
              </p><p>
                エラーが発生した場合、<code class="literal">init</code> 関数は最初の 2 つの引数を使用してエラーメッセージを返します。最初の引数は <code class="literal">char</code> バッファーへのポインタであり、2 番目の引数はバッファー長を示します。<code class="literal">init</code> 関数によって返されるすべてのメッセージは NULL で終わる必要があるため、最大のメッセージ長はバッファー長から 1 を引いた長さです。それに続く引数が <code class="literal">mysql_load_plugin()</code> に渡されます。先頭の引数は、以降に存在する引数の数を示し (ない場合は 0)、そのあとに残りの引数が続きます。
              </p></li><li class="listitem"><p>
                <code class="literal">deinit</code>: 1 回だけ実行される初期化解除関数であり、そのような関数がない場合は <code class="literal">NULL</code> です。クライアントライブラリは、プラグインをアンロードするときにこの関数を実行します。この関数は引数を受け取りません。成功した場合はゼロ、および失敗した場合はゼロ以外を返します。
              </p></li><li class="listitem"><p>
                <code class="literal">options</code>: プラグインに渡されるオプションを処理するための関数であり、そのような関数がない場合は <code class="literal">NULL</code> です。この関数は、オプション名およびその値へのポインタを表す 2 つの引数を受け取ります。関数は、成功した場合はゼロ、および失敗した場合はゼロ以外を返します。
              </p></li></ul></div><p>
            特定のクライアントプラグインタイプでは、共通のディスクリプタメンバーのあとに、そのタイプのプラグインを実装するために必要な追加メンバーが続くことがあります。たとえば、認証プラグインの <code class="literal">st_mysql_client_plugin_AUTHENTICATION</code> 構造体には、認証を実行するためにクライアントライブラリが呼び出す関数が最後にあります。
          </p><p>
            プラグインを宣言するには、<code class="literal">mysql_declare_client_plugin()</code> マクロおよび <code class="literal">mysql_end_client_plugin</code> マクロを使用します。
          </p><pre class="programlisting">
mysql_declare_client_plugin(<em class="replaceable"><code>plugin_type</code></em>)
   ... <em class="replaceable"><code>members common to all client plugins</code></em> ...
   ... <em class="replaceable"><code>type-specific extra members</code></em> ...
mysql_end_client_plugin;
</pre><p>
            <code class="literal">type</code> または <code class="literal">interface_version</code> メンバーを明示的に指定しないでください。<code class="literal">mysql_declare_client_plugin()</code> マクロは <em class="replaceable"><code>plugin_type</code></em> 引数を使用して、これらの値を自動的に生成します。たとえば、認証クライアントプラグインは次のように宣言します。
          </p><pre class="programlisting">
mysql_declare_client_plugin(AUTHENTICATION)
  "my_auth_plugin",
  "Author Name",
  "My Client Authentication Plugin",
  {1,0,0},
  "GPL",
  NULL,
  my_auth_init,
  my_auth_deinit,
  my_auth_options,
  my_auth_main
mysql_end_client_plugin;
</pre><p>
            この宣言では、<code class="literal">AUTHENTICATION</code> 引数を使用して、<code class="literal">type</code> および <code class="literal">interface_version</code> メンバーに <code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN</code> および <code class="literal">MYSQL_CLIENT_AUTHENTICATION_PLUGIN_INTERFACE_VERSION</code> を設定しています。
          </p><p>
            プラグインタイプによっては、ディスクリプタの共通メンバーに続いてほかのメンバーがあることがあります。たとえば、認証プラグインの場合、サーバーとの通信を処理する関数 (上記のディスクリプタでは <code class="literal">my_auth_main()</code>) があります。<a class="xref" href="extending-mysql.html#writing-authentication-plugins" title="24.2.4.9 認証プラグインの作成">セクション24.2.4.9「認証プラグインの作成」</a>を参照してください。
          </p><p>
            通常、認証プラグインの使用をサポートしているクライアントプログラムは、<code class="literal">mysql_options()</code> を呼び出して <code class="literal">MYSQL_DEFAULT_AUTH</code> オプションおよび <code class="literal">MYSQL_PLUGIN_DIR</code> オプションを設定することによって、プラグインをロードします。
          </p><pre class="programlisting">
char *plugin_dir = "<em class="replaceable"><code>path_to_plugin_dir</code></em>";
char *default_auth = "<em class="replaceable"><code>plugin_name</code></em>";

/* ... process command-line options ... */

mysql_options(&amp;mysql, MYSQL_PLUGIN_DIR, plugin_dir);
mysql_options(&amp;mysql, MYSQL_DEFAULT_AUTH, default_auth);
</pre><p>
            一般にプログラムは、ユーザーがデフォルト値をオーバーライドできるようにする <code class="option">--plugin-dir</code> および <code class="option">--default-auth</code> オプションも受け付けます。
          </p><p>
            クライアントプログラムで低レベルのプラグイン管理が必要である場合は、クライアントライブラリに <code class="literal">st_mysql_client_plugin</code> 引数を受け取る関数を含めます。<a class="xref" href="connectors-apis.html#c-api-plugin-functions" title="23.8.14 C API クライアントプラグイン関数">セクション23.8.14「C API クライアントプラグイン関数」</a>を参照してください。
          </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="compiling-plugin-libraries"></a>24.2.4.3 プラグインライブラリのコンパイルおよびインストール</h4></div></div></div><p>
          プラグインを記述したら、プラグインをコンパイルしてインストールする必要があります。共有オブジェクトをコンパイルする手順はシステムによって異なります。<code class="literal">CMake</code> を使用してライブラリをビルドする場合は、それがシステムの正しいコンパイルコマンドを生成できる必要があります。ライブラリに <code class="literal">somepluglib</code> という名前を指定した場合、共有オブジェクトファイルの名前は <code class="filename">somepluglib.so</code> のようになります。(使用しているシステムではファイル名のサフィクスが異なる場合もあります。)
        </p><p>
          <code class="literal">CMake</code> を使用する場合は、構成ファイルをセットアップして、プラグインがコンパイルおよびインストールされるようにする必要があります。MySQL ソース配布の <code class="filename">plugin</code> ディレクトリの下にあるプラグインの例をガイドとして使用してください。
        </p><p>
          次のような <code class="filename">CMakeLists.txt</code> を作成します。
        </p><pre class="programlisting">
MYSQL_ADD_PLUGIN(somepluglib somepluglib.c
  MODULE_ONLY MODULE_OUTPUT_NAME "somepluglib")
</pre><p>
          <code class="literal">CMake</code> が <code class="filename">Makefile</code> を生成するとき、コンパイルコマンドに <code class="literal">-DMYSQL_DYNAMIC_PLUGIN</code> フラグを渡し、リンカーに <code class="literal">-lmysqlservices</code> フラグを渡します。これは、プラグインサービスインタフェースを介して提供されるサービスの関数でリンクするために必要となります。<a class="xref" href="extending-mysql.html#plugin-services" title="24.2.5 プラグインのための MySQL サービス">セクション24.2.5「プラグインのための MySQL サービス」</a>を参照してください。
        </p><p>
          <span class="command"><strong>CMake</strong></span> を実行してから <span class="command"><strong>make</strong></span> を実行します。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>cmake .</code></strong>
shell&gt; <strong class="userinput"><code>make</code></strong>
</pre><p>
          <span class="command"><strong>CMake</strong></span> の構成オプションを指定する必要がある場合、リストについては<a class="xref" href="installing.html#source-configuration-options" title="2.9.4 MySQL ソース構成オプション">セクション2.9.4「MySQL ソース構成オプション」</a>を参照してください。たとえば、プラグインのインストール先となる MySQL のベースディレクトリを指定するために <code class="option">CMAKE_INSTALL_PREFIX</code> を指定する場合があります。このオプションに使用する値は <code class="literal">SHOW VARIABLES</code> で確認できます。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SHOW VARIABLES LIKE 'basedir';</code></strong>
+---------------+------------------+
| Variable_name | Value            |
+---------------+------------------+
| base          | /usr/local/mysql |
+---------------+------------------+
</pre><p>
          ライブラリをインストールするプラグインディレクトリの場所は、<code class="literal">plugin_dir</code> システム変数によって指定されます。例:
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SHOW VARIABLES LIKE 'plugin_dir';</code></strong>
+---------------+-----------------------------------+
| Variable_name | Value                             |
+---------------+-----------------------------------+
| plugin_dir    | /usr/local/mysql/lib/mysql/plugin |
+---------------+-----------------------------------+
</pre><p>
          プラグインライブラリをインストールするには、<span class="command"><strong>make</strong></span> を使用します。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>make install</code></strong>
</pre><p>
          <span class="command"><strong>make install</strong></span> によってプラグインライブラリが適切なディレクトリにインストールされたことを確認します。インストール後、サーバーが実行するためのアクセス権がライブラリに設定されていることを確認してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-full-text-plugins"></a>24.2.4.4 全文パーサープラグインの作成</h4></div></div></div><p>
          MySQL 5.6 では、<code class="literal">MyISAM</code> でのみ全文パーサープラグインがサポートされます。全文パーサープラグインについての概要は、<a class="xref" href="extending-mysql.html#full-text-plugins" title="24.2.3.2 全文パーサープラグイン">セクション24.2.3.2「全文パーサープラグイン」</a>を参照してください。
        </p><p>
          全文パーサーサーバープラグインは、組み込みの全文パーサーの代わりにするか、それを変更するために使用できます。このセクションでは、<code class="literal">simple_parser</code> という名前の全文パーサープラグインを記述する方法について説明します。このプラグインは、MySQL の組み込み全文パーサーによって使用されるものよりも簡単なルールに基づいて構文解析を実行し、単語は空白文字を含まない文字列です。
        </p><p>
          この手順では、MySQL ソース配布の <code class="filename">plugin/fulltext</code> ディレクトリ内のソースコードを使用しているため、このディレクトリに場所を変更してください。次の手順では、プラグインライブラリを作成する方法について説明します。
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
              全文パーサープラグインを記述するために、プラグインソースファイルで次のヘッダーファイルをインクルードします。プラグインの機能および要件によっては、ほかの MySQL のヘッダーファイルまたは一般的なヘッダーファイルが必要になることもあります。
            </p><pre class="programlisting">
#include &lt;mysql/plugin.h&gt;
</pre><p>
              <code class="filename">plugin.h</code> は、<code class="literal">MYSQL_FTPARSER_PLUGIN</code> サーバープラグインタイプ、およびプラグインを宣言するために必要なデータ構造体を定義します。
            </p></li><li class="listitem"><p>
              プラグインライブラリファイルのライブラリディスクリプタをセットアップします。
            </p><p>
              このディスクリプタには、サーバープラグインの一般プラグインディスクリプタが含まれています。全文パーサープラグインの場合、タイプは <code class="literal">MYSQL_FTPARSER_PLUGIN</code> である必要があります。これは、<code class="literal">FULLTEXT</code> インデックスの作成時に <code class="literal">WITH PARSER</code> 句で使用する場合に、プラグインが正当なものであることを識別する値です。(ほかのプラグインタイプは、この句に対して正当ではありません。)
            </p><p>
              たとえば、<code class="literal">simple_parser</code> という名前の単一の全文パーサープラグインを格納するライブラリのライブラリディスクリプタは、次のようになります。
            </p><pre class="programlisting">
mysql_declare_plugin(ftexample)
{
  MYSQL_FTPARSER_PLUGIN,      /* type                            */
  &amp;simple_parser_descriptor,  /* descriptor                      */
  "simple_parser",            /* name                            */
  "Oracle Corporation",       /* author                          */
  "Simple Full-Text Parser",  /* description                     */
  PLUGIN_LICENSE_GPL,         /* plugin license                  */
  simple_parser_plugin_init,  /* init function (when loaded)     */
  simple_parser_plugin_deinit,/* deinit function (when unloaded) */
  0x0001,                     /* version                         */
  simple_status,              /* status variables                */
  simple_system_variables,    /* system variables                */
  NULL,
  0
}
mysql_declare_plugin_end;
</pre><p>
              <code class="literal">name</code> メンバー (<code class="literal">simple_parser</code>) は、<code class="literal">INSTALL PLUGIN</code>、<code class="literal">UNINSTALL PLUGIN</code> などのステートメントでプラグインを参照するために使用する名前を示しています。これは、<code class="literal">SHOW PLUGINS</code> または <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> によって表示される名前でもあります。
            </p><p>
              詳細は、<a class="xref" href="extending-mysql.html#server-plugin-descriptors" title="24.2.4.2.1 サーバープラグインライブラリおよびプラグインディスクリプタ">セクション24.2.4.2.1「サーバープラグインライブラリおよびプラグインディスクリプタ」</a>を参照してください。
            </p></li><li class="listitem"><p>
              タイプ固有のプラグインディスクリプタをセットアップします。
            </p><p>
              ライブラリディスクリプタの各一般プラグインディスクリプタは、タイプ固有のディスクリプタを指しています。全文パーサープラグインの場合、タイプ固有のディスクリプタは <code class="filename">plugin.h</code> ファイル内の <code class="literal">st_mysql_ftparser</code> 構造体のインスタンスです。
            </p><pre class="programlisting">
struct st_mysql_ftparser
{
  int interface_version;
  int (*parse)(MYSQL_FTPARSER_PARAM *param);
  int (*init)(MYSQL_FTPARSER_PARAM *param);
  int (*deinit)(MYSQL_FTPARSER_PARAM *param);
};
</pre><p>
              構造体定義に示されているように、ディスクリプタにはインタフェースバージョン番号があり、3 つの関数へのポインタが含まれています。
            </p><p>
              インタフェースのバージョン番号はシンボルを使用して指定し、<code class="literal">MYSQL_<em class="replaceable"><code>xxx</code></em>_INTERFACE_VERSION</code> という形式です。全文パーサープラグインの場合、シンボルは<span class="quote">「<span class="quote"><code class="literal">MYSQL_FTPARSER_INTERFACE_VERSION</code></span>」</span>です。ソースコードには、<code class="filename">include/mysql/plugin_ftparser.h</code> に定義されている全文パーサープラグインの実際のインタフェースバージョン番号があります。
            </p><p>
              <code class="literal">init</code> メンバーおよび <code class="literal">deinit</code> メンバーは、関数を指すようにするか、関数が不要な場合は 0 に設定します。<code class="literal">parse</code> メンバーは、構文解析を実行する関数を指している必要があります。
            </p><p>
              <code class="literal">simple_parser</code> 宣言では、そのディスクリプタは <code class="literal">&amp;simple_parser_descriptor</code> によって示されています。ディスクリプタは、全文プラグインインタフェースのバージョン番号 (<code class="literal">MYSQL_FTPARSER_INTERFACE_VERSION</code> によって指定されます)、プラグインの構文解析関数、初期化関数、および初期化解除関数を指定します。
            </p><pre class="programlisting">
static struct st_mysql_ftparser simple_parser_descriptor=
{
  MYSQL_FTPARSER_INTERFACE_VERSION, /* interface version      */
  simple_parser_parse,              /* parsing function       */
  simple_parser_init,               /* parser init function   */
  simple_parser_deinit              /* parser deinit function */
};
</pre><p>
              全文パーサーサーバープラグインは、インデックス設定と検索の 2 つの異なるコンテキストで使用されます。両方のコンテキストで、サーバーはプラグインを呼び出した各 SQL ステートメントの処理の開始時と終了時に初期化関数および初期化解除関数を呼び出します。ただし、ステートメントの処理中に、サーバーはコンテキストに固有の方法でメインの構文解析関数を呼び出します。
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  インデックス設定の場合、サーバーはインデックス設定される各カラム値に対してパーサーを呼び出します。
                </p></li><li class="listitem"><p>
                  検索の場合、サーバーは検索文字列を構文解析するためにパーサーを呼び出します。パーサーはステートメントによって処理される行に対して呼び出されることもあります。自然言語モードでは、サーバーがパーサーを呼び出す必要はありません。クエリー拡張を使用したブールモードフレーズ検索または自然言語検索の場合、インデックスにない情報についてカラム値を構文解析するためにパーサーが使用されます。また、<code class="literal">FULLTEXT</code> インデックスのないカラムに対してブールモード検索が実行された場合は、組み込みパーサーが呼び出されます。(プラグインは特定のインデックスに関連付けられます。インデックスがない場合、プラグインは使用されません。)
                </p></li></ul></div><p>
              一般プラグインディスクリプタのプラグイン宣言には、初期化関数および初期化解除関数を指している <code class="literal">init</code> メンバーおよび <code class="literal">deinit</code> メンバーがあり、指している先のタイプ固有のプラグインディスクリプタにもこれらがあります。ただし、これらの関数のペアは目的が異なり、異なる理由で呼び出されます。
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  一般プラグインディスクリプタのプラグイン宣言の場合、初期化関数および初期化解除関数は、プラグインがロードおよびアンロードされるときに呼び出されます。
                </p></li><li class="listitem"><p>
                  タイプ固有のプラグインディスクリプタの場合、初期化関数および初期化解除関数は、プラグインが使用される SQL ステートメントごとに呼び出されます。
                </p></li></ul></div><p>
              プラグインディスクリプタに指定されている各インタフェース関数は、成功の場合はゼロ、および失敗の場合はゼロ以外を返し、構文解析するコンテキストが含まれている <code class="literal">MYSQL_FTPARSER_PARAM</code> 構造体を指している引数を受け取ります。この構造体の定義は次のとおりです。
            </p><pre class="programlisting">
typedef struct st_mysql_ftparser_param
{
  int (*mysql_parse)(struct st_mysql_ftparser_param *,
                     char *doc, int doc_len);
  int (*mysql_add_word)(struct st_mysql_ftparser_param *,
                        char *word, int word_len,
                        MYSQL_FTPARSER_BOOLEAN_INFO *boolean_info);
  void *ftparser_state;
  void *mysql_ftparam;
  struct charset_info_st *cs;
  char *doc;
  int length;
  int flags;
  enum enum_ftparser_mode mode;
} MYSQL_FTPARSER_PARAM;
</pre><p>
              構造体メンバーは次のように使用されます。
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  <code class="literal">mysql_parse</code>: サーバーの組み込みパーサーを呼び出すコールバック関数へのポインタ。プラグインが組み込みパーサーのフロントエンドとして動作する場合は、このコールバックを使用します。つまり、プラグインの構文解析関数が呼び出されたとき、その関数は入力を処理してテキストを抽出し、テキストを <code class="literal">mysql_parse</code> コールバックに渡します。
                </p><p>
                  このコールバック関数の最初のパラメータは、<code class="literal">param</code> 値自体となります。
                </p><pre class="programlisting">
param-&gt;mysql_parse(param, ...);
</pre><p>
                  フロントエンドプラグインは、テキストを抽出して一度にすべてのテキストを組み込みパーサーに渡すか、テキストを抽出して一度にテキストの一部分ずつを組み込みパーサーに渡すことができます。ただし、この場合、組み込みサーバーはテキストの一部分同士の間に暗黙的な単語の分割があるかのように処理します。
                </p></li><li class="listitem"><p>
                  <code class="literal">mysql_add_word</code>: 全文インデックスまたは検索語のリストに単語を追加するコールバック関数へのポインタ。このコールバックは、組み込みパーサーをパーサープラグインに置き換えた場合に使用します。つまり、プラグインの構文解析関数が呼び出されたとき、その関数が入力を単語に構文解析し、各単語について <code class="literal">mysql_add_word</code> コールバックが呼び出されます。
                </p><p>
                  このコールバック関数の最初のパラメータは、<code class="literal">param</code> 値自体となります。
                </p><pre class="programlisting">
param-&gt;mysql_add_word(param, ...);
</pre></li><li class="listitem"><p>
                  <code class="literal">ftparser_state</code>: これは一般的なポインタです。プラグインは独自の目的のために内部で使用される情報を指すようにこれを設定できます。
                </p></li><li class="listitem"><p>
                  <code class="literal">mysql_ftparam</code>: これはサーバーによって設定されます。これは最初の引数として <code class="literal">mysql_parse</code> または <code class="literal">mysql_add_word</code> コールバックに渡されます。
                </p></li><li class="listitem"><p>
                  <code class="literal">cs</code>: テキストの文字セットについての情報へのポインタであり、情報がない場合は 0 です。
                </p></li><li class="listitem"><p>
                  <code class="literal">doc</code>: 構文解析されるテキストへのポインタ。
                </p></li><li class="listitem"><p>
                  <code class="literal">length</code>: 構文解析されるテキストのバイト単位の長さ。
                </p></li><li class="listitem"><p>
                  <code class="literal">flags</code>: パーサーのフラグ。特別なフラグがない場合、これはゼロです。現時点で、ゼロ以外のフラグは <code class="literal">MYSQL_FTFLAGS_NEED_COPY</code> のみであり、これは <code class="literal">mysql_add_word()</code> が単語のコピーを保存する必要がある (つまり、単語は上書きされるバッファー内にあるため、単語へのポインタを使用できない) ことを意味します。このメンバーは MySQL 5.1.12 で追加されました。
                </p><p>
                  このフラグは、MySQL (パーサープラグインを呼び出す前)、パーサープラグイン自体、または <code class="literal">mysql_parse()</code> 関数が設定またはリセットできます
                </p></li><li class="listitem"><p>
                  <code class="literal">mode</code>: 構文解析のモード。この値は次の定数のいずれかです。
                </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                      <code class="literal">MYSQL_FTPARSER_SIMPLE_MODE</code>: 単純で高速なモードで構文解析し、インデックス設定および自然言語クエリーに使用されます。パーサーは、インデックスを設定する単語のみをサーバーに渡します。パーサーが長さ制限またはストップワードリストを使用して無視する単語を判別する場合、パーサーはそのような単語をサーバーに渡しません。
                    </p></li><li class="listitem"><p>
                      <code class="literal">MYSQL_FTPARSER_WITH_STOPWORDS</code>: ストップワードモードで構文解析します。これはフレーズ照合のためのブール検索で使用されます。パーサーは、ストップワードや通常の長さ制限の範囲外にある単語であっても、すべての単語をサーバーに渡します。
                    </p></li><li class="listitem"><p>
                      <code class="literal">MYSQL_FTPARSER_FULL_BOOLEAN_INFO</code>: ブールモードで構文解析します。これはブールクエリー文字列の構文解析に使用されます。パーサーは単語だけでなくブールモード演算子も認識し、<code class="literal">mysql_add_word</code> コールバックを使用してこれらをトークンとしてサーバーに渡します。渡されるトークンの種類をサーバーに通知するために、プラグインは <code class="literal">MYSQL_FTPARSER_BOOLEAN_INFO</code> 構造体に値を設定して、この構造体へのポインタを渡す必要があります。
                    </p></li></ul></div></li></ul></div><p>
              パーサーがブールモードで呼び出された場合、<code class="literal">param-&gt;mode</code> 値は <code class="literal">MYSQL_FTPARSER_FULL_BOOLEAN_INFO</code> になります。サーバーにトークン情報を渡すためにパーサーが使用する <code class="literal">MYSQL_FTPARSER_BOOLEAN_INFO</code> 構造体は次のようになります。
            </p><pre class="programlisting">
typedef struct st_mysql_ftparser_boolean_info
{
  enum enum_ft_token_type type;
  int yesno;
  int weight_adjust;
  char wasign;
  char trunc;
  /* These are parser state and must be removed. */
  char prev;
  char *quot;
} MYSQL_FTPARSER_BOOLEAN_INFO;
</pre><p>
              パーサーは構造体メンバーに次のように値を設定します。
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                  <code class="literal">type</code>: トークンのタイプ。許容されるタイプを次の表に示します。
                </p><div class="table"><a name="idm139978997744560"></a><p class="title"><b>表 24.3 全文パーサーのトークンタイプ</b></p><div class="table-contents"><table summary="全文パーサーのトークンタイプ" border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">トークン値</th><th scope="col">意味</th></tr></thead><tbody><tr><td scope="row"><code class="literal">FT_TOKEN_EOF</code></td><td>データの終わり</td></tr><tr><td scope="row"><code class="literal">FT_TOKEN_WORD</code></td><td>通常の単語</td></tr><tr><td scope="row"><code class="literal">FT_TOKEN_LEFT_PAREN</code></td><td>グループまたは部分式の始まり</td></tr><tr><td scope="row"><code class="literal">FT_TOKEN_RIGHT_PAREN</code></td><td>グループまたは部分式の終わり</td></tr><tr><td scope="row"><code class="literal">FT_TOKEN_STOPWORD</code></td><td>ストップワード</td></tr></tbody></table></div></div><br class="table-break"></li><li class="listitem"><p>
                  <code class="literal">yesno</code>: 一致が発生するために単語が存在する必要があるかどうか。0 の場合、単語はオプションでですが、存在する場合は一致の関連性が増加することを意味します。0 より大きい値は、単語が存在する必要があることを意味します。0 より小さい値は、単語が存在していない必要があることを意味します。
                </p></li><li class="listitem"><p>
                  <code class="literal">weight_adjust</code>: 単語の一致の重要度を決定する重み付けの要素。これは、関連性計算での単語の重要性を増加または減少させるために使用できます。値がゼロの場合は、重み付けによる調整がないことを示します。ゼロより大きい値または小さい値は、重みが大きいことまたは小さいことをそれぞれ意味します。<code class="literal">&lt;</code> および <code class="literal">&gt;</code> 演算子を使用する<a class="xref" href="functions.html#fulltext-boolean" title="12.9.2 ブール全文検索">セクション12.9.2「ブール全文検索」</a>の例は、重み付けがどのように機能するかを示しています。
                </p></li><li class="listitem"><p>
                  <code class="literal">wasign</code>: 重み付け要素の符号。負の値は <code class="literal">~</code> ブール検索演算子のように作用し、これによって、関連性に対する単語の貢献度がマイナスになります。
                </p></li><li class="listitem"><p>
                  <code class="literal">trunc</code>: ブールモードの <code class="literal">*</code> 切り捨て演算子が指定された場合のように、照合を実行するかどうか。
                </p></li></ul></div><p>
              プラグインで、<code class="literal">MYSQL_FTPARSER_BOOLEAN_INFO</code> 構造体の <code class="literal">prev</code> メンバーおよび <code class="literal">quot</code> メンバーを使用しないでください。
            </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">注記</div><p>
                ブール演算子 <code class="literal">@ distance</code> は現在のプラグインパーサーフレームワークによってサポートされません。ブール全文検索の演算子については、<a class="xref" href="functions.html#fulltext-boolean" title="12.9.2 ブール全文検索">セクション12.9.2「ブール全文検索」</a>を参照してください。
              </p></div></li><li class="listitem"><p>
              プラグインインタフェース関数をセットアップします。
            </p><p>
              ライブラリディスクリプタ内の一般プラグインディスクリプタは、サーバーがプラグインをロードおよびアンロードするときに呼び出す初期化関数および初期化解除関数を指定します。<code class="literal">simple_parser</code> の場合、これらの関数は何も行いませんが、成功したことを示すためにゼロを返します。
            </p><pre class="programlisting">
static int simple_parser_plugin_init(void *arg __attribute__((unused)))
{
  return(0);
}

static int simple_parser_plugin_deinit(void *arg __attribute__((unused)))
{
  return(0);
}
</pre><p>
              これらの関数は実際に何も行わないため、これらを省略して、プラグイン宣言でそれぞれに 0 を指定できます。
            </p><p>
              <code class="literal">simple_parser</code> のタイプ固有のプラグインディスクリプタは、プラグインが使用されるときにサーバーが呼び出す初期化関数、初期化解除関数、および構文解析関数を指定します。<code class="literal">simple_parser</code> の場合、初期化関数および初期化解除関数は何も行いません。
            </p><pre class="programlisting">
static int simple_parser_init(MYSQL_FTPARSER_PARAM *param
                              __attribute__((unused)))
{
  return(0);
}

static int simple_parser_deinit(MYSQL_FTPARSER_PARAM *param
                                __attribute__((unused)))
{
  return(0);
}
</pre><p>
              ここでも、これらの関数は何も行わないため、これらを省略して、プラグインディスクリプタでそれぞれに 0 を指定できます。
            </p><p>
              メインの構文解析関数 <code class="literal">simple_parser_parse()</code> は組み込みの全文パーサーの代わりに動作するため、テキストを単語に分割して各単語をサーバーに渡す必要があります。構文解析関数の最初の引数は、構文解析するコンテキストが含まれている構造体へのポインタです。この構造体には、構文解析されるテキストを指している <code class="literal">doc</code> メンバー、およびテキストの長さを示す <code class="literal">length</code> メンバーがあります。このプラグインによって実行される単純な構文解析では、空白文字を含まない文字列を単語とみなすため、次のように単語を識別します。
            </p><pre class="programlisting">
static int simple_parser_parse(MYSQL_FTPARSER_PARAM *param)
{
  char *end, *start, *docend= param-&gt;doc + param-&gt;length;

  for (end= start= param-&gt;doc;; end++)
  {
    if (end == docend)
    {
      if (end &gt; start)
        add_word(param, start, end - start);
      break;
    }
    else if (isspace(*end))
    {
      if (end &gt; start)
        add_word(param, start, end - start);
      start= end + 1;
    }
  }
  return(0);
}
</pre><p>
              パーサーは単語を検出するごとに、関数 <code class="literal">add_word()</code> を呼び出して単語をサーバーに渡します。<code class="literal">add_word()</code> はヘルパー関数にすぎず、プラグインインタフェースの一部ではありません。パーサーは、構文解析されるコンテキストへのポインタ、単語へのポインタ、および長さの値を <code class="literal">add_word()</code> に渡します。
            </p><pre class="programlisting">
static void add_word(MYSQL_FTPARSER_PARAM *param, char *word, size_t len)
{
  MYSQL_FTPARSER_BOOLEAN_INFO bool_info=
    { FT_TOKEN_WORD, 0, 0, 0, 0, ' ', 0 };

  param-&gt;mysql_add_word(param, word, len, &amp;bool_info);
}
</pre><p>
              ブールモード構文解析の場合、前に <code class="literal">st_mysql_ftparser_boolean_info</code> 構造体の説明で示したように、<code class="literal">add_word()</code> は <code class="literal">bool_info</code> 構造体のメンバーに値を設定します。
            </p></li><li class="listitem"><p>
              ステータス変数をセットアップします。<code class="literal">simple_parser</code> プラグインの場合、次のステータス変数の配列は、1 つのステータス変数を静的テキストの値で設定し、別のステータス変数を long 整数変数に格納されている値で設定しています。
            </p><pre class="programlisting">
long number_of_calls= 0;

struct st_mysql_show_var simple_status[]=
{
  {"static", (char *)"just a static text", SHOW_CHAR},
  {"called", (char *)&amp;number_of_calls,     SHOW_LONG},
  {0,0,0}
};
</pre><p>
              プラグインがインストールされると、プラグイン名と <code class="literal">name</code> 値がアンダースコアで結合されて、<code class="literal">SHOW STATUS</code> によって表示される名前が形成されます。上記の配列の場合、生成されるステータス変数名は <code class="literal">simple_parser_static</code> および <code class="literal">simple_parser_called</code> です。この規則は、プラグインの変数をプラグイン名を使用して簡単に表示できることを意味します。
            </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SHOW STATUS LIKE 'simple_parser%';</code></strong>
+----------------------+--------------------+
| Variable_name        | Value              |
+----------------------+--------------------+
| simple_parser_static | just a static text |
| simple_parser_called | 0                  |
+----------------------+--------------------+
</pre></li><li class="listitem"><p>
              プラグインライブラリのオブジェクトファイルをコンパイルおよびインストールするには、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>の手順を使用します。ライブラリファイルを使用するには、ライブラリファイルがプラグインディレクトリ (<code class="literal">plugin_dir</code> システム変数で指定されているディレクトリ) にインストールされている必要があります。<code class="literal">simple_parser</code> プラグインの場合、ソースから MySQL をビルドするときにコンパイルおよびインストールされます。これはバイナリ配布にも含められます。ビルド処理では、<code class="filename">mypluglib.so</code> という名前の共有オブジェクトライブラリが生成されます (サフィクスはプラットフォームによって異なる場合があります)。
            </p></li><li class="listitem"><p>
              プラグインを使用するには、プラグインをサーバーに登録します。たとえば、プラグインを実行時に登録するには次のステートメントを使用します (必要に応じてサフィクスを変更します)。
            </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>INSTALL PLUGIN simple_parser SONAME 'mypluglib.so';</code></strong>
</pre><p>
              プラグインのロードについての追加情報は、<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>を参照してください。
            </p></li><li class="listitem"><p>
              プラグインのインストールを検証するには、<code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルを調査するか、<code class="literal">SHOW PLUGINS</code> ステートメントを使用します。
            </p></li><li class="listitem"><p>
              プラグインをテストして、正しく動作することを確認します。
            </p><p>
              文字列カラムを含むテーブルを作成し、パーサープラグインをそのカラムの <code class="literal">FULLTEXT</code> インデックスに関連付けます。
            </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>CREATE TABLE t (c VARCHAR(255),</code></strong>
    -&gt; <strong class="userinput"><code>  FULLTEXT (c) WITH PARSER simple_parser</code></strong>
    -&gt; <strong class="userinput"><code>) ENGINE=MyISAM;</code></strong>
Query OK, 0 rows affected (0.01 sec)
</pre><p>
              このテーブルにいくつかのテキストを挿入して検索を実行します。これらにより、パーサープラグインは空白文字でないすべての文字を単語文字として処理することが確認されます。
            </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>INSERT INTO t VALUES</code></strong>
    -&gt; <strong class="userinput"><code>  ('latin1_general_cs is a case-sensitive collation'),</code></strong>
    -&gt; <strong class="userinput"><code>  ('I\'d like a case of oranges'),</code></strong>
    -&gt; <strong class="userinput"><code>  ('this is sensitive information'),</code></strong>
    -&gt; <strong class="userinput"><code>  ('another row'),</code></strong>
    -&gt; <strong class="userinput"><code>  ('yet another row');</code></strong>
Query OK, 5 rows affected (0.02 sec)
Records: 5  Duplicates: 0  Warnings: 0

mysql&gt; <strong class="userinput"><code>SELECT c FROM t;</code></strong>
+-------------------------------------------------+
| c                                               |
+-------------------------------------------------+
| latin1_general_cs is a case-sensitive collation |
| I'd like a case of oranges                      |
| this is sensitive information                   |
| another row                                     |
| yet another row                                 |
+-------------------------------------------------+
5 rows in set (0.00 sec)

mysql&gt; <strong class="userinput"><code>SELECT MATCH(c) AGAINST('case') FROM t;</code></strong>
+--------------------------+
| MATCH(c) AGAINST('case') |
+--------------------------+
|                        0 |
|          1.2968142032623 |
|                        0 |
|                        0 |
|                        0 |
+--------------------------+
5 rows in set (0.00 sec)

mysql&gt; <strong class="userinput"><code>SELECT MATCH(c) AGAINST('sensitive') FROM t;</code></strong>
+-------------------------------+
| MATCH(c) AGAINST('sensitive') |
+-------------------------------+
|                             0 |
|                             0 |
|               1.3253291845322 |
|                             0 |
|                             0 |
+-------------------------------+
5 rows in set (0.01 sec)

mysql&gt; <strong class="userinput"><code>SELECT MATCH(c) AGAINST('case-sensitive') FROM t;</code></strong>
+------------------------------------+
| MATCH(c) AGAINST('case-sensitive') |
+------------------------------------+
|                    1.3109166622162 |
|                                  0 |
|                                  0 |
|                                  0 |
|                                  0 |
+------------------------------------+
5 rows in set (0.01 sec)

mysql&gt; <strong class="userinput"><code>SELECT MATCH(c) AGAINST('I\'d') FROM t;</code></strong>
+--------------------------+
| MATCH(c) AGAINST('I\'d') |
+--------------------------+
|                        0 |
|          1.2968142032623 |
|                        0 |
|                        0 |
|                        0 |
+--------------------------+
5 rows in set (0.01 sec)
</pre><p>
              組み込みパーサーとは異なり、<span class="quote">「<span class="quote">case</span>」</span>および<span class="quote">「<span class="quote">insensitive</span>」</span>は<span class="quote">「<span class="quote">case-insensitive</span>」</span>と一致していません。
            </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-daemon-plugins"></a>24.2.4.5 デーモンプラグインの作成</h4></div></div></div><p>
          デーモンプラグインは、サーバーによって実行されるがサーバーと通信しないコードに使用される単純なタイプのプラグインです。このセクションでは、MySQL ソース配布の <code class="literal">plugin/daemon_example</code> ディレクトリにあるプラグインの例を使用して、デーモンサーバープラグインを作成する方法について説明します。このディレクトリには、<code class="literal">daemon_example</code> という名前のデーモンプラグイン用の <code class="literal">daemon_example.cc</code> というソースファイルが格納されており、このデーモンプラグインは、データディレクトリ内の <code class="filename">mysql-heartbeat.log</code> という名前のファイルにハートビート文字列を定期的な間隔で書き込みます。
        </p><p>
          デーモンプラグインを作成するには、プラグインのソースファイルに次のヘッダーファイルをインクルードします。プラグインの機能および要件によっては、ほかの MySQL のヘッダーファイルまたは一般的なヘッダーファイルが必要になることもあります。
        </p><pre class="programlisting">
#include &lt;mysql/plugin.h&gt;
</pre><p>
          <code class="filename">plugin.h</code> は <code class="literal">MYSQL_DAEMON_PLUGIN</code> サーバープラグインタイプおよびプラグインの宣言に必要なデータ構造体を定義します。
        </p><p>
          <code class="filename">daemon_example.cc</code> ファイルはライブラリディスクリプタを次のようにセットアップします。このライブラリディスクリプタには、単一の一般サーバープラグインディスクリプタが含まれています。
        </p><pre class="programlisting">
mysql_declare_plugin(daemon_example)
{
  MYSQL_DAEMON_PLUGIN,
  &amp;daemon_example_plugin,
  "daemon_example",
  "Brian Aker",
  "Daemon example, creates a heartbeat beat file in mysql-heartbeat.log",
  PLUGIN_LICENSE_GPL,
  daemon_example_plugin_init, /* Plugin Init */
  daemon_example_plugin_deinit, /* Plugin Deinit */
  0x0100 /* 1.0 */,
  NULL,                       /* status variables                */
  NULL,                       /* system variables                */
  NULL,                       /* config options                  */
  0,                          /* flags                           */
}
mysql_declare_plugin_end;
</pre><p>
          <code class="literal">name</code> メンバー (<code class="literal">daemon_example</code>) は、<code class="literal">INSTALL PLUGIN</code> や <code class="literal">UNINSTALL PLUGIN</code> などのステートメント内でプラグインを参照するために使用する名前を指定します。これは、<code class="literal">SHOW PLUGINS</code> または <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> によって表示される名前でもあります。
        </p><p>
          プラグインディスクリプタの 2 番目のメンバー <code class="literal">daemon_example_plugin</code> は、タイプ固有のデーモンプラグインディスクリプタを指しています。この構造体は、タイプ固有の API バージョン番号のみで構成されています。
        </p><pre class="programlisting">
struct st_mysql_daemon daemon_example_plugin=
{ MYSQL_DAEMON_INTERFACE_VERSION  };
</pre><p>
          タイプ固有の構造体にはインタフェース機能がありません。サーバーとプラグインの間の通信はありませんが、サーバーは一般プラグインディスクリプタから初期化関数および初期化解除関数を呼び出してプラグインを開始および停止します。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">daemon_example_plugin_init()</code> はハートビートファイルを開き、定期的に動作するスレッドを生成し、次のメッセージをファイルに書き込みます。
            </p></li><li class="listitem"><p>
              <code class="literal">daemon_example_plugin_deinit()</code> はファイルを閉じて、ほかのクリーンアップ処理を実行します。
            </p></li></ul></div><p>
          プラグインライブラリのオブジェクトファイルをコンパイルおよびインストールするには、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>の手順を使用します。ライブラリファイルを使用するには、ライブラリファイルがプラグインディレクトリ (<code class="literal">plugin_dir</code> システム変数で指定されているディレクトリ) にインストールされている必要があります。<code class="literal">daemon_example</code> プラグインの場合、ソースから MySQL をビルドするときにコンパイルおよびインストールされます。これはバイナリ配布にも含められます。ビルド処理では、<code class="filename">libdaemon_example.so</code> という名前の共有オブジェクトライブラリが生成されます (サフィクスはプラットフォームによって異なる場合があります)。
        </p><p>
          プラグインを使用するには、プラグインをサーバーに登録します。たとえば、プラグインを実行時に登録するには、次のステートメントを使用します (必要に応じてサフィクスを変更します)。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>INSTALL PLUGIN daemon_example SONAME 'libdaemon_example.so';</code></strong>
</pre><p>
          プラグインのロードについての追加情報は、<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>を参照してください。
        </p><p>
          プラグインのインストールを検証するには、<code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルを調査するか、<code class="literal">SHOW PLUGINS</code> ステートメントを使用します。
        </p><p>
          プラグインがロードされると、プラグインはデータディレクトリ内の <code class="filename">mysql-heartbeat.log</code> という名前のファイルにハートビート文字列を定期的な間隔で書き込みます。このファイルは無制限に大きくなるため、プラグインが正しく動作することを確認したら、ファイルをアンロードしてください。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>UNINSTALL PLUGIN daemon_example;</code></strong>
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-information-schema-plugins"></a>24.2.4.6 INFORMATION_SCHEMA プラグインの作成</h4></div></div></div><p>
          このセクションでは、<code class="literal">INFORMATION_SCHEMA</code> テーブルサーバープラグインを作成する方法について説明します。このようなプラグインを実装するためのコード例については、MySQL ソース配布の <code class="literal">sql/sql_show.cc</code> ファイルを参照してください。<code class="literal">InnoDB</code> ソースにあるプラグインの例を参照することもできます。<code class="literal">InnoDB</code> ソースツリーの <code class="filename">handler/i_s.cc</code> ファイルおよび <code class="filename">handler/ha_innodb.cc</code> ファイルを参照してください (<code class="filename">storage/innobase</code> ディレクトリ内)。
        </p><p>
          <code class="literal">INFORMATION_SCHEMA</code> テーブルプラグインを作成するには、プラグインのソースファイルに次のヘッダーファイルをインクルードします。プラグインの機能および要件によっては、ほかの MySQL のヘッダーファイルまたは一般的なヘッダーファイルが必要になることもあります。
        </p><pre class="programlisting">
#include &lt;sql_class.h&gt;
#include &lt;table.h&gt;
</pre><p>
          これらのヘッダーファイルは、MySQL ソース配布の <code class="filename">sql</code> ディレクトリにあります。これらは C++ 構造体を含んでいるため、<code class="literal">INFORMATION_SCHEMA</code> プラグインのソースファイルは (C ではなく) C++ コードとしてコンパイルする必要があります。
        </p><p>
          ここで作成するプラグインの例のソースファイルは、<code class="filename">simple_i_s_table.cc</code> という名前です。これは、<code class="literal">SIMPLE_I_S_TABLE</code> という名前の単純な <code class="literal">INFORMATION_SCHEMA</code> テーブルを作成し、<code class="literal">NAME</code> および <code class="literal">VALUE</code> という名前の 2 つのカラムがあります。テーブルを実装するプラグインライブラリの一般ディスクリプタは、次のようになります。
        </p><pre class="programlisting">
mysql_declare_plugin(simple_i_s_library)
{
  MYSQL_INFORMATION_SCHEMA_PLUGIN,
  &amp;simple_table_info,                /* type-specific descriptor */
  "SIMPLE_I_S_TABLE",                /* table name */
  "Author Name",                     /* author */
  "Simple INFORMATION_SCHEMA table", /* description */
  PLUGIN_LICENSE_GPL,                /* license type */
  simple_table_init,                 /* init function */
  NULL,
  0x0100,                            /* version = 1.0 */
  NULL,                              /* no status variables */
  NULL,                              /* no system variables */
  NULL,                              /* no reserved information */
  0                                  /* no flags */
}
mysql_declare_plugin_end;
</pre><p>
          <code class="literal">name</code> メンバー (<code class="literal">SIMPLE_I_S_TABLE</code>) は、<code class="literal">INSTALL PLUGIN</code>、<code class="literal">UNINSTALL PLUGIN</code> などのステートメントでプラグインを参照するために使用する名前を指定します。これは、<code class="literal">SHOW PLUGINS</code> または <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> によって表示される名前でもあります。
        </p><p>
          一般ディスクリプタの <code class="literal">simple_table_info</code> メンバーは、タイプ固有の API バージョン番号のみで構成されるタイプ固有のディスクリプタを指しています。
        </p><pre class="programlisting">
static struct st_mysql_information_schema simple_table_info =
{ MYSQL_INFORMATION_SCHEMA_INTERFACE_VERSION };
</pre><p>
          一般ディスクリプタは、初期化関数および初期化解除関数を指しています。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              初期化関数は、テーブル構造体およびテーブルにデータを移入する関数についての情報を提供します。
            </p></li><li class="listitem"><p>
              初期化解除関数は、必要なすべてのクリーンアップ処理を実行します。クリーンアップが不要な場合、このディスクリプタメンバーには (例に示されているように) <code class="literal">NULL</code> を指定できます。
            </p></li></ul></div><p>
          初期化関数は、成功した場合は 0、およびエラーが発生した場合は 1 を返します。この関数は一般ポインタを受け取り、テーブル構造体へのポインタとして解釈します。
        </p><pre class="programlisting">
static int table_init(void *ptr)
{
  ST_SCHEMA_TABLE *schema_table= (ST_SCHEMA_TABLE*)ptr;

  schema_table-&gt;fields_info= simple_table_fields;
  schema_table-&gt;fill_table= simple_fill_table;
  return 0;
}
</pre><p>
          この関数は、テーブル構造体の次の 2 つのメンバーを設定します。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">fields_info</code>: 各カラムについての情報を格納する <code class="literal">ST_FIELD_INFO</code> 構造体の配列。
            </p></li><li class="listitem"><p>
              <code class="literal">fill_table</code>: テーブルにデータを移入する関数。
            </p></li></ul></div><p>
          <code class="literal">fields_info</code> によって指し示されている配列には、<code class="literal">INFORMATION_SCHEMA</code> のカラムごとの 1 つの要素および終端の要素が含まれるようにします。プラグイン例の次の <code class="literal">simple_table_fields</code> 配列は、<code class="literal">SIMPLE_I_S_TABLE</code> に 2 つのカラムがあることを示しています。<code class="literal">NAME</code> は長さ 10 バイトの文字列値であり、<code class="literal">VALUE</code> は表示幅が 20 バイトの整数値です。最後の構造体は、配列の終わりを示しています。
        </p><pre class="programlisting">
static ST_FIELD_INFO simple_table_fields[]=
{
  {"NAME", 10, MYSQL_TYPE_STRING, 0, 0 0, 0},
  {"VALUE", 6, MYSQL_TYPE_LONG, 0, MY_I_S_UNSIGNED, 0, 0},
  {0, 0, MYSQL_TYPE_NULL, 0, 0, 0, 0}
};
</pre><p>
          カラムの情報構造体については、<code class="literal">table.h</code> ヘッダーファイルの <code class="literal">ST_FIELD_INFO</code> の定義を参照してください。許容される <code class="literal">MYSQL_TYPE_<em class="replaceable"><code>xxx</code></em></code> タイプ値は、C API で使用される値です。<a class="xref" href="connectors-apis.html#c-api-data-structures" title="23.8.5 C API データ構造">セクション23.8.5「C API データ構造」</a>を参照してください。
        </p><p>
          <code class="literal">fill_table</code> メンバーには、テーブルにデータを移入して、成功した場合は 0、およびエラーが発生した場合は 1 を返す関数を設定します。プラグインの例の場合、<code class="literal">simple_fill_table()</code> 関数は次のようになっています。
        </p><pre class="programlisting">
static int simple_fill_table(THD *thd, TABLE_LIST *tables, Item *cond)
{
  TABLE *table= tables-&gt;table;

  table-&gt;field[0]-&gt;store("Name 1", 6, system_charset_info);
  table-&gt;field[1]-&gt;store(1);
  if (schema_table_store_record(thd, table))
    return 1;
  table-&gt;field[0]-&gt;store("Name 2", 6, system_charset_info);
  table-&gt;field[1]-&gt;store(2);
  if (schema_table_store_record(thd, table))
    return 1;
  return 0;
}
</pre><p>
          この関数は、<code class="literal">INFORMATION_SCHEMA</code> テーブルの各行の各カラムを初期化し、<code class="literal">schema_table_store_record()</code> を呼び出して行を生成します。<code class="literal">store()</code> メソッドの引数は、格納される値のタイプによって異なります。カラム 0 (<code class="literal">NAME</code>、文字列) の場合、<code class="literal">store()</code> は、文字列へのポインタ、その長さ、およびその文字列の文字セットに関する情報を受け取ります。
        </p><pre class="programlisting">
store(const char *to, uint length, CHARSET_INFO *cs);
</pre><p>
          カラム 1 (<code class="literal">VALUE</code>、整数) の場合、<code class="literal">store()</code> は値およびその値が符号なしであるかどうかを示すフラグを受け取ります。
        </p><pre class="programlisting">
store(longlong nr, bool unsigned_value);
</pre><p>
          <code class="literal">INFORMATION_SCHEMA</code> テーブルにデータを移入する方法に関するほかの例については、<code class="filename">sql_show.cc</code> で <code class="literal">schema_table_store_record()</code> のインスタンスを検索してください。
        </p><p>
          プラグインライブラリのオブジェクトファイルをコンパイルおよびインストールするには、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>の手順を参照してください。ライブラリファイルを使用するには、ライブラリファイルがプラグインディレクトリ (<code class="literal">plugin_dir</code> システム変数で指定されているディレクトリ) にインストールされている必要があります。
        </p><p>
          プラグインをテストするには、プラグインをインストールします。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>INSTALL PLUGIN SIMPLE_I_S_TABLE SONAME 'simple_i_s_table.so';</code></strong>
</pre><p>
          テーブルが存在することを確認します。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES</code></strong>
    -&gt; <strong class="userinput"><code>WHERE TABLE_NAME = 'SIMPLE_I_S_TABLE';</code></strong>
+------------------+
| TABLE_NAME       |
+------------------+
| SIMPLE_I_S_TABLE |
+------------------+
</pre><p>
          選択を試行します。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SELECT * FROM INFORMATION_SCHEMA.SIMPLE_I_S_TABLE;</code></strong>
+--------+-------+
| NAME   | VALUE |
+--------+-------+
| Name 1 |     1 |
| Name 2 |     2 |
+--------+-------+
</pre><p>
          アンインストールします。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>UNINSTALL PLUGIN SIMPLE_I_S_TABLE;</code></strong>
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-semisynchronous-replication-plugins"></a>24.2.4.7 準同期レプリケーションプラグインの作成</h4></div></div></div><p>
          このセクションでは、MySQL ソース配布の <code class="literal">plugin/semisync</code> ディレクトリにあるプラグイン例を使用して、準同期レプリケーションサーバープラグインを作成する方法について説明します。このディレクトリには、<code class="literal">rpl_semi_sync_master</code> および <code class="literal">rpl_semi_sync_slave</code> という名前のマスタープラグインおよびスレーブプラグインのソースファイルが格納されています。ここでは、プラグインフレームワークをセットアップする方法についてのみ説明します。プラグインがレプリケーション機能を実装する方法については、ソースを参照してください。
        </p><p>
          準同期レプリケーションプラグインを作成するには、プラグインソースファイルに次のヘッダーファイルをインクルードします。プラグインの機能および要件によっては、ほかの MySQL のヘッダーファイルまたは一般的なヘッダーファイルが必要になることもあります。
        </p><pre class="programlisting">
#include &lt;mysql/plugin.h&gt;
</pre><p>
          <code class="filename">plugin.h</code> は、<code class="literal">MYSQL_REPLICATION_PLUGIN</code> サーバープラグインタイプ、およびプラグインを宣言するために必要なデータ構造体を定義します。
        </p><p>
          マスター側の場合、<code class="filename">semisync_master_plugin.cc</code> には <code class="literal">rpl_semi_sync_master</code> という名前のプラグインの次の一般ディスクリプタが含まれています。
        </p><pre class="programlisting">
mysql_declare_plugin(semi_sync_master)
{
  MYSQL_REPLICATION_PLUGIN,
  &amp;semi_sync_master_plugin,
  "rpl_semi_sync_master",
  "He Zhenxing",
  "Semi-synchronous replication master",
  PLUGIN_LICENSE_GPL,
  semi_sync_master_plugin_init, /* Plugin Init */
  semi_sync_master_plugin_deinit, /* Plugin Deinit */
  0x0100 /* 1.0 */,
  semi_sync_master_status_vars, /* status variables */
  semi_sync_master_system_vars, /* system variables */
  NULL,                         /* config options */
  0,                            /* flags */
}
mysql_declare_plugin_end;
</pre><p>
          スレーブ側の場合、<code class="filename">semisync_slave_plugin.cc</code> には <code class="literal">rpl_semi_sync_slave</code> という名前のプラグインの次の一般ディスクリプタが含まれています。
        </p><pre class="programlisting">
mysql_declare_plugin(semi_sync_slave)
{
  MYSQL_REPLICATION_PLUGIN,
  &amp;semi_sync_slave_plugin,
  "rpl_semi_sync_slave",
  "He Zhenxing",
  "Semi-synchronous replication slave",
  PLUGIN_LICENSE_GPL,
  semi_sync_slave_plugin_init, /* Plugin Init */
  semi_sync_slave_plugin_deinit, /* Plugin Deinit */
  0x0100 /* 1.0 */,
  semi_sync_slave_status_vars,  /* status variables */
  semi_sync_slave_system_vars,  /* system variables */
  NULL,                         /* config options */
  0,                            /* flags */
}
mysql_declare_plugin_end;
</pre><p>
          マスタープラグインおよびスレーブプラグインのどちらの場合も、一般ディスクリプタには、タイプ固有のディスクリプタ、初期化関数と初期化解除関数、およびプラグインによって実装されるステータス変数とシステム変数へのポインタがあります。変数の設定については、<a class="xref" href="extending-mysql.html#plugin-status-system-variables" title="24.2.4.2.2 サーバープラグインのステータス変数およびシステム変数">セクション24.2.4.2.2「サーバープラグインのステータス変数およびシステム変数」</a>を参照してください。以降の説明では、マスタープラグインのタイプ固有のディスクリプタ、初期化関数および初期化解除関数について記述していますが、スレーブプラグインにも同様に当てはまります。
        </p><p>
          マスターの一般ディスクリプタの <code class="literal">semi_sync_master_plugin</code> メンバーは、タイプ固有のディスクリプタを指しており、これはタイプ固有の API バージョン番号のみで構成されています。
        </p><pre class="programlisting">
struct Mysql_replication semi_sync_master_plugin= {
  MYSQL_REPLICATION_INTERFACE_VERSION
};
</pre><p>
          初期化関数および初期化解除関数の宣言は、次のようになります。
        </p><pre class="programlisting">
static int semi_sync_master_plugin_init(void *p);
static int semi_sync_master_plugin_deinit(void *p);
</pre><p>
          初期化関数はポインタを使用して、トランザクションおよびバイナリロギングの<span class="quote">「<span class="quote">オブザーバー</span>」</span>をサーバーに登録します。初期化が成功したあとに、サーバーは適切な時期にオブザーバーを呼び出します。(オブザーバーについては、ソースファイルを参照してください。)初期化解除関数は、オブザーバーを登録解除することによってクリーンアップ処理を実行します。各関数は、成功した場合は 0、およびエラーが発生した場合は 1 を返します。
        </p><p>
          プラグインライブラリのオブジェクトファイルをコンパイルおよびインストールするには、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>の手順を使用します。ライブラリファイルを使用するには、ライブラリファイルがプラグインディレクトリ (<code class="literal">plugin_dir</code> システム変数で指定されているディレクトリ) にインストールされている必要があります。<code class="literal">rpl_semi_sync_master</code> プラグインおよび <code class="literal">rpl_semi_sync_slave</code> プラグインの場合、これらはソースから MySQL をビルドするときにコンパイルおよびインストールされます。これらはバイナリ配布にも含まれています。ビルド処理では、<code class="filename">semisync_master.so</code> および <code class="filename">semisync_slave.so</code> という名前の共有オブジェクトライブラリが生成されます (サフィクスはプラットフォームによって異なる場合があります)。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-audit-plugins"></a>24.2.4.8 監査プラグインの作成</h4></div></div></div><p>
          このセクションでは、MySQL ソース配布の <code class="literal">plugin/audit_null</code> ディレクトリにあるプラグインの例を使用して、監査サーバープラグインを作成する方法について説明します。このディレクトリにある <code class="filename">audit_null.c</code> ソースファイルは、<code class="literal">NULL_AUDIT</code> という名前の簡単な監査プラグインの例を実装します。
        </p><p>
          サーバー内では、プラガブルな監査インタフェースは MySQL ソース配布の <code class="filename">sql</code> ディレクトリの <code class="filename">sql_audit.h</code> ファイルおよび <code class="filename">sql_audit.cc</code> ファイル内に実装されています。また、サーバー内のいくつかの場所は、監査可能なイベントが発生したときに監査インタフェースを呼び出すように変更されているため、登録された監査プラグインは必要に応じてイベントに関する通知を受けることができます。そのような呼び出しが行われる場所を確認するには、<code class="filename">mysql_audit_<em class="replaceable"><code>xxx</code></em>()</code> という形式の名前を持つ関数の呼び出しを探してください。監査通知は、次のようなサーバーの動作に対して発生します。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              一般クエリーログへのメッセージの書き込み (ログが有効にされている場合)
            </p></li><li class="listitem"><p>
              エラーログへのメッセージの書き込み
            </p></li><li class="listitem"><p>
              クライアントへのクエリー結果の送信
            </p></li><li class="listitem"><p>
              クライアントの接続イベントおよび接続解除イベント
            </p></li></ul></div><p>
          監査プラグインを作成するには、プラグインのソースファイルに次のヘッダーファイルをインクルードします。プラグインの機能および要件によっては、ほかの MySQL のヘッダーファイルまたは一般的なヘッダーファイルが必要になることもあります。
        </p><pre class="programlisting">
#include &lt;mysql/plugin_audit.h&gt;
</pre><p>
          <code class="filename">plugin_audit.h</code> は <code class="filename">plugin.h</code> をインクルードするため、後者のファイルを明示的にインクルードする必要はありません。<code class="filename">plugin.h</code> は <code class="literal">MYSQL_AUDIT_PLUGIN</code> サーバープラグインタイプおよびプラグインを宣言するために必要なデータ構造体を定義します。<code class="filename">plugin_audit.h</code> は、監査プラグインに固有のデータ構造体を定義します。
        </p><p>
          監査プラグインには、ほかの MySQL サーバープラグインと同様に、一般プラグインディスクリプタがあります (<a class="xref" href="extending-mysql.html#server-plugin-descriptors" title="24.2.4.2.1 サーバープラグインライブラリおよびプラグインディスクリプタ">セクション24.2.4.2.1「サーバープラグインライブラリおよびプラグインディスクリプタ」</a>を参照してください)。<code class="filename">audit_null.c</code> では、一般ディスクリプタは次のようになります。
        </p><pre class="programlisting">
mysql_declare_plugin(audit_null)
{
  MYSQL_AUDIT_PLUGIN,         /* type                            */
  &amp;audit_null_descriptor,     /* descriptor                      */
  "NULL_AUDIT",               /* name                            */
  "Oracle Corp",              /* author                          */
  "Simple NULL Audit",        /* description                     */
  PLUGIN_LICENSE_GPL,
  audit_null_plugin_init,     /* init function (when loaded)     */
  audit_null_plugin_deinit,   /* deinit function (when unloaded) */
  0x0003,                     /* version                         */
  simple_status,              /* status variables                */
  NULL,                       /* system variables                */
  NULL,
  0,
}
mysql_declare_plugin_end;
</pre><p>
          <code class="literal">name</code> メンバー (<code class="literal">NULL_AUDIT</code>) は、<code class="literal">INSTALL PLUGIN</code>、<code class="literal">UNINSTALL PLUGIN</code> などのステートメントでプラグインを参照するために使用する名前を指定します。これは <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> または <code class="literal">SHOW PLUGINS</code> によって表示される名前でもあります。
        </p><p>
          一般ディスクリプタは、<code class="literal">SHOW STATUS</code> ステートメントに対して各種のステータス変数を公開する構造体である <code class="literal">simple_status</code> も参照しています。
        </p><pre class="programlisting">
static struct st_mysql_show_var simple_status[]=
{
  { "Audit_null_called",
    (char *) &amp;number_of_calls,
    SHOW_INT },
  { "Audit_null_general_log",
    (char *) &amp;number_of_calls_general_log,
    SHOW_INT },
  { "Audit_null_general_error",
    (char *) &amp;number_of_calls_general_error,
    SHOW_INT },
  { "Audit_null_general_result",
    (char *) &amp;number_of_calls_general_result,
    SHOW_INT },
  { "Audit_null_general_status",
    (char *) &amp;number_of_calls_general_status,
    SHOW_INT },
  { "Audit_null_connection_connect",
    (char *) &amp;number_of_calls_connection_connect,
    SHOW_INT },
  { "Audit_null_connection_disconnect",
    (char *) &amp;number_of_calls_connection_disconnect,
    SHOW_INT },
  { "Audit_null_connection_change_user",
    (char *) &amp;number_of_calls_connection_change_user,
    SHOW_INT },
  { 0, 0, 0}
};
</pre><p>
          <code class="literal">audit_null_plugin_init</code> 初期化関数は、プラグインがロードされたときにステータス変数をゼロに設定します。<code class="literal">audit_null_plugin_deinit</code> 関数は、プラグインがアンロードされるときにクリーンアップ処理を実行します。プラグインは動作中に、通知を受け取るたびに最初のステータス変数を増分します。また、イベントクラスおよびサブクラスに応じてほかのものも増分します。つまり、最初の変数はイベントサブクラスのカウントの総計となります。
        </p><p>
          一般ディスクリプタの <code class="literal">audit_null_descriptor</code> 値は、タイプ固有のディスクリプタを指しています。監査プラグインの場合、このディスクリプタの構造体は次のようになります。
        </p><pre class="programlisting">
struct st_mysql_audit
{
  int interface_version;
  void (*release_thd)(MYSQL_THD);
  void (*event_notify)(MYSQL_THD, unsigned int, const void *);
  unsigned long class_mask[MYSQL_AUDIT_CLASS_MASK_SIZE];
};
</pre><p>
          タイプ固有のディスクリプタには次のメンバーがあります。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">interface_version</code>: 規則により、タイプ固有のプラグインディスクリプタは、特定のプラグインタイプのインタフェースバージョンで始まります。サーバーはプラグインをロードするときに <code class="literal">interface_version</code> を検査し、プラグインと互換性があるかどうかを確認します。監査プラグインの場合、<code class="literal">interface_version</code> メンバーの値は <code class="literal">MYSQL_AUDIT_INTERFACE_VERSION</code> (<code class="literal">plugin_audit.h</code> に定義されています) です。
            </p></li><li class="listitem"><p>
              <code class="literal">release_thd</code>: スレッドコンテキストとの関連付けが解除されていることをプラグインに通知するためにサーバーが呼び出す関数。そのような関数がない場合は、<code class="literal">NULL</code> を設定します。
            </p></li><li class="listitem"><p>
              <code class="literal">event_notify</code>: 監査可能イベントが発生したことをプラグインに通知するためにサーバーが呼び出す関数。この関数は <code class="literal">NULL</code> にはできません。監査が行われなくては意味がないためです。
            </p></li><li class="listitem"><p>
              <code class="literal">class_mask</code>: プラグインが通知を受け取るイベントクラスを示すビットマスク。この値が 0 の場合、サーバーはプラグインにイベントを渡しません。
            </p></li></ul></div><p>
          サーバーは <code class="literal">event_notify</code> 関数および <code class="literal">release_thd</code> 関数を一緒に使用します。これらは特定のスレッドのコンテキストで呼び出され、スレッドはいくつかのイベント通知が生成されるアクティビティーを実行する場合があります。サーバーは、スレッドに対して <code class="literal">event_notify</code> を最初に呼び出しすときに、プラグインからスレッドへのバインドを作成します。このバインドが存在する間はプラグインをアンインストールできません。スレッドに対してイベントが発生しなくなると、サーバーは <code class="literal">release_thd</code> 関数を呼び出すことによってプラグインにこれを通知してからバインドを破棄します。たとえば、クライアントがステートメントを発行したとき、ステートメントを処理するスレッドは、ステートメントによって生成された結果セットとログに記録されたステートメントについて、監査プラグインに通知することがあります。これらの通知が実行されたあと、クライアントが別のステートメントを発行するまでの間、サーバーはスレッドをスリープ状態にする前にプラグインを解放します。
        </p><p>
          この設計により、プラグインは <code class="literal">event_notify</code> 関数への最初の呼び出しで対象となるスレッドに必要なリソースを割り当て、<code class="literal">release_thd</code> 関数でリソースを解放します。
        </p><pre class="programlisting">
event_notify function:
  if memory is needed to service the thread
    allocate memory
  ... rest of notification processing ...

release_thd function:
  if memory was allocated
    release memory
  ... rest of release processing ...
</pre><p>
          これは、通知関数でメモリーの割り当てと解放を繰り返すよりも効率的です。
        </p><p>
          <code class="literal">NULL_AUDIT</code> 監査プラグインの例では、タイプ固有のディスクリプタは次のようになります。
        </p><pre class="programlisting">
static struct st_mysql_audit audit_null_descriptor=
{
  MYSQL_AUDIT_INTERFACE_VERSION,                    /* interface version    */
  NULL,                                             /* release_thd function */
  audit_null_notify,                                /* notify function      */
  { (unsigned long) MYSQL_AUDIT_GENERAL_CLASSMASK |
                    MYSQL_AUDIT_CONNECTION_CLASSMASK } /* class mask        */
};
</pre><p>
          サーバーは <code class="literal">audit_null_notify</code> を呼び出して監査イベント情報をプラグインに渡します。<code class="literal">release_thd</code> 関数はありません。
        </p><p>
          イベントクラスマスクは、<span class="quote">「<span class="quote">general</span>」</span>クラスおよび<span class="quote">「<span class="quote">connection</span>」</span>クラスのすべてのイベントを対象とすることを示しています。<code class="filename">plugin_audit.h</code> は、これらのクラスとそれらに対応するクラスマスクのシンボルを定義しています。
        </p><pre class="programlisting">
#define MYSQL_AUDIT_GENERAL_CLASS 0
#define MYSQL_AUDIT_GENERAL_CLASSMASK (1 &lt;&lt; MYSQL_AUDIT_GENERAL_CLASS)

#define MYSQL_AUDIT_CONNECTION_CLASS 1
#define MYSQL_AUDIT_CONNECTION_CLASSMASK (1 &lt;&lt; MYSQL_AUDIT_CONNECTION_CLASS)
</pre><p>
          タイプ固有のディスクリプタでは、<code class="literal">event_notify</code> 関数プロトタイプの 2 番目と 3 番目のパラメータは、イベントクラス、およびイベント構造体への一般的なポインタを表しています。
        </p><pre class="programlisting">
void (*event_notify)(MYSQL_THD, unsigned int, const void *);
</pre><p>
          異なるクラスのイベントは異なる構造体を持つ場合があるため、通知関数はイベントクラス値を使用して、イベント構造へのポインタを解釈する方法を判断します。
        </p><p>
          イベントクラスが <code class="literal">MYSQL_AUDIT_GENERAL_CLASS</code> である通知関数をサーバーが呼び出す場合、サーバーは <code class="literal">mysql_event_general</code> 構造へのポインタとしてイベント構造体を渡します。
        </p><pre class="programlisting">
struct mysql_event_general
{
  unsigned int event_subclass;
  int general_error_code;
  unsigned long general_thread_id;
  const char *general_user;
  unsigned int general_user_length;
  const char *general_command;
  unsigned int general_command_length;
  const char *general_query;
  unsigned int general_query_length;
  struct charset_info_st *general_charset;
  unsigned long long general_time;
  unsigned long long general_rows;
};
</pre><p>
          監査プラグインは <code class="literal">mysql_event_general</code> メンバーを次のように解釈できます。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">event_subclass</code>: 次のいずれかの値を持つイベントサブクラス。
            </p><pre class="programlisting">
#define MYSQL_AUDIT_GENERAL_LOG 0
#define MYSQL_AUDIT_GENERAL_ERROR 1
#define MYSQL_AUDIT_GENERAL_RESULT 2
#define MYSQL_AUDIT_GENERAL_STATUS 3
</pre></li><li class="listitem"><p>
              <code class="literal">general_error_code</code>: エラーコード。これは <code class="literal">mysql_errno()</code> C API 関数によって返されるものと似た値であり、0 は<span class="quote">「<span class="quote">エラーなし</span>」</span>を意味します。
            </p></li><li class="listitem"><p>
              <code class="literal">general_thread_id</code>: イベントが発生したスレッドの ID。
            </p></li><li class="listitem"><p>
              <code class="literal">general_user</code>: イベントの現在のユーザー。
            </p></li><li class="listitem"><p>
              <code class="literal">general_user_length</code>: <code class="literal">general_user</code> のバイト単位の長さ。
            </p></li><li class="listitem"><p>
              <code class="literal">general_command</code>: 一般クエリーログイベントの場合、操作の種類。たとえば、<code class="literal">Connect</code>、<code class="literal">Query</code>、<code class="literal">Shutdown</code> です。エラーログイベントの場合、エラーメッセージ。これは <code class="literal">mysql_error()</code> C API 関数によって返されるものと似た値であり、空の文字列は<span class="quote">「<span class="quote">エラーなし</span>」</span>を意味します。結果イベントの場合、これは空です。
            </p></li><li class="listitem"><p>
              <code class="literal">general_command_length</code>: <code class="literal">general_command</code> のバイト単位の長さ。
            </p></li><li class="listitem"><p>
              <code class="literal">general_query</code>: ログに記録されたか結果を生成した SQL ステートメント。
            </p></li><li class="listitem"><p>
              <code class="literal">general_query_length</code>: <code class="literal">general_query</code> のバイト単位の長さ。
            </p></li><li class="listitem"><p>
              <code class="literal">general_charset</code>: イベントの文字セット情報。
            </p></li><li class="listitem"><p>
              <code class="literal">general_time</code>: 通知関数が呼び出された直前の時間を示す <code class="literal">TIMESTAMP</code> 値。
            </p></li><li class="listitem"><p>
              <code class="literal">general_rows</code>: 一般クエリーログイベントの場合、ゼロ。エラーログイベントの場合、エラーが発生した行番号。結果イベントの場合、結果の行数に 1 を加えた数値。結果セットを生成しないステートメントの場合、値は 0 です。このエンコードによって、結果セットを生成しないステートメントを、空の結果セットを生成するステートメントと区別できます。たとえば、<code class="literal">DELETE</code> ステートメントの場合、この値は 0 です。<code class="literal">SELECT</code> の場合、結果は常に 1 以上であり、1 は空の結果セットを表します。
            </p></li><li class="listitem"><p>
              <code class="literal">general_host</code>: 一般クエリーログイベントの場合、クライアントのホスト名を表す文字列。
            </p></li><li class="listitem"><p>
              <code class="literal">general_sql_command</code>: 一般クエリーログイベントの場合、<code class="literal">connect</code>、<code class="literal">drop_table</code> などの実行されるアクションの種類を示す文字列。
            </p></li><li class="listitem"><p>
              <code class="literal">general_external_user</code>: 一般クエリーログイベントの場合、外部ユーザーを表す文字列 (ない場合は空)。
            </p></li><li class="listitem"><p>
              <code class="literal">general_ip</code>: 一般クエリーログイベントの場合、クライアントの IP アドレスを表す文字列。
            </p></li></ul></div><p>
          <code class="literal">general_host</code>、<code class="literal">general_sql_command</code>、<code class="literal">general_external_user</code>、および <code class="literal">general_ip</code> メンバーは、MySQL 5.6.14 で新しく導入されました。これらは、文字列とその長さがペアになった <code class="literal">MYSQL_LEX_STRING</code> 構造体です。たとえば、<code class="literal">event_general</code> が一般イベントへのポインタである場合、次のようにして <code class="literal">general_host</code> 値のメンバーにアクセスできます。
        </p><pre class="programlisting">
event_general-&gt;general_host.length
event_general-&gt;general_host.str
</pre><p>
          イベントクラスが <code class="literal">MYSQL_AUDIT_CONNECTION_CLASS</code> である通知関数をサーバーが呼び出す場合、サーバーは <code class="literal">mysql_event_connection</code> 構造へのポインタとしてイベント構造体を渡します。これは <code class="literal">mysql_event_general</code> 構造と似ており、ほぼ同じように解釈されます。
        </p><p>
          <code class="literal">NULL_AUDIT</code> プラグインの通知関数はきわめて単純です。これは、グローバルイベントカウンタを増分して、イベントクラスを判別し、イベントサブクラスを参照して増分するサブクラスカウンタを判別します。
        </p><pre class="programlisting">
static void audit_null_notify(MYSQL_THD thd __attribute__((unused)),
                              unsigned int event_class,
                              const void *event)
{
  /* prone to races, oh well */
  number_of_calls++;
  if (event_class == MYSQL_AUDIT_GENERAL_CLASS)
  {
    const struct mysql_event_general *event_general=
      (const struct mysql_event_general *) event;
    switch (event_general-&gt;event_subclass)
    {
    case MYSQL_AUDIT_GENERAL_LOG:
      number_of_calls_general_log++;
      break;
    case MYSQL_AUDIT_GENERAL_ERROR:
      number_of_calls_general_error++;
      break;
    case MYSQL_AUDIT_GENERAL_RESULT:
      number_of_calls_general_result++;
      break;
    case MYSQL_AUDIT_GENERAL_STATUS:
      number_of_calls_general_status++;
      break;
    default:
      break;
    }
  }
  else if (event_class == MYSQL_AUDIT_CONNECTION_CLASS)
  {
    const struct mysql_event_connection *event_connection=
      (const struct mysql_event_connection *) event;
    switch (event_connection-&gt;event_subclass)
    {
    case MYSQL_AUDIT_CONNECTION_CONNECT:
      number_of_calls_connection_connect++;
      break;
    case MYSQL_AUDIT_CONNECTION_DISCONNECT:
      number_of_calls_connection_disconnect++;
      break;
    case MYSQL_AUDIT_CONNECTION_CHANGE_USER:
      number_of_calls_connection_change_user++;
      break;
    default:
      break;
    }
  }
}
</pre><p>
          プラグインライブラリのオブジェクトファイルをコンパイルおよびインストールするには、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>の手順を使用します。ライブラリファイルを使用するには、ライブラリファイルがプラグインディレクトリ (<code class="literal">plugin_dir</code> システム変数で指定されているディレクトリ) にインストールされている必要があります。<code class="literal">AUDIT_NULL</code> プラグインの場合、ソースから MySQL をビルドするときにコンパイルおよびインストールされます。これはバイナリ配布にも含められます。ビルド処理では、<code class="filename">adt_null.so</code> という名前の共有オブジェクトライブラリが生成されます (サフィクスはプラットフォームによって異なる場合があります)。
        </p><p>
          プラグインを実行時に登録するには、次のステートメントを使用します (必要に応じてサフィクスを変更します)。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>INSTALL PLUGIN NULL_AUDIT SONAME 'adt_null.so';</code></strong>
</pre><p>
          プラグインのロードについての追加情報は、<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>を参照してください。
        </p><p>
          プラグインのインストールを検証するには、<code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルを調査するか、<code class="literal">SHOW PLUGINS</code> ステートメントを使用します。
        </p><p>
          監査プラグインがインストールされている間、監査プラグインはプラグインが呼び出されたイベントを示すステータス変数を公開します。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SHOW STATUS LIKE 'Audit_null%';</code></strong>
+-----------------------------------+-------+
| Variable_name                     | Value |
+-----------------------------------+-------+
| Audit_null_called                 | 1388  |
| Audit_null_connection_change_user | 0     |
| Audit_null_connection_connect     | 22    |
| Audit_null_connection_disconnect  | 21    |
| Audit_null_general_error          | 1     |
| Audit_null_general_log            | 513   |
| Audit_null_general_result         | 415   |
| Audit_null_general_status         | 416   |
+-----------------------------------+-------+
</pre><p>
          <code class="literal">Audit_null_called</code> はすべてのイベントをカウントし、ほかの変数はイベントサブクラスのインスタンスをカウントします。たとえば、上記の <code class="literal">SHOW STATUS</code> ステートメントによって、サーバーは結果をクライアントに送信し、ログが有効にされている場合は一般クエリーログにメッセージを書き込みます。このため、クライアントがステートメントを繰り返し発行すると、<code class="literal">Audit_null_called</code> および <code class="literal">Audit_null_general_result</code> が毎回増分され、ログが有効にされている場合は <code class="literal">Audit_null_general_log</code> が増分されます。
        </p><p>
          プラグインをテスト後に無効にするには、次のステートメントを使用してプラグインをアンロードします。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>UNINSTALL PLUGIN NULL_AUDIT;</code></strong>
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-authentication-plugins"></a>24.2.4.9 認証プラグインの作成</h4></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#writing-authentication-plugins-server-side">24.2.4.9.1 サーバー側認証プラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-authentication-plugins-client-side">24.2.4.9.2 クライアント側認証プラグインの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-authentication-plugins-setup">24.2.4.9.3 認証プラグインの使用</a></span></dt><dt><span class="section"><a href="extending-mysql.html#writing-authentication-plugins-proxy-users">24.2.4.9.4 認証プラグインでのプロキシユーザーサポートの実装</a></span></dt></dl></div><p>
          MySQL ではプラガブルな認証がサポートされており、プラグインはクライアント接続を認証するために呼び出されます。認証プラグインを使用すると、<code class="literal">mysql.user</code> テーブルに格納されているパスワードによる組み込み方式ではない認証方式を使用できます。たとえば、外部認証方式にアクセスするプラグインを作成できます。また、認証プラグインはプロキシユーザー機能をサポートできるため、接続するユーザーを別のユーザーのプロキシにして、(アクセス制御のために) 別のユーザーの権限を持つユーザーとして扱うことが可能になります。詳細は、<a class="xref" href="security.html#pluggable-authentication" title="6.3.7 プラガブル認証">セクション6.3.7「プラガブル認証」</a>および<a class="xref" href="security.html#proxy-users" title="6.3.9 プロキシユーザー">セクション6.3.9「プロキシユーザー」</a>を参照してください。
        </p><p>
          認証プラグインでは、サーバー側およびクライアント側のプラグインを作成します。サーバー側プラグインは、全文パーサープラグイン、監査プラグインなどのほかの種類のサーバープラグインで使用されるものと同じプラグイン API を使用します (ただし、タイプ固有のディスクリプタは異なります)。クライアント側プラグインはクライアントプラグイン API を使用します。
        </p><p>
          いくつかのヘッダーファイルに、認証プラグインに関する情報が格納されています。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="filename">plugin.h</code>: <code class="literal">MYSQL_AUTHENTICATION_PLUGIN</code> サーバープラグインタイプを定義します。
            </p></li><li class="listitem"><p>
              <code class="filename">client_plugin.h</code>: クライアントプラグインの API を定義します。これには、クライアントプラグインディスクリプタ、およびクライアントプラグイン C API を呼び出すための関数プロトタイプが含まれます (<a class="xref" href="connectors-apis.html#c-api-plugin-functions" title="23.8.14 C API クライアントプラグイン関数">セクション23.8.14「C API クライアントプラグイン関数」</a>を参照してください)。
            </p></li><li class="listitem"><p>
              <code class="filename">plugin_auth.h</code>: 認証プラグインに固有のサーバープラグイン API の一部を定義します。これにはサーバー側認証プラグインのタイプ固有のディスクリプタと <code class="literal">MYSQL_SERVER_AUTH_INFO</code> 構造体が含まれます。
            </p></li><li class="listitem"><p>
              <code class="filename">plugin_auth_common.h</code>: クライアント認証プラグインとサーバー認証プラグインの共通要素が格納されます。これには戻り値の定義と <code class="literal">MYSQL_PLUGIN_VIO</code> 構造体が含まれます。
            </p></li></ul></div><p>
          認証プラグインを作成するには、プラグインのソースファイルに次のヘッダーファイルをインクルードします。プラグインの機能および要件によっては、ほかの MySQL のヘッダーファイルまたは一般的なヘッダーファイルが必要になることもあります。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              サーバー認証プラグインを実装するソースファイルの場合、次のファイルをインクルードします。
            </p><pre class="programlisting">
#include &lt;mysql/plugin_auth.h&gt;
</pre></li><li class="listitem"><p>
              クライアント認証プラグインを実装するか、クライアントプラグインとサーバープラグインの両方を実装するソースファイルの場合、次のファイルをインクルードします。
            </p><pre class="programlisting">
#include &lt;mysql/plugin_auth.h&gt;
#include &lt;mysql/client_plugin.h&gt;
#include &lt;mysql.h&gt;
</pre></li></ul></div><p>
          <code class="filename">plugin_auth.h</code> は <code class="filename">plugin.h</code> および <code class="filename">plugin_auth_common.h</code> をインクルードするため、後者のファイルを明示的にインクルードする必要はありません。
        </p><p>
          このセクションでは、連係して動作するサーバー認証プラグインとクライアント認証プラグインのペアを作成する方法について説明します。
        </p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">警告</div><p>
            これらのプラグインは空でないあらゆるパスワードを受け入れ、パスワードは平文で送信されます。これは安全でないため、このプラグインは<span class="emphasis"><em>本番環境で使用しないでください</em></span>。
          </p></div><p>
          ここで作成するサーバー側プラグインおよびクライアント側プラグインの名前は、両方とも <code class="literal">auth_simple</code> です。<a class="xref" href="extending-mysql.html#plugin-data-structures" title="24.2.4.2 プラグインのデータ構造体">セクション24.2.4.2「プラグインのデータ構造体」</a>で説明したように、プラグインライブラリファイルはクライアントプラグインと同じベース名を持つ必要があるため、ソースファイル名は <code class="filename">auth_simple.c</code> であり、<code class="filename">auth_simple.so</code> という名前のライブラリが生成されます (システムで、ライブラリファイルのサフィクスとして <code class="filename">.so</code> が使用されていることを想定しています)。
        </p><p>
          MySQL ソース配布では、認証プラグインのソースが <code class="filename">plugin/auth</code> ディレクトリにあり、ほかの認証プラグインを作成するときのガイドとして参考にできます。また、組み込み認証プラグインが実装される方法を確認するには、MySQL サーバーに組み込まれるプラグインについては <code class="filename">sql/sql_acl.cc</code>、および<code class="literal">libmysqlclient</code> クライアントライブラリに組み込まれるプラグインについては <code class="filename">sql-common/client.c</code> を参照してください。(組み込みクライアントプラグインの場合、使用される <code class="literal">auth_plugin_t</code> 構造体は、通常のクライアントプラグイン宣言マクロで使用される構造と異なります。特に、最初の 2 つのメンバーは、宣言マクロによって設定されるのではなく、明示的に指定されています。)
        </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="writing-authentication-plugins-server-side"></a>24.2.4.9.1 サーバー側認証プラグインの作成</h5></div></div></div><p>
            すべてのサーバープラグインタイプに使用される通常の一般ディスクリプタ形式を使用して、サーバー側プラグインを宣言します (<a class="xref" href="extending-mysql.html#server-plugin-descriptors" title="24.2.4.2.1 サーバープラグインライブラリおよびプラグインディスクリプタ">セクション24.2.4.2.1「サーバープラグインライブラリおよびプラグインディスクリプタ」</a>を参照してください)。<code class="literal">auth_simple</code> プラグインの場合、ディスクリプタは次のようになります。
          </p><pre class="programlisting">
mysql_declare_plugin(auth_simple)
{
  MYSQL_AUTHENTICATION_PLUGIN,
  &amp;auth_simple_handler,                 /* type-specific descriptor */
  "auth_simple",                        /* plugin name */
  "Author Name",                        /* author */
  "Any-password authentication plugin", /* description */
  PLUGIN_LICENSE_GPL,                   /* license type */
  NULL,                                 /* no init function */
  NULL,                                 /* no deinit function */
  0x0100,                               /* version = 1.0 */
  NULL,                                 /* no status variables */
  NULL,                                 /* no system variables */
  NULL,                                 /* no reserved information */
  0                                     /* no flags */
}
mysql_declare_plugin_end;
</pre><p>
            <code class="literal">name</code> メンバー (<code class="literal">auth_simple</code>) は、<code class="literal">INSTALL PLUGIN</code>、<code class="literal">UNINSTALL PLUGIN</code> などのステートメントでプラグインを参照するために使用する名前を指定します。これは、<code class="literal">SHOW PLUGINS</code> または <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> によって表示される名前でもあります。
          </p><p>
            一般ディスクリプタの <code class="literal">auth_simple_handler</code> メンバーはタイプ固有のディスクリプタを指しています。認証プラグインの場合、タイプ固有のディスクリプタは <code class="literal">st_mysql_auth</code> 構造体 (<code class="filename">plugin_auth.h</code> で定義されます) のインスタンスです。
          </p><pre class="programlisting">
struct st_mysql_auth
{
  int interface_version;
  const char *client_auth_plugin;
  int (*authenticate_user)(MYSQL_PLUGIN_VIO *vio, MYSQL_SERVER_AUTH_INFO *info);
};
</pre><p>
            <code class="literal">st_mysql_auth</code> 構造体には 3 つのメンバー (タイプ固有の API バージョン番号、クライアントプラグイン名、およびクライアントと通信するメインのプラグイン関数へのポインタ) があります。<code class="literal">client_auth_plugin</code> メンバーは、特定のプラグインが必要な場合にクライアントプラグインの名前を示すようにします。<code class="literal">NULL</code> 値は<span class="quote">「<span class="quote">任意のプラグイン</span>」</span>を意味します。後者の場合、クライアントは任意のプラグインを使用できます。これは、クライアントプラグイン、およびクライアントプラグインが送信するユーザー名またはパスワードが、サーバープラグインの処理に関与しない場合に役立ちます。たとえば、サーバープラグインがローカルのクライアントのみを認証し、クライアントプラグインによって送信される情報ではなくオペレーティングシステムのいくつかのプロパティーを使用する場合です。
          </p><p>
            <code class="literal">auth_simple</code> の場合、タイプ固有のディスクリプタは次のようになります。
          </p><pre class="programlisting">
static struct st_mysql_auth auth_simple_handler =
{
  MYSQL_AUTHENTICATION_INTERFACE_VERSION,
  "auth_simple",           /* required client-side plugin name */
  auth_simple_server       /* server-side plugin main function */
};
</pre><p>
            メインの関数は、I/O 構造体および <code class="literal">MYSQL_SERVER_AUTH_INFO</code> 構造体を表す 2 つの引数を受け取ります。この構造体の定義は <code class="filename">plugin_auth.h</code> にあります。これは次のような定義です。
          </p><a class="indexterm" name="idm139978997282064"></a><pre class="programlisting">
typedef struct st_mysql_server_auth_info
{
  char *user_name;
  unsigned int user_name_length;
  const char *auth_string;
  unsigned long auth_string_length;
  char authenticated_as[MYSQL_USERNAME_LENGTH+1]; 
  char external_user[512];
  int  password_used;
  const char *host_or_ip;
  unsigned int host_or_ip_length;
} MYSQL_SERVER_AUTH_INFO;
</pre><p>
            文字列メンバーの文字セットは UTF-8 です。文字列に関連付けられた <code class="literal">_length</code> メンバーがある場合、これはバイト単位の文字列の長さを示します。文字列も NULL で終わります。
          </p><p>
            サーバーによって認証プラグインが呼び出されると、<code class="literal">MYSQL_SERVER_AUTH_INFO</code> 構造体メンバーが次のように解釈されます。これらの一部は、説明されているようにクライアントセッション内の SQL 関数またはシステム変数の値を設定するために使用されます。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <code class="literal">user_name</code>: クライアントによって送信されたユーザー名。この値は <code class="literal">USER()</code> 関数の値になります。
              </p></li><li class="listitem"><p>
                <code class="literal">user_name_length</code>: <code class="literal">user_name</code> のバイト単位の長さ。
              </p></li><li class="listitem"><p>
                <code class="literal">auth_string</code>: <code class="literal">mysql.user</code> テーブルの一致するアカウント名の行 (つまり、クライアントユーザー名およびホスト名が一致し、クライアントを認証する方法を判別するためにサーバーによって使用される行) の <code class="literal">authentication_string</code> カラムの値。
              </p><p>
                次のステートメントを使用してアカウントを作成するとします。
              </p><pre class="programlisting">
CREATE USER 'my_user'@'localhost'
  IDENTIFIED WITH my_plugin AS 'my_auth_string';
</pre><p>
                <code class="literal">my_user</code> がローカルホストから接続する場合、サーバーは <code class="literal">my_plugin</code> を呼び出し、<code class="literal">'my_auth_string'</code> を <code class="literal">auth_string</code> 値として渡します。
              </p></li><li class="listitem"><p>
                <code class="literal">auth_string_length</code>: <code class="literal">auth_string</code> のバイト単位の長さ。
              </p></li><li class="listitem"><p>
                <code class="literal">authenticated_as</code>: サーバーはこれをユーザー名 (<code class="literal">user_name</code> の値) に設定します。プラグインは、クライアントが別のユーザーの権限を持つことを示すように変更できます。たとえば、プラグインでプロキシユーザーがサポートされる場合、初期値は接続する (プロキシ) ユーザーの名前ですが、プラグインがこのメンバーをプロキシ設定されているユーザー名に変更できます。その後、サーバーはプロキシ設定されているユーザーの権限を持つものとしてプロキシユーザーを扱います (プロキシユーザーのサポートのためのほかの条件が満たされていることを想定しています。<a class="xref" href="extending-mysql.html#writing-authentication-plugins-proxy-users" title="24.2.4.9.4 認証プラグインでのプロキシユーザーサポートの実装">セクション24.2.4.9.4「認証プラグインでのプロキシユーザーサポートの実装」</a>を参照してください)。この値は、最大 <code class="literal">MYSQL_USER_NAME_LENGTH</code> バイトの長さを持つ文字列、および終端の NULL として表されます。この値は <code class="literal">CURRENT_USER()</code> 関数の値になります。
              </p></li><li class="listitem"><p>
                <code class="literal">external_user</code>: サーバーは空の文字列 (NULL で終わります) をこれに設定します。この値は <code class="literal">external_user</code> システム変数の値になります。プラグインでこのシステム変数が異なる値を持つようにするには、プラグインでそのようにこのメンバーを設定してください (たとえば、接続しているユーザー名を設定します)。この値は、最大 511 バイトの長さの文字列、および終端の NULL として表されます。
              </p></li><li class="listitem"><p>
                <code class="literal">password_used</code>: このメンバーは、認証に失敗したときに適用されます。プラグインは、これを設定するか、無視できます。この値は、<code class="literal">Authentication fails. Password used: %s</code> という失敗のエラーメッセージを作成するために使用されます。<code class="literal">password_used</code> の値によって、次の表に示すように、<code class="literal">%s</code> の処理方法が決まります。
              </p><div class="informaltable"><table summary="この表は、password_used メンバーの値を一覧表示し、Authentication fails. Password used: %s メッセージの作成で値が処理される方法を示しています。" border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col"><code class="literal">password_used</code></th><th scope="col"><code class="literal">%s</code> の処理</th></tr></thead><tbody><tr><td scope="row">0</td><td>行わない</td></tr><tr><td scope="row">1</td><td>行う</td></tr><tr><td scope="row">2</td><td><code class="literal">%s</code> がない</td></tr></tbody></table></div></li><li class="listitem"><p>
                <code class="literal">host_or_ip</code>: 解決できる場合はクライアントのホスト名、または解決できない場合は IP アドレス。
              </p></li><li class="listitem"><p>
                <code class="literal">host_or_ip_length</code>: <code class="literal">host_or_ip</code> のバイト単位の長さ。
              </p></li></ul></div><p>
            <code class="literal">auth_simple</code> のメイン関数 <code class="literal">auth_simple_server()</code> は、クライアントからパスワード (NULL で終了する文字列) を読み取り、パスワードが空でない (先頭バイトが NULL でない) 場合に成功します。
          </p><pre class="programlisting">
static int auth_simple_server (MYSQL_PLUGIN_VIO *vio,
                               MYSQL_SERVER_AUTH_INFO *info)
{
  unsigned char *pkt;
  int pkt_len;

  /* read the password as null-terminated string, fail on error */
  if ((pkt_len= vio-&gt;read_packet(vio, &amp;pkt)) &lt; 0)
    return CR_ERROR;

  /* fail on empty password */
  if (!pkt_len || *pkt == '\0')
  {
    info-&gt;password_used= PASSWORD_USED_NO;
    return CR_ERROR;
  }

  /* accept any nonempty password */
  info-&gt;password_used= PASSWORD_USED_YES;

  return CR_OK;
}
</pre><p>
            メイン関数は、次の表に示すいずれかのエラーコードを返します。
          </p><div class="informaltable"><table summary="この表は、auth_simple のメイン関数 auth_simple_server() のエラーコードを一覧表示し、各エラーコードの意味を示しています。" border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">エラーコード</th><th scope="col">意味</th></tr></thead><tbody><tr><td scope="row"><code class="literal">CR_OK</code></td><td>成功</td></tr><tr><td scope="row"><code class="literal">CR_OK_HANDSHAKE_COMPLETE</code></td><td>ステータスパケットをクライアントに送信しない</td></tr><tr><td scope="row"><code class="literal">CR_ERROR</code></td><td>エラー</td></tr><tr><td scope="row"><code class="literal">CR_AUTH_USER_CREDENTIALS</code></td><td>認証エラー</td></tr><tr><td scope="row"><code class="literal">CR_AUTH_HANDSHAKE</code></td><td>認証ハンドシェイクエラー</td></tr><tr><td scope="row"><code class="literal">CR_AUTH_PLUGIN_ERROR</code></td><td>内部プラグインエラー</td></tr></tbody></table></div><p>
            ハンドシェイクが動作する方法の例については、<code class="filename">plugin/auth/dialog.c</code> ソースファイルを参照してください。
          </p><p>
            <code class="literal">CR_ERROR</code> に続くエラーコードは MySQL 5.6.5 から使用できます。サーバーは、MySQL 5.6.5 以降で使用可能なパフォーマンススキーマ <code class="literal">host_cache</code> テーブル内のプラグインエラーをカウントします。
          </p><p>
            <code class="literal">auth_simple_server_main()</code> は非常に基本的なものであるため、パスワードを受け取ったかどうかを示すメンバーを設定することを除き、認証情報構造体を使用しません。
          </p><p>
            プロキシユーザーをサポートするプラグインは、プロキシ設定されているユーザー (クライアントユーザーが取得する権限を持っている MySQL ユーザー) の名前をサーバーに返す必要があります。これを行うには、プラグインはプロキシ設定されているユーザー名を <code class="literal">info-&gt;authenticated_as</code> メンバーに設定する必要があります。プロキシ設定については、<a class="xref" href="security.html#proxy-users" title="6.3.9 プロキシユーザー">セクション6.3.9「プロキシユーザー」</a>および<a class="xref" href="extending-mysql.html#writing-authentication-plugins-proxy-users" title="24.2.4.9.4 認証プラグインでのプロキシユーザーサポートの実装">セクション24.2.4.9.4「認証プラグインでのプロキシユーザーサポートの実装」</a>を参照してください。
          </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="writing-authentication-plugins-client-side"></a>24.2.4.9.2 クライアント側認証プラグインの作成</h5></div></div></div><p>
            <code class="literal">mysql_declare_client_plugin()</code> マクロおよび <code class="literal">mysql_end_client_plugin</code> マクロを使用して、クライアント側プラグインディスクリプタを宣言します (<a class="xref" href="extending-mysql.html#client-plugin-descriptors" title="24.2.4.2.3 クライアントプラグインディスクリプタ">セクション24.2.4.2.3「クライアントプラグインディスクリプタ」</a>を参照してください)。<code class="literal">auth_simple</code> プラグインの場合、ディスクリプタは次のようになります。
          </p><pre class="programlisting">
mysql_declare_client_plugin(AUTHENTICATION)
  "auth_simple",                        /* plugin name */
  "Author Name",                        /* author */
  "Any-password authentication plugin", /* description */
  {1,0,0},                              /* version = 1.0.0 */
  "GPL",                                /* license type */
  NULL,                                 /* for internal use */
  NULL,                                 /* no init function */
  NULL,                                 /* no deinit function */
  NULL,                                 /* no option-handling function */
  auth_simple_client                    /* main function */
mysql_end_client_plugin;
</pre><p>
            プラグイン名からオプション処理関数までのディスクリプタメンバーは、すべてのクライアントプラグインタイプで共通しています。(説明については、<a class="xref" href="extending-mysql.html#client-plugin-descriptors" title="24.2.4.2.3 クライアントプラグインディスクリプタ">セクション24.2.4.2.3「クライアントプラグインディスクリプタ」</a>を参照してください。)共通メンバーに続いて、このディスクリプタには認証プラグインに固有の追加メンバーがあります。これは<span class="quote">「<span class="quote">メイン</span>」</span>の関数であり、サーバーとの通信を処理します。この関数は、I/O 構造体と接続ハンドラを表す 2 つの引数を取ります。任意のパスワードを指定できるこの単純なプラグインでは、メイン関数はユーザーが指定したパスワードをサーバーに書き込むだけです。
          </p><pre class="programlisting">
static int auth_simple_client (MYSQL_PLUGIN_VIO *vio, MYSQL *mysql)
{
  int res;

  /* send password as null-terminated string in clear text */
  res= vio-&gt;write_packet(vio, (const unsigned char *) mysql-&gt;passwd, 
                         strlen(mysql-&gt;passwd) + 1);

  return res ? CR_ERROR : CR_OK;
}
</pre><p>
            メイン関数は、次の表に示すいずれかのエラーコードを返します。
          </p><div class="informaltable"><table summary="この表は、認証のメイン関数のエラーコードを一覧表示し、各関数の意味を示しています。" border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">エラーコード</th><th scope="col">意味</th></tr></thead><tbody><tr><td scope="row"><code class="literal">CR_OK</code></td><td>成功</td></tr><tr><td scope="row"><code class="literal">CR_OK_HANDSHAKE_COMPLETE</code></td><td>成功、クライアント完了</td></tr><tr><td scope="row"><code class="literal">CR_ERROR</code></td><td>エラー</td></tr></tbody></table></div><p>
            <code class="literal">CR_OK_HANDSHAKE_COMPLETE</code> は、クライアントが自分の役割を正常に完了し、最後のパケットを読み取ったことを示します。認証プロトコルのラウンドトリップ数が事前に知られておらず、認証が完了したかどうかを判別するためにプラグインが別のパケットを読み取る必要がある場合、クライアントプラグインが <code class="literal">CR_OK_HANDSHAKE_COMPLETE</code> を返すことがあります。
          </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="writing-authentication-plugins-setup"></a>24.2.4.9.3 認証プラグインの使用</h5></div></div></div><p>
            プラグインライブラリのオブジェクトファイルをコンパイルおよびインストールするには、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>の手順を参照してください。ライブラリファイルを使用するには、ライブラリファイルがプラグインディレクトリ (<code class="literal">plugin_dir</code> システム変数で指定されているディレクトリ) にインストールされている必要があります。
          </p><p>
            サーバー側プラグインをサーバーに登録します。たとえば、プラグインをサーバー起動時にロードするには、<code class="option">--plugin-load=auth_simple.so</code> オプションを使用します (システムで必要な場合はライブラリサフィクスを変更します)。
          </p><p>
            サーバーが認証のために <code class="literal">auth_simple</code> プラグインを使用する対象となるユーザーを作成します。
          </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>CREATE USER 'x'@'localhost'</code></strong>
    -&gt; <strong class="userinput"><code>IDENTIFIED WITH auth_simple;</code></strong>
</pre><p>
            クライアントプログラムを使用して、ユーザー <code class="literal">x</code> としてサーバーに接続します。サーバー側の <code class="literal">auth_simple</code> プラグインはクライアント側の <code class="literal">auth_simple</code> プラグインを使用するクライアントプログラムと通信し、後者はサーバーにパスワードを送信します。サーバーは空のパスワードを送信する接続を拒否し、空ではないパスワードを送信する接続を受け入れます。これを検証するために、それぞれの方法でクライアントプログラムを起動します。
          </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>mysql --user=x --skip-password</code></strong>
ERROR 1045 (28000): Access denied for user 'x'@'localhost' (using password: NO)

shell&gt; <strong class="userinput"><code>mysql --user=x --password=abc</code></strong>
mysql&gt;
</pre><p>
            このサーバープラグインは空ではないパスワードをすべて受け入れるため、安全ではないとみなされます。プラグインをテストしてプラグインが機能することを検証したら、気づかずに安全でない認証プラグインがロードされたままの状態でサーバーが実行され続けないように、<code class="option">--plugin-load</code> オプションを指定せずにサーバーを再起動します。また、<code class="literal">DROP USER 'x'@'localhost'</code> を使用してユーザーを削除します。
          </p><p>
            認証プラグインのロードおよび使用に関する追加情報については、<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>および<a class="xref" href="security.html#pluggable-authentication" title="6.3.7 プラガブル認証">セクション6.3.7「プラガブル認証」</a>を参照してください。
          </p><p>
            認証プラグインの使用をサポートするクライアントプログラムを作成する場合、一般的にそのようなプログラムは、<code class="literal">mysql_options()</code> を呼び出して <code class="literal">MYSQL_DEFAULT_AUTH</code> オプションおよび <code class="literal">MYSQL_PLUGIN_DIR</code> オプションを設定することによって、プラグインをロードします。
          </p><pre class="programlisting">
char *plugin_dir = "<em class="replaceable"><code>path_to_plugin_dir</code></em>";
char *default_auth = "<em class="replaceable"><code>plugin_name</code></em>";

/* ... process command-line options ... */

mysql_options(&amp;mysql, MYSQL_PLUGIN_DIR, plugin_dir);
mysql_options(&amp;mysql, MYSQL_DEFAULT_AUTH, default_auth);
</pre><p>
            一般にプログラムは、ユーザーがデフォルト値をオーバーライドできるようにする <code class="option">--plugin-dir</code> および <code class="option">--default-auth</code> オプションも受け付けます。
          </p><p>
            クライアントプログラムで低レベルのプラグイン管理が必要である場合は、クライアントライブラリに <code class="literal">st_mysql_client_plugin</code> 引数を受け取る関数を含めます。<a class="xref" href="connectors-apis.html#c-api-plugin-functions" title="23.8.14 C API クライアントプラグイン関数">セクション23.8.14「C API クライアントプラグイン関数」</a>を参照してください。
          </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="writing-authentication-plugins-proxy-users"></a>24.2.4.9.4 認証プラグインでのプロキシユーザーサポートの実装</h5></div></div></div><p>
            プラガブルな認証によって使用できるようになる機能の 1 つはプロキシユーザーです (<a class="xref" href="security.html#proxy-users" title="6.3.9 プロキシユーザー">セクション6.3.9「プロキシユーザー」</a>を参照してください)。サーバー側の認証プラグインでプロキシユーザーがサポートされるようにするには、次の条件を満たしている必要があります。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                接続するクライアントをプロキシユーザーとして扱う場合、プラグインは <code class="literal">MYSQL_SERVER_AUTH_INFO</code> 構造体の <code class="literal">authenticated_as</code> メンバー内に異なる名前を返して、プロキシ設定されているユーザー名を示す必要があります。<code class="literal">external_user</code> システム変数の値を設定するために、必要に応じて <code class="literal">external_user</code> メンバーを設定することもできます。
              </p></li><li class="listitem"><p>
                プロキシユーザーのアカウントは、プラグインによって認証されるようにセットアップする必要があります。アカウントをプラグインに関連付けるには、<code class="literal">CREATE USER</code> ステートメントまたは <code class="literal">GRANT</code> ステートメントを使用します。
              </p></li><li class="listitem"><p>
                プロキシユーザーアカウントには、プロキシ設定されているアカウントに対する <code class="literal">PROXY</code> 権限がある必要があります。この権限を付与するには、<code class="literal">GRANT</code> ステートメントを使用します。
              </p></li></ul></div><p>
            言い換えると、プラグインに必要なプロキシユーザーサポートの特性は、プロキシ設定されているユーザー名を <code class="literal">authenticated_as</code> に設定することのみです。そのほかは、オプションであるか (<code class="literal">external_user</code> の設定)、SQL ステートメントを使用して DBA が行います。
          </p><p>
            認証プラグインはプロキシユーザーが接続したときに返すプロキシ設定されているユーザーをどのように決定するのでしょうか。これはプラグインによって異なります。通常、プラグインはサーバーから渡された認証文字列に基づいて、クライアントをプロキシ設定されているユーザーにマップします。この文字列は、認証にプラグインを使用することを指定する <code class="literal">CREATE USER</code> ステートメントの <code class="literal">IDENTIFIED WITH</code> 句の <code class="literal">AS</code> 部分に指定されます。
          </p><p>
            プラグイン開発者は認証文字列の構文ルールを決定し、これらのルールに従ってプラグインを実装します。外部ユーザーを MySQL ユーザーにマップするカンマ区切りのリストのペアをプラグインが受け取るとします。例:
          </p><pre class="programlisting">
CREATE USER ''@'%.example.com'
  IDENTIFIED WITH my_plugin AS 'extuser1=mysqlusera, extuser2=mysqluserb'
CREATE USER ''@'%.example.org'
  IDENTIFIED WITH my_plugin AS 'extuser1=mysqluserc, extuser2=mysqluserd'
</pre><p>
            サーバーがプラグインを起動してクライアントを認証するときに、適切な認証文字列をプラグインに渡します。プラグインには次の役割があります。
          </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
                文字列を構文解析して構成要素に分解し、使用するマッピングを決定する
              </p></li><li class="listitem"><p>
                クライアントユーザー名とマッピングを比較する
              </p></li><li class="listitem"><p>
                適切な MySQL ユーザー名を返す
              </p></li></ol></div><p>
            たとえば、<code class="literal">example.com</code> ホストから <code class="literal">extuser2</code> が接続する場合、サーバーは <code class="literal">'extuser1=mysqlusera, extuser2=mysqluserb'</code> をプラグインに渡し、プラグインは <code class="literal">mysqluserb</code> に終端の NULL バイトを付加して <code class="literal">authenticated_as</code> にコピーします。<code class="literal">example.org</code> ホストから <code class="literal">extuser2</code> が接続する場合、サーバーは <code class="literal">'extuser1=mysqluserc, extuser2=mysqluserd'</code> を渡し、プラグインは代わりに <code class="literal">mysqluserd</code> をコピーします。
          </p><p>
            マッピングに一致するものがない場合のアクションはプラグインによって異なります。一致するものがある必要があるとき、多くの場合、プラグインはエラーを返します。または、プラグインが単純にクライアント名を返すこともあり、この場合、プラグインは <code class="literal">authenticated_as</code> を変更せず、サーバーはクライアントをプロキシとして扱いません。
          </p><p>
            次の例では、<code class="literal">auth_simple_proxy</code> という名前のプラグインを使用して、プロキシユーザーを処理する方法を示しています。前に示した <code class="literal">auth_simple</code> プラグインのように、<code class="literal">auth_simple_proxy</code> は空ではないすべてのパスワードを有効なものとして受け入れます (このため、本番環境で使用しないでください)。また、これは <code class="literal">auth_string</code> 認証文字列メンバーを検査し、次の非常に単純なルールを使用してこれを解釈します。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                文字列が空の場合、プラグインは指定されたユーザー名を返し、プロキシ設定は行われません。つまり、プラグインは <code class="literal">authenticated_as</code> の値を変更せずにそのままにします。
              </p></li><li class="listitem"><p>
                文字列が空ではない場合、プラグインはこれをプロキシ設定されているユーザーの名前として扱い、プロキシ設定が行われるようにこれを <code class="literal">authenticated_as</code> にコピーします。
              </p></li></ul></div><p>
            テストを行うために、上記のルールに従ってプロキシ設定されていない 1 つのアカウントとプロキシ設定されている 1 つのアカウントをセットアップします。これは、一方のアカウントには <code class="literal">AS</code> 句がなく、他方のアカウントにはプロキシ設定されているユーザーを指定する <code class="literal">AS</code> 句があることを意味します。
          </p><pre class="programlisting">
CREATE USER 'plugin_user1'@'localhost'
  IDENTIFIED WITH auth_simple_proxy;
CREATE USER 'plugin_user2'@'localhost'
  IDENTIFIED WITH auth_simple_proxy AS 'proxied_user';
</pre><p>
            また、プロキシ設定されているユーザーのアカウントを作成し、そのアカウントに対する <code class="literal">PROXY</code> 権限を <code class="literal">plugin_user2</code> に付与します。
          </p><pre class="programlisting">
CREATE USER 'proxied_user'@'localhost'
  IDENTIFIED BY 'proxied_user_pass';
GRANT PROXY
  ON 'proxied_user'@'localhost'
  TO 'plugin_user2'@'localhost';
</pre><p>
            サーバーは、認証プラグインを呼び出す前に、<code class="literal">authenticated_as</code> にクライアントユーザー名を設定します。ユーザーがプロキシであることを示すために、プラグインはプロキシ設定されているユーザー名を <code class="literal">authenticated_as</code> に設定します。<code class="literal">auth_simple_proxy</code> の場合、これは、<code class="literal">auth_string</code> 値を検査し、値が空でない場合は値を <code class="literal">authenticated_as</code> メンバーにコピーして、プロキシ設定されているユーザーの名前としてそれを返す必要があることを意味します。また、プロキシ設定が行われる場合、プラグインは <code class="literal">external_user</code> メンバーにクライアントユーザー名を設定し、これが <code class="literal">external_user</code> システム変数の値になります。
          </p><pre class="programlisting">
static int auth_simple_proxy_server (MYSQL_PLUGIN_VIO *vio,
                                     MYSQL_SERVER_AUTH_INFO *info)
{
  unsigned char *pkt;
  int pkt_len;

  /* read the password as null-terminated string, fail on error */
  if ((pkt_len= vio-&gt;read_packet(vio, &amp;pkt)) &lt; 0)
    return CR_ERROR;

  /* fail on empty password */
  if (!pkt_len || *pkt == '\0')
  {
    info-&gt;password_used= PASSWORD_USED_NO;
    return CR_ERROR;
  }

  /* accept any nonempty password */
  info-&gt;password_used= PASSWORD_USED_YES;

  /* if authentication string is nonempty, use as proxied user name */
  /* and use client name as external_user value */
  if (info-&gt;auth_string_length &gt; 0)
  {
    strcpy (info-&gt;authenticated_as, info-&gt;auth_string);
    strcpy (info-&gt;external_user, info-&gt;user_name);
  }

  return CR_OK;
}
</pre><p>
            接続が成功すると、<code class="literal">USER()</code> 関数は接続しているクライアントユーザーとホスト名を示し、<code class="literal">CURRENT_USER()</code> はセッション中に適用される権限を持つアカウントを示します。後者の値は、プロキシ設定が行われない場合は接続するユーザーアカウント、およびプロキシ設定が行われた場合はプロキシ設定されているアカウントになります。
          </p><p>
            プラグインをコンパイルおよびインストールして、テストします。最初に、<code class="literal">plugin_user1</code> として接続します。
          </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>mysql --user=plugin_user1 --password=x</code></strong>
</pre><p>
            この場合、プロキシ設定は行われません。
          </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SELECT USER(), CURRENT_USER(), @@proxy_user, @@external_user\G</code></strong>
*************************** 1. row ***************************
         USER(): plugin_user1@localhost
 CURRENT_USER(): plugin_user1@localhost
   @@proxy_user: NULL
@@external_user: NULL
</pre><p>
            次に、<code class="literal">plugin_user2</code> として接続します。
          </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>mysql --user=plugin_user2 --password=x</code></strong>
</pre><p>
            この場合、<code class="literal">plugin_user2</code> は <code class="literal">proxied_user</code> に対してプロキシ設定されます。
          </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SELECT USER(), CURRENT_USER(), @@proxy_user, @@external_user\G</code></strong>
*************************** 1. row ***************************
         USER(): plugin_user2@localhost
 CURRENT_USER(): proxied_user@localhost
   @@proxy_user: 'plugin_user2'@'localhost'
@@external_user: 'plugin_user2'@'localhost'
</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="writing-password-validation-plugins"></a>24.2.4.10 パスワード検証プラグインの作成</h4></div></div></div><p>
          このセクションでは、パスワード検証サーバープラグインを作成する方法について説明します。この手順は、MySQL ソース配布の <code class="literal">plugin/password_validation</code> ディレクトリにあるソースコードに基づいています。そのディレクトリ内にある <code class="filename">validate_password.cc</code> ソースファイルは、<code class="literal">validate_password</code> という名前のプラグインを実装します。
        </p><p>
          パスワード検証プラグインを作成するには、プラグインのソースファイルに次のヘッダーファイルをインクルードします。プラグインの機能および要件によっては、ほかの MySQL のヘッダーファイルまたは一般的なヘッダーファイルが必要になることもあります。
        </p><pre class="programlisting">
#include &lt;mysql/plugin_validate_password.h&gt;
</pre><p>
          <code class="filename">plugin_validate_password.h</code> は <code class="filename">plugin.h</code> をインクルードするため、後者のファイルを明示的にインクルードする必要はありません。<code class="filename">plugin.h</code> は <code class="literal">MYSQL_VALIDATE_PASSWORD_PLUGIN</code> サーバープラグインタイプとプラグインを宣言するために必要なデータ構造体を定義します。<code class="filename">plugin_validate_password.h</code> は、パスワード検証プラグインに固有のデータ構造体を定義します。
        </p><p>
          パスワード検証プラグインには、ほかの MySQL サーバープラグインと同じように一般プラグインディスクリプタがあります (<a class="xref" href="extending-mysql.html#server-plugin-descriptors" title="24.2.4.2.1 サーバープラグインライブラリおよびプラグインディスクリプタ">セクション24.2.4.2.1「サーバープラグインライブラリおよびプラグインディスクリプタ」</a>を参照してください)。<code class="filename">validate_password.cc</code> では、一般ディスクリプタは次のようになります。
        </p><pre class="programlisting">
mysql_declare_plugin(validate_password)
{
  MYSQL_VALIDATE_PASSWORD_PLUGIN,     /*   type                            */
  &amp;validate_password_descriptor,      /*   descriptor                      */
  "validate_password",                /*   name                            */
  "Oracle Corporation",               /*   author                          */
  "check password strength",          /*   description                     */
  PLUGIN_LICENSE_GPL,
  validate_password_init,             /*   init function (when loaded)     */
  validate_password_deinit,           /*   deinit function (when unloaded) */
  0x0100,                             /*   version                         */
  NULL,
  validate_password_system_variables, /*   system variables                */
  NULL,
  0,
}
mysql_declare_plugin_end;
</pre><p>
          <code class="literal">name</code> メンバー (<code class="literal">validate_password</code>) は、<code class="literal">INSTALL PLUGIN</code>、<code class="literal">UNINSTALL PLUGIN</code> などのステートメントでプラグインを参照するために使用する名前を指定します。これは <code class="literal">INFORMATION_SCHEMA.PLUGINS</code> または <code class="literal">SHOW PLUGINS</code> によって表示される名前でもあります。
        </p><p>
          一般ディスクリプタは、<code class="literal">SHOW VARIABLES</code> ステートメントに対してさまざまなステータス変数を公開する構造体である <code class="literal">validate_password_system_variables</code> も参照します。
        </p><pre class="programlisting">
static struct st_mysql_sys_var* validate_password_system_variables[]= {
  MYSQL_SYSVAR(length),
  MYSQL_SYSVAR(number_count),
  MYSQL_SYSVAR(mixed_case_count),
  MYSQL_SYSVAR(special_char_count),
  MYSQL_SYSVAR(policy),
  MYSQL_SYSVAR(dictionary_file),
  NULL
};
</pre><p>
          <code class="literal">validate_password_init</code> 初期化関数は辞書ファイルを読み取り (指定されている場合)、<code class="literal">validate_password_deinit</code> 関数はそのファイルに関連付けられているデータ構造体を解放します。
        </p><p>
          一般ディスクリプタの <code class="literal">validate_password_descriptor</code> 値はタイプ固有のディスクリプタを指しています。パスワード検証プラグインの場合、このディスクリプタの構造体は次のようになります。
        </p><pre class="programlisting">
struct st_mysql_validate_password
{
  int interface_version;
  /*
    This function returns TRUE for passwords which satisfy the password
    policy (as chosen by plugin variable) and FALSE for all other
    password
  */
  int (*validate_password)(mysql_string_handle password);
  /*
    This function returns the password strength (0-100) depending
    upon the policies
  */
  int (*get_password_strength)(mysql_string_handle password);
};
</pre><p>
          タイプ固有のディスクリプタには次のメンバーがあります。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">interface_version</code>: 規則により、タイプ固有のプラグインディスクリプタは、特定のプラグインタイプのインタフェースバージョンで始まります。サーバーはプラグインをロードするときに <code class="literal">interface_version</code> を検査し、プラグインと互換性があるかどうかを確認します。パスワード検証プラグインの場合、<code class="literal">interface_version</code> メンバーの値は <code class="literal">MYSQL_VALIDATE_PASSWORD_INTERFACE_VERSION</code> (<code class="literal">plugin_validate_password.h</code> で定義されます) です。
            </p></li><li class="listitem"><p>
              <code class="literal">validate_password</code>: パスワードが現在のパスワードポリシーを満たしているかどうかをテストするためにサーバーが呼び出す関数。パスワードが妥当な場合は 1 を返し、そうでない場合は 0 を返します。引数はパスワードであり、<code class="literal">mysql_string_handle</code> 値として渡されます。このデータ型は <code class="literal">mysql_string</code> サーバーサービスによって実装されます。詳細は、<code class="filename">sql</code> ディレクトリ内の <code class="filename">string_service.h</code> および <code class="filename">string_service.cc</code> のソースファイルを参照してください。
            </p></li><li class="listitem"><p>
              <code class="literal">get_password_strength</code>: パスワードの強さを評価するためにサーバーが呼び出す関数。これは 0 (弱い) から 100 (強い) までの値を返します。引数はパスワードであり、<code class="literal">mysql_string_handle</code> 値として渡されます。
            </p></li></ul></div><p>
          <code class="literal">validate_password</code> プラグインの場合、タイプ固有のディスクリプタは次のようになります。
        </p><pre class="programlisting">
static struct st_mysql_validate_password validate_password_descriptor=
{
  MYSQL_VALIDATE_PASSWORD_INTERFACE_VERSION,
  validate_password,                         /* validate function          */
  get_password_strength                      /* validate strength function */
};
</pre><p>
          プラグインライブラリのオブジェクトファイルをコンパイルおよびインストールするには、<a class="xref" href="extending-mysql.html#compiling-plugin-libraries" title="24.2.4.3 プラグインライブラリのコンパイルおよびインストール">セクション24.2.4.3「プラグインライブラリのコンパイルおよびインストール」</a>の手順を使用します。ライブラリファイルを使用するには、ライブラリファイルがプラグインディレクトリ (<code class="literal">plugin_dir</code> システム変数で指定されているディレクトリ) にインストールされている必要があります。<code class="literal">validate_password</code> プラグインの場合、MySQL をソースからビルドするときにコンパイルおよびインストールされます。これはバイナリ配布にも含められます。ビルド処理では、<code class="filename">validate_password.so</code> という名前の共有オブジェクトライブラリが生成されます (拡張子はプラットフォームによって異なる場合があります)。
        </p><p>
          プラグインを実行時に登録するには、次のステートメントを使用します (必要に応じて拡張子を変更します)。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>INSTALL PLUGIN validate_password SONAME 'validate_password.so';</code></strong>
</pre><p>
          プラグインのロードについての追加情報は、<a class="xref" href="server-administration.html#server-plugin-loading" title="5.1.8.1 プラグインのインストールおよびアンインストール">セクション5.1.8.1「プラグインのインストールおよびアンインストール」</a>を参照してください。
        </p><p>
          プラグインのインストールを検証するには、<code class="literal">INFORMATION_SCHEMA.PLUGINS</code> テーブルを調査するか、<code class="literal">SHOW PLUGINS</code> ステートメントを使用します。
        </p><p>
          <code class="literal">validate_password</code> プラグインがインストールされている間、プラグインはパスワード検査パラメータを示すシステム変数を公開します。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SHOW VARIABLES LIKE 'validate_password%';</code></strong>
+--------------------------------------+--------+
| Variable_name                        | Value  |
+--------------------------------------+--------+
| validate_password_dictionary_file    |        |
| validate_password_length             | 8      |
| validate_password_mixed_case_count   | 1      |
| validate_password_number_count       | 1      |
| validate_password_policy             | MEDIUM |
| validate_password_special_char_count | 1      |
+--------------------------------------+--------+
</pre><p>
          これらの変数の説明については、<a class="xref" href="security.html#validate-password-options-variables" title="6.1.2.6.2 パスワード検証プラグインのオプションおよび変数">セクション6.1.2.6.2「パスワード検証プラグインのオプションおよび変数」</a>を参照してください。
        </p><p>
          プラグインをテスト後に無効にするには、次のステートメントを使用してプラグインをアンロードします。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>UNINSTALL PLUGIN validate_password;</code></strong>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="plugin-services"></a>24.2.5 プラグインのための MySQL サービス</h3></div></div></div><a class="indexterm" name="idm139978997005728"></a><a class="indexterm" name="idm139978997004272"></a><p>
        MySQL サーバープラグインは、サーバーの<span class="quote">「<span class="quote">サービス</span>」</span>にアクセスできます。サービスインタフェースは、プラグインが呼び出すことができるサーバー機能を公開します。これはプラグイン API を補完し、次の特徴があります。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            サービスによって、プラグインは通常の関数呼び出しを使用して、サーバー内部のコードにアクセスできます。
          </p></li><li class="listitem"><p>
            サービスには移植性があり、複数のプラットフォームで動作します。
          </p></li><li class="listitem"><p>
            インタフェースにはバージョン管理メカニズムがあるため、サーバーによってサポートされるサービスバージョンを、プラグインバージョンに対してロード時にチェックできます。バージョン管理により、サーバーが提供するサービスのバージョン、およびプラグインが予期または必要とするサービスのバージョンの間の互換性の問題が防止されます。
          </p></li></ul></div><p>
        現在のサービスには次のものが含まれており、ほかのサービスも実装できます。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">my_plugin_log_service</code>: プラグインがエラーの報告およびエラーメッセージの指定を行うことができるサービス。サーバーはエラーログにメッセージを書き込みます。
          </p></li><li class="listitem"><p>
            <code class="literal">my_snprintf</code>: プラットフォーム間で一貫性のある結果を生成する、文字列の書式設定サービス。
          </p></li><li class="listitem"><p>
            <code class="literal">my_thd_scheduler</code>: プラグインがスレッドスケジューラを選択するためのサービス。
          </p></li><li class="listitem"><p>
            <code class="literal">mysql_string</code>: 文字列操作のためのサービス。
          </p></li><li class="listitem"><p>
            <code class="literal">thd_alloc</code>: メモリー割り当てサービス。
          </p></li><li class="listitem"><p>
            <code class="literal">thd_wait</code>: プラグインがスリープまたは停止することを報告するためのサービス。
          </p></li></ul></div><p>
        プラグインサービスインタフェースとプラグイン API の違いは次のとおりです。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            プラグイン API では、サーバーからプラグインを使用できます。呼び出しを開始するのは、プラグインを呼び出すサーバーです。これにより、サーバー機能の拡張、またはサーバーの処理に関する通知を受け取るための登録をプラグインで行うことができます。
          </p></li><li class="listitem"><p>
            プラグインサービスインタフェースでは、プラグインはサーバー内部のコードを呼び出すことができます。呼び出しを開始するのは、サービス関数を呼び出すプラグインです。これにより、多くのプラグインがサーバーにすでに実装されている機能を使用できるようになり、プラグインに個別に機能を実装する必要がなくなります。
          </p></li></ul></div><p>
        サーバーを変更して新しいサービスを追加する開発者は、<a class="ulink" href="http://dev.mysql.com/doc/internals/en/mysql-services-for-plugins.html" target="_top">プラグインのための MySQL サービス</a>を参照してください。
      </p><p>
        このセクションの残りの部分では、サービスとして使用可能なサーバー機能をプラグインで使用する方法について説明します。<code class="literal">my_snprintf</code> サービスを使用する<span class="quote">「<span class="quote">デーモン</span>」</span>プラグインの例のソースも参照してください。このプラグインは、MySQL ソース配布の <code class="filename">plugin/daemon_example</code> ディレクトリにあります。
      </p><p>
        存在するサービスおよびサービスが提供する関数を確認するには、MySQL ソース配布の <code class="filename">include/mysql</code> ディレクトリ内を参照してください。関連するファイルは次のとおりです。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="filename">plugin.h</code> は <code class="filename">services.h</code> をインクルードします。
          </p></li><li class="listitem"><p>
            <code class="filename">services.h</code> は、使用可能なすべてのサービス固有のヘッダーファイルをインクルードする<span class="quote">「<span class="quote">包括的な</span>」</span>ヘッダーです。
          </p></li><li class="listitem"><p>
            サービス固有のヘッダーには、<code class="filename">service_my_snprintf.h</code> または <code class="filename">service_thd_alloc.h</code> のような名前が付いています。
          </p></li></ul></div><p>
        各サービス固有ヘッダーには、対象となるサービスの完全な使用法を示すドキュメントを提供するコメントがあり、使用可能なサービス関数、それらの呼び出しシーケンス、および戻り値が含まれています。
      </p><p>
        プラグイン内からサービスを使用するには、サービス関連の情報にアクセスするための <code class="filename">plugin.h</code> ヘッダーファイルをプラグインのソースファイルでインクルードする必要があります。
      </p><pre class="programlisting">
#include &lt;mysql/plugin.h&gt;
</pre><p>
        これによってセットアップのコストが増えるわけではありません。このファイルにはすべてのプラグインで必要となる定義および構造体が含まれているため、プラグインはいずれにしてもこのファイルをインクルードする必要があります。
      </p><p>
        サービスにアクセスするために、プラグインはほかの関数と同様にサービス関数を呼び出します。たとえば、出力のために文字列を書式設定してバッファーに入れるには、同じ名前のサービスによって提供されている <code class="literal">my_snprintf()</code> 関数を呼び出します。
      </p><pre class="programlisting">
char buffer[BUFFER_SIZE];

my_snprintf(buffer, sizeof(buffer), <em class="replaceable"><code>format_string</code></em>, <em class="replaceable"><code>argument_to_format</code></em>, ...);
</pre><p>
        サーバーがエラーログに書き込むエラーを報告するには、最初にエラーレベルを選択します。<code class="filename">mysql/service_my_plugin_log.h</code> はこれらのレベルを定義しています。
      </p><pre class="programlisting">
enum plugin_log_level
{
  MY_ERROR_LEVEL,
  MY_WARNING_LEVEL,
  MY_INFORMATION_LEVEL
};  
</pre><p>
        次に、<code class="literal">my_plugin_log_message()</code> を呼び出します。
      </p><pre class="programlisting">
int my_plugin_log_message(MYSQL_PLUGIN *plugin, enum plugin_log_level level,
                          const char *format, ...);
</pre><p>
        例:
      </p><pre class="programlisting">
my_plugin_log_message(plugin_ptr, MY_ERROR_LEVEL, "Cannot initialize plugin");
</pre><p>
        プラグインをビルドするときに、<code class="literal">libmysqlservices</code> ライブラリでリンクする必要があります。リンク時には <code class="literal">-lmysqlservices</code> フラグを使用します。たとえば <span class="command"><strong>CMake</strong></span> の場合、最上位レベルの <code class="filename">CMakeLists.txt</code> ファイルに次の内容を指定します。
      </p><pre class="programlisting">
FIND_LIBRARY(MYSQLSERVICES_LIB mysqlservices 
 PATHS "${MYSQL_SRCDIR}/libservices" NO_DEFAULT_PATH)
</pre><p>
        プラグインのソースが格納されているディレクトリの <code class="filename">CMakeLists.txt</code> ファイルに次の内容を指定します。
      </p><pre class="programlisting">
# the plugin needs the mysql services library for error logging
TARGET_LINK_LIBRARIES (<em class="replaceable"><code>your_plugin_library_name</code></em> ${MYSQLSERVICES_LIB})
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adding-functions"></a>24.3 MySQL への新しい関数の追加</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#udf-features">24.3.1 ユーザー定義関数インタフェースの機能</a></span></dt><dt><span class="section"><a href="extending-mysql.html#adding-udf">24.3.2 新しいユーザー定義関数の追加</a></span></dt><dt><span class="section"><a href="extending-mysql.html#adding-native-function">24.3.3 新しいネイティブ関数の追加</a></span></dt></dl></div><a class="indexterm" name="idm139978996947184"></a><a class="indexterm" name="idm139978996945072"></a><a class="indexterm" name="idm139978996943040"></a><a class="indexterm" name="idm139978996940976"></a><a class="indexterm" name="idm139978996939008"></a><p>
      MySQL に新しい関数を追加する方法は 3 つあります。
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          ユーザー定義関数 (UDF) インタフェースを使用して関数を追加できます。ユーザー定義関数はオブジェクトファイルとしてコンパイルされ、<code class="literal">CREATE FUNCTION</code> ステートメントおよび <code class="literal">DROP FUNCTION</code> ステートメントを使用して、サーバーに対して動的に追加および削除されます。<a class="xref" href="sql-syntax.html#create-function-udf" title="13.7.3.1 ユーザー定義関数のための CREATE FUNCTION 構文">セクション13.7.3.1「ユーザー定義関数のための CREATE FUNCTION 構文」</a>を参照してください。
        </p></li><li class="listitem"><p>
          関数をネイティブ (組み込み) MySQL 関数として追加できます。ネイティブ関数はコンパイルされて <span class="command"><strong>mysqld</strong></span> サーバー内に組み込まれ、永続的に使用できます。
        </p></li><li class="listitem"><p>
          関数を追加するもう 1 つの方法は、ストアドファンクションを作成することです。これらは、オブジェクトコードをコンパイルするのではなく、SQL ステートメントを使用して記述します。ストアドファンクションを記述するための構文は、ここでは説明しません。<a class="xref" href="stored-programs-views.html#stored-routines" title="20.2 ストアドルーチン (プロシージャーと関数) の使用">セクション20.2「ストアドルーチン (プロシージャーと関数) の使用」</a>を参照してください。
        </p></li></ul></div><p>
      コンパイルされた関数を作成するための各方法には、長所と短所があります。
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          ユーザー定義関数を作成する場合、サーバー自体のほかにオブジェクトファイルをインストールする必要があります。関数をコンパイルしてサーバーに配置する場合、それを行う必要はありません。
        </p></li><li class="listitem"><p>
          ネイティブ関数の場合は、ソース配布を変更する必要があります。UDF の場合はその必要はありません。UDF をバイナリの MySQL 配布に追加できます。MySQL のソースにアクセスする必要はありません。
        </p></li><li class="listitem"><p>
          MySQL の配布をアップグレードする場合、UDF インタフェースが変更される新しいバージョンにアップグレードしないかぎり、以前インストールした UDF を使用し続けることができます。ネイティブ関数の場合、アップグレードするたびに変更を繰り返す必要があります。
        </p></li></ul></div><p>
      どのような方法を使用して新しい関数を追加したかにかかわらず、これらの関数は、<code class="literal">ABS()</code>、<code class="literal">SOUNDEX()</code> などのネイティブ関数と同じように SQL ステートメントから呼び出すことができます。
    </p><p>
      各種の関数への参照をサーバーが解釈する方法を記述したルールについては、<a class="xref" href="language-structure.html#function-resolution" title="9.2.4 関数名の構文解析と解決">セクション9.2.4「関数名の構文解析と解決」</a>を参照してください。
    </p><p>
      以降のセクションでは、UDF インタフェースの機能、UDF を作成するための手順、UDF の誤用を防ぐために MySQL が行うセキュリティー予防措置、およびネイティブな MySQL 関数を追加する方法について説明します。
    </p><p>
      UDF を作成する方法を示すソースコードの例については、MySQL ソース配布に提供されている <code class="filename">sql/udf_example.cc</code> ファイルを参照してください。
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="udf-features"></a>24.3.1 ユーザー定義関数インタフェースの機能</h3></div></div></div><p>
        ユーザー定義関数のための MySQL インタフェースには次の機能があります。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            関数は、文字列値、整数値、または実数値を返すことができ、同じタイプの引数を受け入れることができます。
          </p></li><li class="listitem"><p>
            一度に単一の行を操作する単純な関数、または行のグループを操作する集約関数を定義できます。
          </p></li><li class="listitem"><p>
            関数に渡される引数の数、タイプ、および名前をチェックできる情報が関数に渡されます。
          </p></li><li class="listitem"><p>
            引数が関数に渡される前に引数を特定のタイプに強制的に変更するように MySQL に指示できます。
          </p></li><li class="listitem"><p>
            関数が <code class="literal">NULL</code> を返すこと、またはエラーが発生したことを示すことができます。
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-udf"></a>24.3.2 新しいユーザー定義関数の追加</h3></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#udf-calling">24.3.2.1 単純な関数のための UDF の呼び出しシーケンス</a></span></dt><dt><span class="section"><a href="extending-mysql.html#udf-aggr-calling">24.3.2.2 集約関数のための UDF の呼び出しシーケンス</a></span></dt><dt><span class="section"><a href="extending-mysql.html#udf-arguments">24.3.2.3 UDF 引数の処理</a></span></dt><dt><span class="section"><a href="extending-mysql.html#udf-return-values">24.3.2.4 UDF の戻り値およびエラー処理</a></span></dt><dt><span class="section"><a href="extending-mysql.html#udf-compiling">24.3.2.5 ユーザー定義関数のコンパイルおよびインストール</a></span></dt><dt><span class="section"><a href="extending-mysql.html#udf-security">24.3.2.6 ユーザー定義関数のセキュリティー上の予防措置</a></span></dt></dl></div><a class="indexterm" name="idm139978996905776"></a><a class="indexterm" name="idm139978996903632"></a><a class="indexterm" name="idm139978996901568"></a><p>
        UDF のメカニズムが機能するためには、関数を C または C++ で記述し、オペレーティングシステムが動的ロードをサポートしている必要があります。MySQL ソース配布には、5 つの UDF 関数を定義している <code class="filename">sql/udf_example.cc</code> ファイルが含まれています。UDF の呼び出し規則のしくみを理解するには、このファイルを参照してください。<code class="filename">include/mysql_com.h</code> ヘッダーファイルには UDF 関連のシンボルおよびデータ構造体が定義されていますが、このヘッダーファイルを直接インクルードする必要はなく、<code class="filename">mysql.h</code> によってインクルードされます。
      </p><p>
        UDF に含まれているコードは実行中のサーバーの一部になるため、UDF を記述するときは、サーバーコードを記述するときに適用されるすべての制約に従う必要があります。たとえば、<code class="literal">libstdc++</code> ライブラリの関数を使用しようとすると、問題が生じることがあります。これらの制約は将来のサーバーのバージョンで変更されることがあるため、サーバーをアップグレードするときに、古いサーバー用にもともと作成された UDF を改訂する必要がある場合があります。これらの制約については、<a class="xref" href="installing.html#source-configuration-options" title="2.9.4 MySQL ソース構成オプション">セクション2.9.4「MySQL ソース構成オプション」</a>および<a class="xref" href="installing.html#compilation-problems" title="2.9.5 MySQL のコンパイルに関する問題">セクション2.9.5「MySQL のコンパイルに関する問題」</a>を参照してください。
      </p><p>
        UDF を使用できるようにするには、<span class="command"><strong>mysqld</strong></span> を動的にリンクする必要があります。<span class="command"><strong>mysqld</strong></span> からシンボルにアクセスする必要がある UDF を使用する場合 (たとえば、<code class="filename">sql/udf_example.cc</code> の <code class="literal">metaphone</code> 関数は <code class="literal">default_charset_info</code> を使用します) は、<code class="option">-rdynamic</code> を指定してプログラムをリンクする必要があります (<code class="literal">man dlopen</code> を参照してください)。
      </p><p>
        SQL ステートメントで使用する各関数について、対応する C (または C++) 関数を定義します。以降の説明では、<span class="quote">「<span class="quote">xxx</span>」</span>という名前を関数名の例として使用します。SQL と C/C++ での使用を区別するために、<code class="literal">XXX()</code> (大文字) は SQL 関数の呼び出しを示し、<code class="literal">xxx()</code> (小文字) は C/C++ 関数の呼び出しを示します。
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">注記</div><p>
          C++ を使用する場合は、C 関数を次のようにカプセル化できます。
        </p><pre class="programlisting">
extern "C" { ... }
</pre><p>
          これにより、完成した UDF 内で C++ 関数名が読み取ることができる状態に維持されます。
        </p></div><p>
        次のリストは、<code class="literal">XXX()</code> という名前の関数のインタフェースを実装するために記述する C/C++ 関数について説明しています。メインの関数 <code class="literal">xxx()</code> は必須です。また、<a class="xref" href="extending-mysql.html#udf-security" title="24.3.2.6 ユーザー定義関数のセキュリティー上の予防措置">セクション24.3.2.6「ユーザー定義関数のセキュリティー上の予防措置」</a>で説明している理由により、UDF にはここで説明している少なくとも 1 つのほかの関数が必要となります。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">xxx()</code>
          </p><p>
            メイン関数。ここで関数の結果が計算されます。SQL 関数のデータ型と C/C++ 関数の戻り型との対応を次に示します。
          </p><div class="informaltable"><table summary="この表は、SQL 関数のデータ型と対応する C/C++ のデータ型を一覧表示しています。" border="1"><colgroup><col><col></colgroup><thead><tr><th scope="col">SQL の型</th><th scope="col">C/C++ の型</th></tr></thead><tbody><tr><td scope="row"><code class="literal">STRING</code></td><td><code class="literal">char *</code></td></tr><tr><td scope="row"><code class="literal">INTEGER</code></td><td><code class="literal">long long</code></td></tr><tr><td scope="row"><code class="literal">REAL</code></td><td><code class="literal">double</code></td></tr></tbody></table></div><p>
            <code class="literal">DECIMAL</code> 関数を宣言することも可能ですが、現時点では値は文字列として返されるため、<code class="literal">STRING</code> 関数の場合と同様に UDF を作成します。<code class="literal">ROW</code> 関数は実装されていません。
          </p></li><li class="listitem"><p>
            <code class="literal">xxx_init()</code>
          </p><p>
            <code class="literal">xxx()</code> の初期化関数。存在する場合は次の目的で使用できます。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                <code class="literal">XXX()</code> への引数の数をチェックする。
              </p></li><li class="listitem"><p>
                引数が目的の型であることを確認するか、メインの関数が呼び出されたときに引数を目的の型に強制的に変更するように MySQL に指示する。
              </p></li><li class="listitem"><p>
                メインの関数が必要とするメモリーを割り当てる。
              </p></li><li class="listitem"><p>
                結果の最大長を指定する。
              </p></li><li class="listitem"><p>
                結果の小数点以下の最大の桁数を指定する (<code class="literal">REAL</code> 関数の場合)。
              </p></li><li class="listitem"><p>
                結果として <code class="literal">NULL</code> を許容するかどうかを指定する。
              </p></li></ul></div></li><li class="listitem"><p>
            <code class="literal">xxx_deinit()</code>
          </p><p>
            <code class="literal">xxx()</code> の初期化解除関数。存在する場合、初期化関数によって割り当てられたすべてのメモリーを割り当て解除します。
          </p></li></ul></div><p>
        SQL ステートメントによって <code class="literal">XXX()</code> が呼び出されると、MySQL は初期化関数 <code class="literal">xxx_init()</code> を呼び出して、引数のチェック、メモリーの割り当てなどの必要なセットアップを実行させます。<code class="literal">xxx_init()</code> がエラーを返した場合、MySQL はエラーメッセージを出力して SQL ステートメントを中止し、メイン関数または初期化解除関数を呼び出しません。それ以外の場合、MySQL はメイン関数 <code class="literal">xxx()</code> を行ごとに 1 回ずつ呼び出します。すべての行が処理されると、MySQL は初期化解除関数 <code class="literal">xxx_deinit()</code> を呼び出し、必要なクリーンアップ処理が実行されます。
      </p><p>
        <code class="literal">SUM()</code> のように動作する集約関数の場合は、次の関数も作成する必要があります。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">xxx_clear()</code>
          </p><p>
            現在の集約値をリセットしますが、新しいグループに対する初期集計値として引数を挿入しません。
          </p></li><li class="listitem"><p>
            <code class="literal">xxx_add()</code>
          </p><p>
            現在の集計値に引数を追加します。
          </p></li></ul></div><p>
        MySQL は集計 UDF を次のように処理します。
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
            <code class="literal">xxx_init()</code> を呼び出して、集約関数が結果を格納するために必要なメモリーを割り当てます。
          </p></li><li class="listitem"><p>
            <code class="literal">GROUP BY</code> 式に従ってテーブルをソートします。
          </p></li><li class="listitem"><p>
            新しいグループになるたびに先頭行で <code class="literal">xxx_clear()</code> を呼び出します。
          </p></li><li class="listitem"><p>
            同じグループに属する各行に対して <code class="literal">xxx_add()</code> を呼び出します。
          </p></li><li class="listitem"><p>
            グループが変更されたとき、または最後の行が処理されたあとに、<code class="literal">xxx()</code> を呼び出して集約の結果を取得します。
          </p></li><li class="listitem"><p>
            すべての行が処理されるまでステップ 3 から 5 までを繰り返します。
          </p></li><li class="listitem"><p>
            <code class="literal">xxx_deinit()</code> を呼び出して、UDF が割り当てたメモリーを解放します。
          </p></li></ol></div><p>
        すべての関数はスレッドセーフである必要があります。これにはメイン関数だけでなく、初期化関数および初期化解除関数のほか、集約関数によって必要とされる追加の関数も含まれます。この要件により、変化するグローバル変数または静的変数を割り当てることができなくなります。メモリーが必要な場合は、メモリーを <code class="literal">xxx_init()</code> で割り当て、<code class="literal">xxx_deinit()</code> で解放するようにしてください。
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="udf-calling"></a>24.3.2.1 単純な関数のための UDF の呼び出しシーケンス</h4></div></div></div><a class="indexterm" name="idm139978996817856"></a><p>
          このセクションでは単純な UDF を作成するときに定義する必要があるさまざまな関数について説明します。<a class="xref" href="extending-mysql.html#adding-udf" title="24.3.2 新しいユーザー定義関数の追加">セクション24.3.2「新しいユーザー定義関数の追加」</a>には、MySQL がこれらの関数を呼び出す順序が記載されています。
        </p><p>
          メインの <code class="literal">xxx()</code> 関数は、このセクションに示すように宣言してください。<code class="literal">CREATE FUNCTION</code> ステートメントで SQL 関数 <code class="literal">XXX()</code> が <code class="literal">STRING</code>、<code class="literal">INTEGER</code>、または <code class="literal">REAL</code> のいずれを返すかに応じて、戻り型およびパラメータは異なります。
        </p><p>
          <code class="literal">STRING</code> 関数の場合:
        </p><pre class="programlisting">
char *xxx(UDF_INIT *initid, UDF_ARGS *args,
          char *result, unsigned long *length,
          char *is_null, char *error);
</pre><p>
          <code class="literal">INTEGER</code> 関数の場合:
        </p><pre class="programlisting">
long long xxx(UDF_INIT *initid, UDF_ARGS *args,
              char *is_null, char *error);
</pre><p>
          <code class="literal">REAL</code> 関数の場合:
        </p><pre class="programlisting">
double xxx(UDF_INIT *initid, UDF_ARGS *args,
              char *is_null, char *error);
</pre><p>
          <code class="literal">DECIMAL</code> 関数は文字列値を返すため、<code class="literal">STRING</code> 関数と同様に宣言してください。<code class="literal">ROW</code> 関数は実装されていません。
        </p><p>
          初期化関数および初期化解除関数は、次のように宣言します。
        </p><pre class="programlisting">
my_bool xxx_init(UDF_INIT *initid, UDF_ARGS *args, char *message);

void xxx_deinit(UDF_INIT *initid);
</pre><p>
          <code class="literal">initid</code> パラメータは 3 つの関数すべてに渡されます。これは、関数間で情報をやり取りするために使用される <code class="literal">UDF_INIT</code> 構造体を指しています。<code class="literal">UDF_INIT</code> 構造体メンバーを次に示します。初期化関数で、変更するメンバーを設定してください。(メンバーのデフォルトを使用する場合は、変更せずにそのままにします。)
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">my_bool maybe_null</code>
            </p><p>
              <code class="literal">xxx()</code> が <code class="literal">NULL</code> を返すことができる場合、<code class="literal">xxx_init()</code> は <code class="literal">maybe_null</code> を <code class="literal">1</code> に設定します。いずれかの引数が <code class="literal">maybe_null</code> として宣言されている場合、デフォルト値は <code class="literal">1</code> です。
            </p></li><li class="listitem"><p>
              <code class="literal">unsigned int decimals</code>
            </p><p>
              小数点の右側の桁数。デフォルト値は、メイン関数に渡された引数の小数点以下の桁数の最大値です。たとえば、関数に <code class="literal">1.34</code>、<code class="literal">1.345</code>、および <code class="literal">1.3</code> が渡された場合、<code class="literal">1.345</code> の小数点以下の桁数が 3 であるため、デフォルトは 3 になります。
            </p><p>
              引数で小数点以下の桁数が固定されていない場合、<code class="literal">decimals</code> 値は 31 に設定され、これは <code class="literal">DECIMAL</code>、<code class="literal">FLOAT</code>、および <code class="literal">DOUBLE</code> データ型に許可される最大の小数点以下の桁数に 1 を加えた数です。MySQL 5.6 では、この値は <code class="filename">mysql_com.h</code> ヘッダーファイルの定数 <code class="literal">NOT_FIXED_DEC</code> として利用できます。
            </p><p>
              <code class="literal">decimals</code> 値の 31 は、<code class="literal">FLOAT</code> カラムまたは <code class="literal">DOUBLE</code> カラムが小数点以下の桁数を明示せずに宣言された (たとえば、<code class="literal">FLOAT(10,3)</code> でなく <code class="literal">FLOAT</code>) 場合の引数、または <code class="literal">1345E-3</code> などの浮動小数点の定数に使用されます。これは、関数内で数値形式に変換される可能性がある、文字列およびその他の数値以外の引数に対しても使用されます。
            </p><p>
              <code class="literal">decimals</code> メンバーを初期化する値は、デフォルトにすぎません。これは、実行される実際の計算が反映されるように関数内で変更できます。デフォルトは、引数の最大の小数点以下の桁数が使用されるように決定します。いずれかの引数の小数点以下の桁数が <code class="literal">NOT_FIXED_DEC</code> である場合、その値が <code class="literal">decimals</code> に使用されます。
            </p></li><li class="listitem"><p>
              <code class="literal">unsigned int max_length</code>
            </p><p>
              結果の最大長。デフォルトの <code class="literal">max_length</code> 値は、関数の結果の型に応じて異なります。文字列関数の場合、デフォルトはもっとも長い引数の長さです。整数関数の場合、デフォルトは 21 桁です。実数関数の場合、デフォルトは <code class="literal">initid-&gt;decimals</code> によって示されている小数点以下の桁数に 13 を加えた値です。(数値関数の場合、長さには符号文字または小数点文字が含まれています。)
            </p><p>
              BLOB 値を返す場合は、<code class="literal">max_length</code> を 65K バイトまたは 16M バイトに設定できます。このメモリーは割り当てられませんが、この値は、データを一時的に格納する必要がある場合に使用するデータ型を決定するために使用されます。
            </p></li><li class="listitem"><p>
              <code class="literal">char *ptr</code>
            </p><p>
              関数が独自の用途に使用できるポインタ。たとえば、複数の関数間で <code class="literal">initid-&gt;ptr</code> を使用して、割り当て済みのメモリーをやり取りできます。<code class="literal">xxx_init()</code> でこのメモリーを割り当てて、それをこのポインタに割り当てます。
            </p><pre class="programlisting">
initid-&gt;ptr = allocated_memory;
</pre><p>
              <code class="literal">xxx()</code> および <code class="literal">xxx_deinit()</code> では、<code class="literal">initid-&gt;ptr</code> を参照して、メモリーを使用または割り当て解除します。
            </p></li><li class="listitem"><p>
              <code class="literal">my_bool const_item</code>
            </p><p>
              <code class="literal">xxx_init()</code> は、<code class="literal">xxx()</code> が常に同じ値を返す場合は <code class="literal">const_item</code> を <code class="literal">1</code> に設定し、それ以外の場合は <code class="literal">0</code> に設定します。
            </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="udf-aggr-calling"></a>24.3.2.2 集約関数のための UDF の呼び出しシーケンス</h4></div></div></div><a class="indexterm" name="idm139978996745696"></a><p>
          このセクションでは集約 UDF を作成するときに定義する必要があるさまざまな関数について説明します。<a class="xref" href="extending-mysql.html#adding-udf" title="24.3.2 新しいユーザー定義関数の追加">セクション24.3.2「新しいユーザー定義関数の追加」</a>には、MySQL がこれらの関数を呼び出す順序が記載されています。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">xxx_reset()</code>
            </p><p>
              この関数は、MySQL が新しいグループ内で最初の行を見つけたときに呼び出されます。これはすべての内部サマリー変数をリセットし、指定された <code class="literal">UDF_ARGS</code> 引数をグループの内部サマリー値の最初の値として使用します。<code class="literal">xxx_reset()</code> は次のように宣言します。
            </p><pre class="programlisting">
void xxx_reset(UDF_INIT *initid, UDF_ARGS *args,
               char *is_null, char *error);
</pre><p>
              MySQL 5.6 では、<code class="literal">xxx_reset()</code> は必要がないか使用されず、UDF インタフェースでは代わりに <code class="literal">xxx_clear()</code> が使用されます。ただし、古いバージョンのサーバーで UDF を動作させる場合、<code class="literal">xxx_reset()</code> と <code class="literal">xxx_clear()</code> を両方定義できます。(両方の関数を含める場合、<code class="literal">xxx_reset()</code> 関数は、すべての変数をリセットする <code class="literal">xxx_clear()</code> を呼び出してから、<code class="literal">xxx_add()</code> を呼び出して <code class="literal">UDF_ARGS</code> 引数をグループの最初の値として追加することによって、多くの場合内部的に実装できます。)
            </p></li><li class="listitem"><p>
              <code class="literal">xxx_clear()</code>
            </p><p>
              この関数は、MySQL でサマリー結果をリセットする必要がある場合に呼び出されます。これは新しいグループになるたびに最初に呼び出されますが、一致する行のないクエリーの値をリセットするために呼び出されることもあります。<code class="literal">xxx_clear()</code> は次のように宣言します。
            </p><pre class="programlisting">
void xxx_clear(UDF_INIT *initid, char *is_null, char *error);
</pre><p>
              <code class="literal">is_null</code> は、<code class="literal">xxx_clear()</code> を呼び出す前に、<code class="literal">CHAR(0)</code> を指すように設定されます。
            </p><p>
              処理に問題があった場合は、<code class="literal">error</code> 引数が指している変数に値を格納できます。<code class="literal">error</code> は文字列バッファーでなく単一バイト変数を指しています。
            </p><p>
              <code class="literal">xxx_clear()</code> は MySQL 5.6 で必要となります。
            </p></li><li class="listitem"><p>
              <code class="literal">xxx_add()</code>
            </p><p>
              この関数は、同じグループに属するすべての行に対して呼び出されます。これは、<code class="literal">UDF_ARGS</code> 引数内の値を内部サマリー変数に追加するために使用します。
            </p><pre class="programlisting">
void xxx_add(UDF_INIT *initid, UDF_ARGS *args,
             char *is_null, char *error);
</pre></li></ul></div><p>
          集約 UDF の <code class="literal">xxx()</code> 関数は、非集約 UDF と同様に宣言してください。<a class="xref" href="extending-mysql.html#udf-calling" title="24.3.2.1 単純な関数のための UDF の呼び出しシーケンス">セクション24.3.2.1「単純な関数のための UDF の呼び出しシーケンス」</a>を参照してください。
        </p><p>
          集約 UDF の場合、MySQL はグループ内のすべての行が処理されたあとに <code class="literal">xxx()</code> 関数を呼び出します。通常はここで <code class="literal">UDF_ARGS</code> 引数にアクセスすることはなく、内部サマリー変数に基づいて値を返します。
        </p><p>
          <code class="literal">xxx()</code> での戻り値の処理は、非集約 UDF と同様に行います。<a class="xref" href="extending-mysql.html#udf-return-values" title="24.3.2.4 UDF の戻り値およびエラー処理">セクション24.3.2.4「UDF の戻り値およびエラー処理」</a>を参照してください。
        </p><p>
          <code class="literal">xxx_reset()</code> 関数および <code class="literal">xxx_add()</code> 関数は、<code class="literal">UDF_ARGS</code> 引数を非集約 UDF の関数と同様に処理します。<a class="xref" href="extending-mysql.html#udf-arguments" title="24.3.2.3 UDF 引数の処理">セクション24.3.2.3「UDF 引数の処理」</a>を参照してください。
        </p><p>
          <code class="literal">is_null</code> および <code class="literal">error</code> へのポインタ引数は、<code class="literal">xxx_reset()</code>、<code class="literal">xxx_clear()</code>、<code class="literal">xxx_add()</code>、および <code class="literal">xxx()</code> へのすべての呼び出しで同じです。これを使用すると、エラーが発生したこと、または <code class="literal">xxx()</code> 関数が <code class="literal">NULL</code> を返すかどうかを記憶できます。文字列を <code class="literal">*error</code> に格納しないでください。<code class="literal">error</code> は文字列バッファーでなく単一バイト変数を指しています。
        </p><p>
          <code class="literal">*is_null</code> は (<code class="literal">xxx_clear()</code> を呼び出す前に) グループごとにリセットされます。<code class="literal">*error</code> がリセットされることはありません。
        </p><p>
          <code class="literal">xxx()</code> が戻るときに <code class="literal">*is_null</code> または <code class="literal">*error</code> が設定されていた場合、MySQL はグループ関数の結果として <code class="literal">NULL</code> を返します。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="udf-arguments"></a>24.3.2.3 UDF 引数の処理</h4></div></div></div><a class="indexterm" name="idm139978996690368"></a><a class="indexterm" name="idm139978996688928"></a><p>
          <code class="literal">args</code> パラメータは、次に示すメンバーを持つ <code class="literal">UDF_ARGS</code> 構造体を指しています。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">unsigned int arg_count</code>
            </p><p>
              引数の数。特定の数の引数を使用して関数を呼び出す必要がある場合は、初期化関数でこの値をチェックします。例:
            </p><pre class="programlisting">
if (args-&gt;arg_count != 2)
{
    strcpy(message,"XXX() requires two arguments");
    return 1;
}
</pre><p>
              配列であるその他の <code class="literal">UDF_ARGS</code> メンバー値の場合、配列参照はゼロベースです。つまり、0 から <code class="literal">args-&gt;arg_count</code> − 1 までのインデックス値を使用して配列メンバーを参照します。
            </p></li><li class="listitem"><p>
              <code class="literal">enum Item_result *arg_type</code>
            </p><p>
              各引数の型を格納する配列へのポインタ。指定可能な型の値は、<code class="literal">STRING_RESULT</code>、<code class="literal">INT_RESULT</code>、<code class="literal">REAL_RESULT</code>、および <code class="literal">DECIMAL_RESULT</code> です。
            </p><p>
              引数が予期している型であることを確認し、そうではない場合にエラーを返すには、初期化関数で <code class="literal">arg_type</code> 配列をチェックします。例:
            </p><pre class="programlisting">
if (args-&gt;arg_type[0] != STRING_RESULT ||
    args-&gt;arg_type[1] != INT_RESULT)
{
    strcpy(message,"XXX() requires a string and an integer");
    return 1;
}
</pre><p>
              <code class="literal">DECIMAL_RESULT</code> 型の引数は文字列として渡されるため、<code class="literal">STRING_RESULT</code> 値と同様にこれらを処理する必要があります。
            </p><p>
              関数の引数が特定の型であることを要求する代わりに、初期化関数を使用して、<code class="literal">arg_type</code> 要素を必要な型に設定できます。これにより、MySQL が <code class="literal">xxx()</code> の各呼び出しで引数をそれらの型に強制的に変更します。たとえば、最初の 2 つの引数がそれぞれ文字列および整数になるように強制的に指定するには、<code class="literal">xxx_init()</code> で次の操作を実行します。
            </p><pre class="programlisting">
args-&gt;arg_type[0] = STRING_RESULT;
args-&gt;arg_type[1] = INT_RESULT;
</pre><p>
              <code class="literal">1.3</code>、<code class="literal">DECIMAL</code> カラム値などの正確値型の 10 進数引数は、<code class="literal">DECIMAL_RESULT</code> 型で渡されます。ただし、値は文字列として渡されます。数値を受け取るには、初期化関数を使用して、引数が <code class="literal">REAL_RESULT</code> 値に強制的に変更されるように指定します。
            </p><pre class="programlisting">
args-&gt;arg_type[2] = REAL_RESULT;
</pre></li><li class="listitem"><p>
              <code class="literal">char **args</code>
            </p><p>
              <code class="literal">args-&gt;args</code> は、関数に渡される引数の一般的な性質についての情報を初期化関数に通知します。定数引数 <code class="literal">i</code> の場合、<code class="literal">args-&gt;args[i]</code> は引数値を指しています。(値に正しくアクセスする方法については、以降の説明を参照してください。)非定数引数の場合、<code class="literal">args-&gt;args[i]</code> は <code class="literal">0</code> です。定数引数は、<code class="literal">3</code>、<code class="literal">4*7-2</code>、<code class="literal">SIN(3.14)</code> などの定数のみを使用した式です。非定数引数は、行によって変化することがある値を参照する式のことであり、カラム名、非定数引数を指定して呼び出される関数などがあります。
            </p><p>
              メイン関数への各呼び出しで、<code class="literal">args-&gt;args</code> には、現在処理されている行に関して渡される実際の引数が含まれています。
            </p><p>
              引数 <code class="literal">i</code> が <code class="literal">NULL</code> の場合、<code class="literal">args-&gt;args[i]</code> はゼロポインタ (0) です。引数が <code class="literal">NULL</code> ではない場合、関数は引数を次のように参照できます。
            </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  <code class="literal">STRING_RESULT</code> 型の引数は、文字列ポインタおよび長さとして指定し、バイナリデータまたは任意の長さのデータを処理できます。文字列の内容は <code class="literal">args-&gt;args[i]</code> として取得でき、文字列の長さは <code class="literal">args-&gt;lengths[i]</code> です。文字列がゼロで終わると想定しないでください。
                </p></li><li class="listitem"><p>
                  <code class="literal">INT_RESULT</code> 型の引数の場合は、<code class="literal">args-&gt;args[i]</code> を <code class="literal">long long</code> 値にキャストする必要があります。
                </p><pre class="programlisting">
long long int_val;
int_val = *((long long*) args-&gt;args[i]);
</pre></li><li class="listitem"><p>
                  <code class="literal">REAL_RESULT</code> 型の引数の場合は、<code class="literal">args-&gt;args[i]</code> を <code class="literal">double</code> 値にキャストする必要があります。
                </p><pre class="programlisting">
double    real_val;
real_val = *((double*) args-&gt;args[i]);
</pre></li><li class="listitem"><p>
                  <code class="literal">DECIMAL_RESULT</code> 型の引数の場合、値は文字列として渡さるため、<code class="literal">STRING_RESULT</code> 値と同様に処理されるようにしてください。
                </p></li><li class="listitem"><p>
                  <code class="literal">ROW_RESULT</code> 引数は実装されていません。
                </p></li></ul></div></li><li class="listitem"><p>
              <code class="literal">unsigned long *lengths</code>
            </p><p>
              初期化関数の場合、<code class="literal">lengths</code> 配列は各引数の最大文字列長を示しています。これらは変更しないでください。メイン関数の各呼び出しで、<code class="literal">lengths</code> には、現在処理されている行に関して渡されるすべての文字列引数の実際の長さが含まれています。<code class="literal">INT_RESULT</code> 型または <code class="literal">REAL_RESULT</code> 型の引数の場合は、<code class="literal">lengths</code> には (初期化関数の場合と同様に) 引数の最大長が含まれています。
            </p></li><li class="listitem"><p>
              <code class="literal">char *maybe_null</code>
            </p><p>
              初期化関数において、<code class="literal">maybe_null</code> 配列は、各引数について引数値が NULL の場合があるかどうかを示します (ない場合は 0、およびある場合は 1)。
            </p></li><li class="listitem"><p>
              <code class="literal">char **attributes</code>
            </p><p>
              <code class="literal">args-&gt;attributes</code> は UDF 引数の名前についての情報を通知します。引数 <code class="literal">i</code> の場合、属性名は <code class="literal">args-&gt;attributes[i]</code> の文字列として取得でき、属性の長さは <code class="literal">args-&gt;attribute_lengths[i]</code> です。文字列がゼロで終わると想定しないでください。
            </p><p>
              デフォルトでは、UDF 引数の名前は引数を指定するために使用される式のテキストです。UDF の場合、引数にはオプションの <code class="literal">[AS] <em class="replaceable"><code>alias_name</code></em></code> 句が含まれていることもあり、この場合の引数名は <em class="replaceable"><code>alias_name</code></em> です。このため、各引数の <code class="literal">attributes</code> 値は、エイリアスが指定されているかどうかに応じて異なります。
            </p><p>
              UDF <code class="literal">my_udf()</code> が次のように呼び出されたとします。
            </p><pre class="programlisting">
SELECT my_udf(expr1, expr2 AS alias1, expr3 alias2);
</pre><p>
              この場合、<code class="literal">attributes</code> 配列および <code class="literal">attribute_lengths</code> 配列の値は次のようになります。
            </p><pre class="programlisting">
args-&gt;attributes[0] = "expr1"
args-&gt;attribute_lengths[0] = 5

args-&gt;attributes[1] = "alias1"
args-&gt;attribute_lengths[1] = 6

args-&gt;attributes[2] = "alias2"
args-&gt;attribute_lengths[2] = 6
</pre></li><li class="listitem"><p>
              <code class="literal">unsigned long *attribute_lengths</code>
            </p><p>
              <code class="literal">attribute_lengths</code> 配列は、各属性名の長さを示しています。
            </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="udf-return-values"></a>24.3.2.4 UDF の戻り値およびエラー処理</h4></div></div></div><a class="indexterm" name="idm139978996604160"></a><a class="indexterm" name="idm139978996602112"></a><a class="indexterm" name="idm139978996600256"></a><a class="indexterm" name="idm139978996598096"></a><p>
          初期化関数は、エラーが発生しなかった場合は <code class="literal">0</code>、およびそうでない場合は <code class="literal">1</code> を返します。エラーが発生した場合、<code class="literal">xxx_init()</code> は <code class="literal">message</code> パラメータに NULL で終わるエラーメッセージを格納します。メッセージはクライアントに返されます。メッセージバッファーの長さは <code class="literal">MYSQL_ERRMSG_SIZE</code> 文字ですが、標準の端末画面の幅にメッセージが収まるように、メッセージを 80 文字未満に維持するようにしてください。
        </p><p>
          <code class="literal">long long</code> 関数および <code class="literal">double</code> 関数の場合、メイン関数 <code class="literal">xxx()</code> の戻り値は関数値です。文字列関数は結果へのポインタを返し、<code class="literal">*length</code> を戻り値の (バイト単位の) 長さに設定します。例:
        </p><pre class="programlisting">
memcpy(result, "result string", 13);
*length = 13;
</pre><p>
          MySQL は、<code class="literal">result</code> パラメータを使用してバッファーを <code class="literal">xxx()</code> 関数に渡します。このバッファーは 255 文字を保持するための十分な長さがあり、マルチバイト文字も保持できます。<code class="literal">xxx()</code> 関数はこのバッファーに結果を格納でき (結果が収まる場合)、その場合は戻り値にそのバッファーへのポインタを設定してください。関数が別のバッファーに結果を格納する場合は、そのバッファーへのポインタを返します。
        </p><p>
          文字列関数で提供されたバッファーを使用しない場合 (たとえば、255 文字より長い文字列を返す必要がある場合)、<code class="literal">xxx_init()</code> 関数または <code class="literal">xxx()</code> 関数で <code class="literal">malloc()</code> を使用して独自のバッファーの領域を割り当て、<code class="literal">xxx_deinit()</code> 関数でその領域を解放する必要があります。以降の <code class="literal">xxx()</code> の呼び出しで再利用できるように、割り当てられたメモリーを <code class="literal">UDF_INIT</code> 構造体の <code class="literal">ptr</code> スロットに格納できます。<a class="xref" href="extending-mysql.html#udf-calling" title="24.3.2.1 単純な関数のための UDF の呼び出しシーケンス">セクション24.3.2.1「単純な関数のための UDF の呼び出しシーケンス」</a>を参照してください。
        </p><p>
          メイン関数で戻り値が <code class="literal">NULL</code> であることを示すには、<code class="literal">*is_null</code> を <code class="literal">1</code> に設定します。
        </p><pre class="programlisting">
*is_null = 1;
</pre><p>
          メイン関数でエラーを返すことを示すには、<code class="literal">*error</code> を <code class="literal">1</code> に設定します。
        </p><pre class="programlisting">
*error = 1;
</pre><p>
          <code class="literal">xxx()</code> がいずれかの行で <code class="literal">*error</code> に <code class="literal">1</code> を設定した場合、<code class="literal">XXX()</code> が呼び出されたステートメントによって処理される現在の行および後続の行の関数値は <code class="literal">NULL</code> です。(後続の行では <code class="literal">xxx()</code> は呼び出されません。)
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="udf-compiling"></a>24.3.2.5 ユーザー定義関数のコンパイルおよびインストール</h4></div></div></div><a class="indexterm" name="idm139978996563968"></a><a class="indexterm" name="idm139978996561824"></a><a class="indexterm" name="idm139978996559856"></a><p>
          UDF を実装するファイルは、サーバーが実行されるホストでコンパイルおよびインストールする必要があります。MySQL ソース配布に含まれている UDF ファイルの例 <code class="filename">sql/udf_example.cc</code> を使用して、このプロセスについて説明します。
        </p><p>
          スレーブサーバーにレプリケーションされるステートメントで UDF が参照される場合は、すべてのスレーブでその関数が使用可能である必要があります。そうしないと、スレーブでその関数を呼び出そうとしたときに、レプリケーションがスレーブで失敗します。
        </p><p>
          次の手順は Unix の場合です。Windows での手順は、このセクションの以降で説明します。
        </p><p>
          <code class="filename">udf_example.cc</code> ファイルには次の関数が含まれています。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="literal">metaphon()</code> は、文字列引数の metaphon 文字列を返します。これは soundex 文字列に似ていますが、英語向けに調整されています。
            </p></li><li class="listitem"><p>
              <code class="literal">myfunc_double()</code> は、引数内の文字の ASCII 値の合計をその引数の長さの合計で割ったものを返します。
            </p></li><li class="listitem"><p>
              <code class="literal">myfunc_int()</code> は、その引数の長さの合計を返します。
            </p></li><li class="listitem"><p>
              <code class="literal">sequence([const int])</code> は、指定された数値または 1 (数値が指定されなかった場合) から始まるシーケンスを返します。
            </p></li><li class="listitem"><p>
              <code class="literal">lookup()</code> は、ホスト名の IP アドレスを返します。
            </p></li><li class="listitem"><p>
              <code class="literal">reverse_lookup()</code> は、IP アドレスに対するホスト名を返します。この関数は、<code class="literal">'xxx.xxx.xxx.xxx'</code> という形式の単一の文字列引数または 4 つの数値のいずれかを使用して呼び出すことができます。
            </p></li><li class="listitem"><p>
              <code class="literal">avgcost()</code> は、平均コストを返します。これは集約関数です。
            </p></li></ul></div><p>
          動的にロード可能なファイルは、次のようなコマンドを使用して、共有可能なオブジェクトファイルとしてコンパイルします。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>gcc -shared -o udf_example.so udf_example.cc</code></strong>
</pre><p>
          <span class="command"><strong>CMake</strong></span> に <span class="command"><strong>gcc</strong></span> を使用している場合 (MySQL はそのように構成されています) は、より簡単なコマンドで <code class="filename">udf_example.so</code> を作成できます。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>make udf_example</code></strong>
</pre><p>
          UDF が含まれている共有オブジェクトをコンパイルしたら、共有オブジェクトをインストールして MySQL に通知する必要があります。<span class="command"><strong>gcc</strong></span> を使用して <code class="filename">udf_example.cc</code> から共有オブジェクトをコンパイルすると、<code class="filename">udf_example.so</code> という名前のファイルが直接生成されます。共有オブジェクトをサーバーのプラグインディレクトリにコピーし、<code class="filename">udf_example.so</code> という名前を付けます。このディレクトリは、<code class="literal">plugin_dir</code> システム変数の値から取得できます。
        </p><p>
          一部のシステムでは、ダイナミックリンカーを構成する <span class="command"><strong>ldconfig</strong></span> プログラムは、共有オブジェクトの名前が <code class="literal">lib</code> で始まっていない場合、共有オブジェクトを認識しません。この場合は、たとえば、ファイル名を <code class="filename">udf_example.so</code> から <code class="filename">libudf_example.so</code> に名前変更してください。
        </p><p>
          Windows では、次の手順を使用してユーザー定義関数をコンパイルできます。
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
              MySQL ソース配布を取得します。<a class="xref" href="installing.html#getting-mysql" title="2.1.3 MySQL の取得方法">セクション2.1.3「MySQL の取得方法」</a>を参照してください。
            </p></li><li class="listitem"><p>
              必要な場合は <span class="command"><strong>CMake</strong></span> ビルドユーティリティーを <a class="ulink" href="http://www.cmake.org" target="_top">http://www.cmake.org</a> から取得します。(バージョン 2.6 以降が必要となります)。
            </p></li><li class="listitem"><p>
              ソースツリーで <code class="filename">sql</code> ディレクトリを参照します。その場所には <code class="filename">udf_example.def</code> <code class="filename">udf_example.cc</code> という名前のファイルがあります。両方のファイルをこのディレクトリから作業ディレクトリにコピーします。
            </p></li><li class="listitem"><p>
              次の内容を持つ <span class="command"><strong>CMake</strong></span> の <code class="filename">makefile</code> (<code class="filename">CMakeLists.txt</code>) を作成します。
            </p><pre class="programlisting">
PROJECT(udf_example)

# Path for MySQL include directory
INCLUDE_DIRECTORIES("c:/mysql/include")

ADD_DEFINITIONS("-DHAVE_DLOPEN")
ADD_LIBRARY(udf_example MODULE udf_example.cc udf_example.def)
TARGET_LINK_LIBRARIES(udf_example wsock32)
</pre></li><li class="listitem"><p>
              VC プロジェクトファイルおよびソリューションファイルを作成します。
            </p><pre class="programlisting">
cmake -G "&lt;Generator&gt;"
</pre><p>
              <span class="command"><strong>cmake --help</strong></span> を呼び出すと、有効なジェネレータのリストが表示されます。
            </p></li><li class="listitem"><p>
              <code class="filename">udf_example.dll</code> を作成します。
            </p><pre class="programlisting">
devenv udf_example.sln /build Release
</pre></li></ol></div><p>
          共有オブジェクトファイルがインストールされたら、次のステートメントを使用して、新しい関数について <span class="command"><strong>mysqld</strong></span> に通知します。使用しているシステムでオブジェクトファイルのサフィクスが <code class="filename">.so</code> ではない場合、正しいサフィクスにすべて置き換えます (たとえば、Windows の場合は <code class="filename">.dll</code>)。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>CREATE FUNCTION metaphon RETURNS STRING SONAME 'udf_example.so';</code></strong>
mysql&gt; <strong class="userinput"><code>CREATE FUNCTION myfunc_double RETURNS REAL SONAME 'udf_example.so';</code></strong>
mysql&gt; <strong class="userinput"><code>CREATE FUNCTION myfunc_int RETURNS INTEGER SONAME 'udf_example.so';</code></strong>
mysql&gt; <strong class="userinput"><code>CREATE FUNCTION sequence RETURNS INTEGER SONAME 'udf_example.so';</code></strong>
mysql&gt; <strong class="userinput"><code>CREATE FUNCTION lookup RETURNS STRING SONAME 'udf_example.so';</code></strong>
mysql&gt; <strong class="userinput"><code>CREATE FUNCTION reverse_lookup</code></strong>
    -&gt;        <strong class="userinput"><code>RETURNS STRING SONAME 'udf_example.so';</code></strong>
mysql&gt; <strong class="userinput"><code>CREATE AGGREGATE FUNCTION avgcost</code></strong>
    -&gt;        <strong class="userinput"><code>RETURNS REAL SONAME 'udf_example.so';</code></strong>
</pre><p>
          関数を削除するには、<code class="literal">DROP FUNCTION</code> を使用します。
        </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>DROP FUNCTION metaphon;</code></strong>
mysql&gt; <strong class="userinput"><code>DROP FUNCTION myfunc_double;</code></strong>
mysql&gt; <strong class="userinput"><code>DROP FUNCTION myfunc_int;</code></strong>
mysql&gt; <strong class="userinput"><code>DROP FUNCTION sequence;</code></strong>
mysql&gt; <strong class="userinput"><code>DROP FUNCTION lookup;</code></strong>
mysql&gt; <strong class="userinput"><code>DROP FUNCTION reverse_lookup;</code></strong>
mysql&gt; <strong class="userinput"><code>DROP FUNCTION avgcost;</code></strong>
</pre><p>
          <code class="literal">CREATE FUNCTION</code> ステートメントおよび <code class="literal">DROP FUNCTION</code> ステートメントは、<code class="literal">mysql</code> データベースの <code class="literal">func</code> システムテーブルを更新します。関数の名前、型、および共有ライブラリ名は、このテーブルに保存されます。関数を作成または削除するには、<code class="literal">mysql</code> データベースの <code class="literal">INSERT</code> 権限または <code class="literal">DELETE</code> 権限をそれぞれ持っている必要があります。
        </p><p>
          すでに作成されている関数を <code class="literal">CREATE FUNCTION</code> を使用して追加しないでください。関数を再インストールする必要がある場合は、<code class="literal">DROP FUNCTION</code> を使用して関数を削除してから、<code class="literal">CREATE FUNCTION</code> を使用して再インストールする必要があります。これを行う必要があるのは、たとえば、<span class="command"><strong>mysqld</strong></span> が関数の新しいバージョンを取得するように、新しいバージョンを再コンパイルする場合です。そうしないと、サーバーは古いバージョンを使用し続けます。
        </p><p>
          アクティブ関数とは、<code class="literal">CREATE FUNCTION</code> を使用してロードされていて、<code class="literal">DROP FUNCTION</code> を使用して削除されていない関数です。すべてのアクティブ関数は、サーバーが起動するたびにリロードされますが、<code class="option">--skip-grant-tables</code> オプションを指定して <span class="command"><strong>mysqld</strong></span> を起動した場合は異なります。この場合は、UDF の初期化がスキップされ、UDF は使用できません。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="udf-security"></a>24.3.2.6 ユーザー定義関数のセキュリティー上の予防措置</h4></div></div></div><p>
          MySQL では、ユーザー定義関数の誤用を防ぐためのさまざまな対策が講じられています。
        </p><p>
          UDF オブジェクトファイルは任意のディレクトリに配置できません。これらはサーバーのプラグインディレクトリに配置する必要があります。このディレクトリは、<code class="literal">plugin_dir</code> システム変数の値から取得できます。
        </p><p>
          <code class="literal">CREATE FUNCTION</code> または <code class="literal">DROP FUNCTION</code> を使用するには、<code class="literal">mysql</code> データベースの <code class="literal">INSERT</code> 権限または <code class="literal">DELETE</code> 権限をそれぞれ持っている必要があります。これが必要となるのは、これらのステートメントが <code class="literal">mysql.func</code> テーブルに対して行の追加および削除を行うためです。
        </p><p>
          UDF には、メインの <code class="literal">xxx()</code> 関数に対応する <code class="literal">xxx</code> シンボルのほかに、少なくとも 1 つのシンボルが定義してください。これらの補助シンボルは、<code class="literal">xxx_init()</code>、<code class="literal">xxx_deinit()</code>、<code class="literal">xxx_reset()</code>、<code class="literal">xxx_clear()</code>、および <code class="literal">xxx_add()</code> 関数に対応します。<span class="command"><strong>mysqld</strong></span> では、<code class="literal">xxx</code> シンボルのみを持つ UDF をロードできるかどうかを制御する <code class="option">--allow-suspicious-udfs</code> オプションもサポートされています。デフォルトでは、このオプションはオフになっており、正当な UDF が含まれている共有オブジェクトファイル以外から関数がロードされることを防いでいます。<code class="literal">xxx</code> シンボルのみが含まれていて、補助シンボルを含めるように再コンパイルできない古い UDF がある場合は、<code class="option">--allow-suspicious-udfs</code> オプションを指定する必要がある場合があります。それ以外の場合は、この機能を有効にしないようにしてください。
        </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adding-native-function"></a>24.3.3 新しいネイティブ関数の追加</h3></div></div></div><a class="indexterm" name="idm139978996449360"></a><a class="indexterm" name="idm139978996447232"></a><a class="indexterm" name="idm139978996445184"></a><p>
        新しいネイティブ MySQL 関数を追加するには、ここで説明している手順を使用します。この手順では、ソース配布を使用する必要があります。ネイティブ関数をバイナリ配布に追加することはできません。その場合、MySQL ソースコードを変更して、変更されたソースから MySQL をコンパイルする必要があるためです。別のバージョンの MySQL に移行する場合 (たとえば、新しいバージョンがリリースされたとき) は、新しいバージョンを使用してこの手順を繰り返す必要があります。
      </p><p>
        スレーブサーバーにレプリケートされるステートメントで新しいネイティブ関数が参照される場合は、すべてのスレーブサーバーで関数を使用できるようにする必要があります。そうしないと、スレーブでその関数を呼び出そうとしたときに、レプリケーションがスレーブで失敗します。
      </p><p>
        新しいネイティブ関数を追加するには、次のステップに従って、<code class="filename">sql</code> ディレクトリ内のソースファイルを変更します。
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
            <code class="filename">item_create.cc</code> に関数のためのサブクラスを作成します。
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                関数が固定された数の引数を受け取る場合は、関数が受け取る引数の数 (0、1、2、または 3 個) に応じて、<code class="literal">Create_func_arg0</code>、<code class="literal">Create_func_arg1</code>、<code class="literal">Create_func_arg2</code>、または <code class="literal">Create_func_arg3</code> のサブクラスをそれぞれ作成します。たとえば、<code class="literal">Create_func_uuid</code>、<code class="literal">Create_func_abs</code>、<code class="literal">Create_func_pow</code>、および <code class="literal">Create_func_lpad</code> クラスを参照してください。
              </p></li><li class="listitem"><p>
                関数が受け取る引数の数が可変の場合は、<code class="literal">Create_native_func</code> のサブクラスを作成します。たとえば、<code class="literal">Create_func_concat</code> を参照してください。
              </p></li></ul></div></li><li class="listitem"><p>
            SQL ステートメントで関数を参照できる名前を指定するには、次の配列に行を追加することによって <code class="filename">item_create.cc</code> に名前を登録します。
          </p><pre class="programlisting">
static Native_func_registry func_array[]
</pre><p>
            同じ関数に対して複数の名前を登録できます。たとえば、<code class="literal">"LCASE"</code> および <code class="literal">"LOWER"</code> の行を参照してください。これらは <code class="literal">Create_func_lcase</code> のエイリアスです。
          </p></li><li class="listitem"><p>
            <code class="filename">item_func.h</code> に、関数が数値または文字列のいずれを返すかに応じて、<code class="literal">Item_num_func</code> または <code class="literal">Item_str_func</code> から継承するクラスを宣言します。
          </p></li><li class="listitem"><p>
            <code class="filename">item_func.cc</code> に、数値関数または文字列関数のいずれを定義するかに応じて、次のいずれかの宣言を追加します。
          </p><pre class="programlisting">
double   Item_func_newname::val()
longlong Item_func_newname::val_int()
String  *Item_func_newname::Str(String *str)
</pre><p>
            標準的な項目 (<code class="literal">Item_num_func</code> など) からオブジェクトを継承する場合は、それらの関数のいずれかを定義するだけで、多くの場合、親オブジェクトによってほかの関数が提供されます。たとえば、<code class="literal">Item_str_func</code> クラスは、<code class="literal">::str()</code> によって返された値に対して <code class="literal">atof()</code> を実行する <code class="literal">val()</code> 関数を定義しています。
          </p></li><li class="listitem"><p>
            関数に決定性がない場合は、関数の結果をキャッシュしないことを示すために、次のステートメントを項目のコンストラクタに含めます。
          </p><pre class="programlisting">
current_thd-&gt;lex-&gt;safe_to_cache_query=0;
</pre><p>
            関数に決定性がない状態とは、引数の値が固定されていても、呼び出しごとに異なる結果が返されることがある場合です。
          </p></li><li class="listitem"><p>
            多くの場合、次のオブジェクト関数も定義します。
          </p><pre class="programlisting">
void Item_func_newname::fix_length_and_dec()
</pre><p>
            この関数は、指定された引数に基づいて、少なくとも <code class="literal">max_length</code> を計算します。<code class="literal">max_length</code> は関数が返すことができる最大文字数です。メイン関数が <code class="literal">NULL</code> 値を返せない場合は、この関数で <code class="literal">maybe_null = 0</code> も設定します。この関数は、引数の <code class="literal">maybe_null</code> 変数をチェックすることによって、関数のいずれかの引数が <code class="literal">NULL</code> を返すことがあるかどうかをチェックできます。これを実行する方法の典型的な例については、<code class="literal">Item_func_mod::fix_length_and_dec</code> を参照してください。
          </p></li></ol></div><p>
        すべての関数はスレッドセーフである必要があります。言い換えると、関数内で相互排他ロックで保護せずにグローバル変数または静的変数を使用しないでください。
      </p><p>
        <code class="literal">::val()</code>、<code class="literal">::val_int()</code>、または <code class="literal">::str()</code> から <code class="literal">NULL</code> を返す場合は、<code class="literal">null_value</code> を 1 に設定して 0 を返します。
      </p><p>
        <code class="literal">::str()</code> オブジェクト関数については、注意すべき追加の考慮事項があります。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">String *str</code> 引数は、結果を保持するために使用できる文字列バッファーを提供します。(<code class="literal">String</code> 型の詳細は、<code class="filename">sql_string.h</code> ファイルを参照してください。)
          </p></li><li class="listitem"><p>
            <code class="literal">::str()</code> 関数では、結果が保持されている文字列を返すか、結果が <code class="literal">NULL</code> の場合は <code class="literal">(char*) 0</code> を返します。
          </p></li><li class="listitem"><p>
            現在のすべての文字列関数は、絶対に必要である場合を除き、メモリーの割り当てを回避しようとします。
          </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="porting"></a>24.4 MySQL のデバッグおよび移植</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#debugging-server">24.4.1 MySQL サーバーのデバッグ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#debugging-client">24.4.2 MySQL クライアントのデバッグ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#dbug-package">24.4.3 DBUG パッケージ</a></span></dt></dl></div><a class="indexterm" name="idm139978996383520"></a><p>
      このセクションは、MySQL をほかのオペレーティングシステムに移植する場合に役立ちます。まず、現在サポートされているオペレーティングシステムのリストを確認してください。<a class="ulink" href="http://www.mysql.com/support/supportedplatforms/database.html" target="_top">http://www.mysql.com/support/supportedplatforms/database.html</a> を参照してください。MySQL の新しい移植版を作成した場合は、オラクルにお知らせください。このドキュメントおよび Web サイト (http://www.mysql.com/) にそれを示して、ほかのユーザーに推奨します。
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">注記</div><p>
        MySQL の新しい移植版を作成した場合は、GPL ライセンスに基づいて自由にコピーおよび配布できますが、MySQL の著作権所有者になるわけではありません。
      </p></div><p>
      動作する POSIX スレッドライブラリがサーバーで必要となります。
    </p><p>
      MySQL をソースからビルドするには、<a class="xref" href="installing.html#source-installation" title="2.9 ソースから MySQL をインストールする">セクション2.9「ソースから MySQL をインストールする」</a>に示されているツール要件をシステムが満たしている必要があります。
    </p><a class="indexterm" name="idm139978996376320"></a><a class="indexterm" name="idm139978996374240"></a><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">重要</div><p>
        IA64 プラットフォームで <span class="command"><strong>icc</strong></span> を使用して MySQL 5.6 をビルドしようとしていて、MySQL Cluster のサポートが必要な場合は、まず <span class="command"><strong>icc</strong></span> バージョン 9.1.043 以降を使用していることを確認してください。(詳細は、Bug #21875 を参照してください。)
      </p></div><p>
      新しい移植版で問題が発生した場合は、MySQL のデバッグを行う必要があることがあります。<a class="xref" href="extending-mysql.html#debugging-server" title="24.4.1 MySQL サーバーのデバッグ">セクション24.4.1「MySQL サーバーのデバッグ」</a>を参照してください。
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">注記</div><p>
        <span class="command"><strong>mysqld</strong></span> のデバッグを開始する前に、まずテストプログラム <code class="literal">mysys/thr_alarm</code> および <code class="literal">mysys/thr_lock</code> を使用できるようにします。これにより、スレッドがわずかながらも動作する可能性があります。
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="debugging-server"></a>24.4.1 MySQL サーバーのデバッグ</h3></div></div></div><div class="toc"><dl class="toc"><dt><span class="section"><a href="extending-mysql.html#compiling-for-debugging">24.4.1.1 デバッグのための MySQL のコンパイル</a></span></dt><dt><span class="section"><a href="extending-mysql.html#making-trace-files">24.4.1.2 トレースファイルの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#making-windows-dumps">24.4.1.3 pdb を使用した Windows のクラッシュダンプの作成</a></span></dt><dt><span class="section"><a href="extending-mysql.html#using-gdb-on-mysqld">24.4.1.4 gdb での mysqld のデバッグ</a></span></dt><dt><span class="section"><a href="extending-mysql.html#using-stack-trace">24.4.1.5 スタックトレースの使用</a></span></dt><dt><span class="section"><a href="extending-mysql.html#using-log-files">24.4.1.6 mysqld でのエラーの原因を見つけるためのサーバーログの使用</a></span></dt><dt><span class="section"><a href="extending-mysql.html#reproducible-test-case">24.4.1.7 テーブルが破損した場合のテストケースの作成</a></span></dt></dl></div><a class="indexterm" name="idm139978996363456"></a><a class="indexterm" name="idm139978996361344"></a><a class="indexterm" name="idm139978996359312"></a><p>
        MySQL で非常に新しい一部の機能を使用している場合は、<code class="option">--skip-new</code> (安全でない可能性がある新しい機能がすべて無効にされます) を指定して <span class="command"><strong>mysqld</strong></span> の実行を試みることができます。<a class="xref" href="error-handling.html#crashing" title="B.5.4.2 MySQL が繰り返しクラッシュする場合の対処方法">セクションB.5.4.2「MySQL が繰り返しクラッシュする場合の対処方法」</a>を参照してください。
      </p><p>
        <span class="command"><strong>mysqld</strong></span> が起動しない場合は、セットアップを妨げている <code class="filename">my.cnf</code> ファイルがないことを確認してください。<code class="filename">my.cnf</code> の引数をチェックするには <span class="command"><strong>mysqld --print-defaults</strong></span> を使用します。<span class="command"><strong>mysqld --no-defaults ...</strong></span> を指定して起動するとそれらの引数は使用されません。
      </p><p>
        <span class="command"><strong>mysqld</strong></span> が CPU やメモリーを使い尽くしてしまうようになった場合、または<span class="quote">「<span class="quote">ハングアップ</span>」</span>する場合は、<span class="command"><strong>mysqladmin processlist status</strong></span> を使用すると、ユーザーが長時間かかるクエリーを実行しているかどうかを確認できます。パフォーマンスの問題、または新しいクライアントが接続できないことに関する問題がある場合は、ほかのウィンドウで <span class="command"><strong>mysqladmin -i10 processlist status</strong></span> を実行すると役に立つことがあります。
      </p><p>
        <span class="command"><strong>mysqladmin debug</strong></span> コマンドは、使用されているロック、使用されているメモリー、およびクエリーの使用状況に関する情報を MySQL ログファイルにダンプします。これは一部の問題の解決に役立つことがあります。また、このコマンドでは、MySQL をデバッグ用にまだコンパイルしていなくても、役立つ情報が提供されます。
      </p><p>
        一部のテーブルが徐々に遅くなるという問題がある場合は、<code class="literal">OPTIMIZE TABLE</code> または <span class="command"><strong>myisamchk</strong></span> を使用してテーブルを最適化することを試みてください。<a class="xref" href="server-administration.html" title="第 5 章 MySQL サーバーの管理">第5章「<i>MySQL サーバーの管理</i>」</a> を参照してください。また、遅いクエリーを <code class="literal">EXPLAIN</code> でチェックしてください。
      </p><p>
        また、使用している環境に特有である可能性がある問題については、このマニュアルの OS 固有のセクションをお読みください。<a class="xref" href="installing.html#general-installation-issues" title="2.1 一般的なインストールガイド">セクション2.1「一般的なインストールガイド」</a>を参照してください。
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="compiling-for-debugging"></a>24.4.1.1 デバッグのための MySQL のコンパイル</h4></div></div></div><p>
          非常に特定された問題がある場合は、MySQL のデバッグを試みることができます。これを実行するには、<code class="option">-DWITH_DEBUG=1</code> オプションを指定して MySQL を構成する必要があります。<span class="command"><strong>mysqld --help</strong></span> を実行すると、MySQL がデバッグ付きでコンパイルされたかどうかを確認できます。<code class="option">--debug</code> フラグがオプションとともに示される場合は、デバッグが有効にされています。この場合は、<span class="command"><strong>mysqladmin ver</strong></span> でも <span class="command"><strong>mysqld</strong></span> バージョンが <span class="command"><strong>mysql ... --debug</strong></span> として示されます。
        </p><p>
          <span class="command"><strong>mysqld</strong></span> に <code class="option">-DWITH_DEBUG=1</code> CMake オプションを指定して構成するとクラッシュして停止する場合は、MySQL 内のコンパイラのバグまたはタイミングのバグが検出された可能性があります。この場合は、<code class="option">-DWITH_DEBUG=1</code> を使用せずに、<code class="option">CMAKE_C_FLAGS</code> および <code class="option">CMAKE_CXX_FLAGS</code> CMake オプションを使用して <code class="option">-g</code> の追加を試みることができます。<span class="command"><strong>mysqld</strong></span> が異常終了した場合は、少なくとも <span class="command"><strong>gdb</strong></span> を使用してそれに接続するか、コアファイルに対して <span class="command"><strong>gdb</strong></span> を使用して、発生した事象を確認できます。
        </p><p>
          MySQL をデバッグ用に構成すると、<span class="command"><strong>mysqld</strong></span> のヘルスをモニターする多くの追加の安全チェック機能が自動的に有効になります。<span class="quote">「<span class="quote">予期しない</span>」</span>現象が検出された場合、<code class="literal">stderr</code> にエントリが書き込まれ、これは <span class="command"><strong>mysqld_safe</strong></span> によってエラーログに送られます。また、これは、ソース配布を使用していて、MySQL に予期しない問題があった場合、最初に行うことは MySQL をデバッグ用に構成することであることを意味します。(2 番目にすることは、MySQL のメーリングリストにメールを送信して支援を求めることです。<a class="xref" href="introduction.html#mailing-lists" title="1.6.1 MySQL メーリングリスト">セクション1.6.1「MySQL メーリングリスト」</a> を参照してください。バグを見つけたと思われる場合は、<a class="xref" href="introduction.html#bug-reports" title="1.7 質問またはバグをレポートする方法">セクション1.7「質問またはバグをレポートする方法」</a>の手順を使用してください。
        </p><p>
          Windows の MySQL 配布では、<code class="literal">mysqld.exe</code> はデフォルトでトレースファイルをサポートするようにコンパイルされています。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="making-trace-files"></a>24.4.1.2 トレースファイルの作成</h4></div></div></div><p>
          <span class="command"><strong>mysqld</strong></span> サーバーが起動しない場合、またはサーバーがすぐにクラッシュしてしまう場合は、問題を見つけるためにトレースファイルの作成を試みることができます。
        </p><p>
          これを行うには、デバッグサポート付きでコンパイルされている <span class="command"><strong>mysqld</strong></span> がある必要があります。これは <code class="literal">mysqld -V</code> を実行することによって確認できます。バージョン番号が <code class="literal">-debug</code> で終わっている場合は、トレースファイルのサポート付きでコンパイルされています。(Windows の場合、MySQL 4.1 以降では、デバッグサーバーの名前は <span class="command"><strong>mysqld</strong></span> ではなく <span class="command"><strong>mysqld-debug</strong></span> です。)
        </p><p>
          Unix の場合は <code class="filename">/tmp/mysqld.trace</code>、Windows の場合は <code class="filename">\mysqld.trace</code> にあるトレースログを使用して、<span class="command"><strong>mysqld</strong></span> サーバーを起動します。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>mysqld --debug</code></strong>
</pre><p>
          Windows では、<span class="command"><strong>mysqld</strong></span> をサービスとして起動しないようにするために、<code class="option">--standalone</code> フラグも使用してください。コンソールウィンドウで、次のコマンドを使用します。
        </p><pre class="programlisting">
C:\&gt; <strong class="userinput"><code>mysqld-debug --debug --standalone</code></strong>
</pre><p>
          このあと、2 つ目のコンソールウィンドウで <code class="literal">mysql.exe</code> コマンド行ツールを使用して、問題を再現できます。<span class="command"><strong>mysqld</strong></span> サーバーを停止するには、<span class="command"><strong>mysqladmin shutdown</strong></span> を使用します。
        </p><p>
          トレースファイルは<span class="bold"><strong>非常に大きく</strong></span>なることがあります。より小さいトレースファイルが生成されるようにするには、次のようなデバッグオプションを使用できます。
        </p><p>
          <span class="command"><strong>mysqld --debug=d,info,error,query,general,where:O,/tmp/mysqld.trace</strong></span>
        </p><p>
          これにより、もっとも関心があるタグの情報のみがトレースファイルに出力されます。
        </p><p>
          これに関するバグレポートを作成する場合は、動作に問題があると思われるトレースファイルの行のみを、該当するメーリングリストに送信してください。問題のある場所を見つけることができない場合は、バグレポートを開いて、MySQL の開発者が調査できるように、トレースファイルをレポートにアップロードしてください。手順については、<a class="xref" href="introduction.html#bug-reports" title="1.7 質問またはバグをレポートする方法">セクション1.7「質問またはバグをレポートする方法」</a>を参照してください。
        </p><p>
          トレースファイルは、Fred Fish が作成した <span class="bold"><strong>DBUG</strong></span> パッケージによって生成されます。<a class="xref" href="extending-mysql.html#dbug-package" title="24.4.3 DBUG パッケージ">セクション24.4.3「DBUG パッケージ」</a>を参照してください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="making-windows-dumps"></a>24.4.1.3 pdb を使用した Windows のクラッシュダンプの作成</h4></div></div></div><p>
          プログラムデータベースファイル (拡張子は <code class="filename">pdb</code>) は、MySQL の非インストール配布に含まれています。これらのファイルには、問題が発生したときに MySQL インストール環境をデバッグするための情報が含まれています。
        </p><p>
          PDB ファイルには、より詳細なトレースファイルおよびダンプファイルを作成できる、<code class="literal">mysqld</code> およびその他のツールについての詳細な情報が含まれています。これらをワトソン博士、<span class="command"><strong>WinDbg</strong></span>、および Visual Studio とともに使用して、<span class="command"><strong>mysqld</strong></span> をデバッグできます。
        </p><p>
          PDB ファイルについては、<a class="ulink" href="http://support.microsoft.com/kb/121366/" target="_top">Microsoft サポート技術情報の記事 121366</a> を参照してください。使用可能なデバッグオプションについては、<a class="ulink" href="http://www.microsoft.com/whdc/devtools/debugging/default.mspx" target="_top">Windows のデバッグツール</a>を参照してください。
        </p><p>
          ワトソン博士はすべての Windows 配布でインストールされますが、Windows 開発ツールをインストールした場合、ワトソン博士は Visual Studio に付属しているデバッガである WinDbg、または Borland や Delphi で提供されているデバッグツールに置き換えられている可能性があります。
        </p><p>
          ワトソン博士を使用してクラッシュファイルを生成するには、次の手順に従います。
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
              <code class="option">-i</code> オプションを使用して <span class="command"><strong>drwtsn32.exe</strong></span> を対話的に実行することによって、ワトソン博士を起動します。
            </p><pre class="programlisting">
C:\&gt; <strong class="userinput"><code>drwtsn32 -i</code></strong>
</pre></li><li class="listitem"><p>
              <span class="guilabel">「ログ ファイルのパス」</span>にトレースファイルを格納するディレクトリを設定します。
            </p></li><li class="listitem"><p>
              <span class="guilabel">「すべてのスレッド コンテキストをダンプ」</span>および<span class="guilabel">「既存のログ ファイルに追加する」</span>が選択されていることを確認します。
            </p></li><li class="listitem"><p>
              <span class="guilabel">「ダンプ シンボル テーブル」</span>、<span class="guilabel">「メッセージ ボックスによる通知」</span>、<span class="guilabel">「音による通知」</span>、および<span class="guilabel">「クラッシュ ダンプ ファイルの作成」</span>のチェックを外します。
            </p></li><li class="listitem"><p>
              <span class="guilabel">「インストラクションの数」</span>に、スタックトレース内の呼び出しを必要なだけ取得できる値を設定します。値は 25 にすれば十分です。
            </p></li></ol></div><p>
          生成されるファイルは、非常に大きくなる可能性があります。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="using-gdb-on-mysqld"></a>24.4.1.4 gdb での mysqld のデバッグ</h4></div></div></div><a class="indexterm" name="idm139978996266800"></a><p>
          ほとんどのシステムでは、<span class="command"><strong>mysqld</strong></span> がクラッシュした場合に詳細な情報を取得するために、<span class="command"><strong>gdb</strong></span> からも <span class="command"><strong>mysqld</strong></span> を起動できます。
        </p><p>
          Linux の一部の古い <span class="command"><strong>gdb</strong></span> バージョンでは、<span class="command"><strong>mysqld</strong></span> のスレッドをデバッグできるようにするには、<code class="literal">run --one-thread</code> を使用する必要があります。この場合、一度にアクティブにできるのは 1 つのスレッドのみです。スレッドのデバッグは <span class="command"><strong>gdb</strong></span> 5.1 のほうがより良く機能するため、このバージョンにアップグレードすると最適です。
        </p><p>
          <span class="command"><strong>gdb</strong></span> で <span class="command"><strong>mysqld</strong></span> を実行すると、NPTL スレッド (Linux の新しいスレッドライブラリ) に起因する問題が発生することがあります。次のような現象が発生します。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <span class="command"><strong>mysqld</strong></span> が起動中 (<code class="literal">「接続準備完了」</code>と出力される前) にハングアップする。
            </p></li><li class="listitem"><p>
              <span class="command"><strong>mysqld</strong></span> が <code class="literal">pthread_mutex_lock()</code> または <code class="literal">pthread_mutex_unlock()</code> の呼び出し中にクラッシュする。
            </p></li></ul></div><p>
          この場合、<span class="command"><strong>gdb</strong></span> を起動する前に、シェルで次の環境変数を設定してください。
        </p><pre class="programlisting">
LD_ASSUME_KERNEL=2.4.1
export LD_ASSUME_KERNEL
</pre><p>
          <span class="command"><strong>gdb</strong></span> で <span class="command"><strong>mysqld</strong></span> を実行するときは、<code class="option">--skip-stack-trace</code> を使用してスタックトレースを無効にし、<span class="command"><strong>gdb</strong></span> 内でセグメンテーション違反を捕捉できるようにする必要があります。
        </p><p>
          MySQL 4.0.14 以降では、<span class="command"><strong>mysqld</strong></span> に <code class="option">--gdb</code> オプションを使用してください。これにより、<code class="literal">SIGINT</code> 用の割り込みハンドラ (<span class="command"><strong>mysqld</strong></span> を <code class="literal">^C</code> で停止してブレークポイントを設定するために必要となります) がインストールされ、スタックトレースおよびコアファイル処理が無効になります。
        </p><p>
          新しい接続が常時多数発生する場合、<span class="command"><strong>gdb</strong></span> は古いスレッドのメモリーを解放しないため、<span class="command"><strong>gdb</strong></span> で MySQL をデバッグすることは非常に困難です。この問題を回避するには、<code class="literal">thread_cache_size</code> を <code class="literal">max_connections</code> + 1 に等しい値に設定して <span class="command"><strong>mysqld</strong></span> を起動します。ほとんどの場合、<code class="option">--thread_cache_size=5'</code> を使用するだけでもかなり改善されます。
        </p><p>
          SIGSEGV シグナルが発生して <span class="command"><strong>mysqld</strong></span> が異常終了したときに Linux でコアダンプを取得する場合は、<code class="option">--core-file</code> オプションを指定して <span class="command"><strong>mysqld</strong></span> を起動します。このコアファイルは、<span class="command"><strong>mysqld</strong></span> が異常終了した理由を見つけるために役立つことがあるバックトレースを作成するために使用できます。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>gdb mysqld core</code></strong>
gdb&gt;   backtrace full
gdb&gt;   quit
</pre><p>
          <a class="xref" href="error-handling.html#crashing" title="B.5.4.2 MySQL が繰り返しクラッシュする場合の対処方法">セクションB.5.4.2「MySQL が繰り返しクラッシュする場合の対処方法」</a>を参照してください。
        </p><p>
          Linux で <span class="command"><strong>gdb</strong></span> 4.17.x 以降を使用している場合は、次の情報を持つ <code class="filename">.gdb</code> ファイルを現在のディレクトリにインストールしてください。
        </p><pre class="programlisting">
set print sevenbit off
handle SIGUSR1 nostop noprint
handle SIGUSR2 nostop noprint
handle SIGWAITING nostop noprint
handle SIGLWP nostop noprint
handle SIGPIPE nostop
handle SIGALRM nostop
handle SIGHUP nostop
handle SIGTERM nostop noprint
</pre><p>
          <span class="command"><strong>gdb</strong></span> を使用したスレッドのデバッグに問題がある場合、gdb 5.x をダウンロードし、これを代わりに試してみてください。新しいバージョンの <span class="command"><strong>gdb</strong></span> ではスレッド処理が非常に改善されています。
        </p><p>
          <span class="command"><strong>mysqld</strong></span> をデバッグする方法の例を次に示します。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>gdb /usr/local/libexec/mysqld</code></strong>
gdb&gt; run
...
backtrace full # Do this when mysqld crashes
</pre><p>
          上記の出力をバグレポートに含め、<a class="xref" href="introduction.html#bug-reports" title="1.7 質問またはバグをレポートする方法">セクション1.7「質問またはバグをレポートする方法」</a>の手順を使用してバグレポートを提出できます。
        </p><p>
          <span class="command"><strong>mysqld</strong></span> がハングアップした場合は、<code class="literal">strace</code>、<code class="literal">/usr/proc/bin/pstack</code> などのシステムツールを使用して、<span class="command"><strong>mysqld</strong></span> がハングアップした場所を調査できます。
        </p><pre class="programlisting">
strace /tmp/log libexec/mysqld
</pre><a class="indexterm" name="idm139978996214096"></a><a class="indexterm" name="idm139978996212752"></a><a class="indexterm" name="idm139978996211264"></a><a class="indexterm" name="idm139978996209872"></a><p>
          Perl の <code class="literal">DBI</code> インタフェースを使用している場合は、<code class="literal">trace</code> メソッドを使用するか、<code class="literal">DBI_TRACE</code> 環境変数を設定することによって、デバッグ情報をオンにできます。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="using-stack-trace"></a>24.4.1.5 スタックトレースの使用</h4></div></div></div><p>
          オペレーティングシステムによっては、<span class="command"><strong>mysqld</strong></span> が予期せずに異常終了した場合に、エラーログにスタックトレースが含まれています。これを使用して、<span class="command"><strong>mysqld</strong></span> が異常終了した場所 (および多くの場合その理由) を見つけることができます。<a class="xref" href="server-administration.html#error-log" title="5.2.2 エラーログ">セクション5.2.2「エラーログ」</a> を参照してください。スタックトレースを取得するには、<code class="option">-fomit-frame-pointer</code> オプションを gcc に指定して <span class="command"><strong>mysqld</strong></span> をコンパイルしないでください。<a class="xref" href="extending-mysql.html#compiling-for-debugging" title="24.4.1.1 デバッグのための MySQL のコンパイル">セクション24.4.1.1「デバッグのための MySQL のコンパイル」</a>を参照してください。
        </p><p>
          エラーログのスタックトレースは次のように出力されます。
        </p><pre class="programlisting">
mysqld got signal 11;
Attempting backtrace. You can use the following information
to find out where mysqld died. If you see no messages after
this, something went terribly wrong...

stack_bottom = 0x41fd0110 thread_stack 0x40000
mysqld(my_print_stacktrace+0x32)[0x9da402]
mysqld(handle_segfault+0x28a)[0x6648e9]
/lib/libpthread.so.0[0x7f1a5af000f0]
/lib/libc.so.6(strcmp+0x2)[0x7f1a5a10f0f2]
mysqld(_Z21check_change_passwordP3THDPKcS2_Pcj+0x7c)[0x7412cb]
mysqld(_ZN16set_var_password5checkEP3THD+0xd0)[0x688354]
mysqld(_Z17sql_set_variablesP3THDP4ListI12set_var_baseE+0x68)[0x688494]
mysqld(_Z21mysql_execute_commandP3THD+0x41a0)[0x67a170]
mysqld(_Z11mysql_parseP3THDPKcjPS2_+0x282)[0x67f0ad]
mysqld(_Z16dispatch_command19enum_server_commandP3THDPcj+0xbb7[0x67fdf8]
mysqld(_Z10do_commandP3THD+0x24d)[0x6811b6]
mysqld(handle_one_connection+0x11c)[0x66e05e]
</pre><p>
          トレースの関数名の解決に失敗した場合、トレースに格納される情報が少なくなります。
        </p><pre class="programlisting">
mysqld got signal 11;
Attempting backtrace. You can use the following information
to find out where mysqld died. If you see no messages after
this, something went terribly wrong...

stack_bottom = 0x41fd0110 thread_stack 0x40000
[0x9da402]
[0x6648e9]
[0x7f1a5af000f0]
[0x7f1a5a10f0f2]
[0x7412cb]
[0x688354]
[0x688494]
[0x67a170]
[0x67f0ad]
[0x67fdf8]
[0x6811b6]
[0x66e05e]
</pre><p>
          後者の場合は、<span class="command"><strong>resolve_stack_dump</strong></span> ユーティリティーを使用して、次の手順を使用することによって、<span class="command"><strong>mysqld</strong></span> が異常終了した場所を判別できます。
        </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
              スタックトレースから <code class="filename">mysqld.stack</code> などのファイルに数値をコピーします。この数値には、囲んでいた角括弧を含めないでください。
            </p><pre class="programlisting">
0x9da402
0x6648e9
0x7f1a5af000f0
0x7f1a5a10f0f2
0x7412cb
0x688354
0x688494
0x67a170
0x67f0ad
0x67fdf8
0x6811b6
0x66e05e
</pre></li><li class="listitem"><p>
              <span class="command"><strong>mysqld</strong></span> サーバーのシンボルファイルを作成します。
            </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>nm -n libexec/mysqld &gt; /tmp/mysqld.sym</code></strong>
</pre><p>
              <span class="command"><strong>mysqld</strong></span> が静的にリンクされていない場合は、代わりに次のコマンドを使用します。
            </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>nm -D -n libexec/mysqld &gt; /tmp/mysqld.sym</code></strong>
</pre><p>
              C++ のシンボルをデコードする場合は、<span class="command"><strong>nm</strong></span> に対して <code class="option">--demangle</code> を使用します (使用できる場合)。使用しているバージョンの <span class="command"><strong>nm</strong></span> にこのオプションがない場合は、スタックダンプが生成されたあとに <span class="command"><strong>c++filt</strong></span> コマンドを使用して、C++ 名をデマングルする必要があります。
            </p></li><li class="listitem"><p>
              次のコマンドを実行します。
            </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>resolve_stack_dump -s /tmp/mysqld.sym -n mysqld.stack</code></strong>
</pre><p>
              デマングルされた C++ 名をシンボルファイルに含めることができなかった場合は、<span class="command"><strong>c++filt</strong></span> を使用して <span class="command"><strong>resolve_stack_dump</strong></span> の出力を処理します。
            </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>resolve_stack_dump -s /tmp/mysqld.sym -n mysqld.stack | c++filt</code></strong>
</pre><p>
              これにより、<span class="command"><strong>mysqld</strong></span> が異常終了した場所が出力されます。この出力が、<span class="command"><strong>mysqld</strong></span> が異常終了した理由を見つけるために役立たない場合は、バグレポートを作成して、上記のコマンドの出力をバグレポートに含めてください。
            </p><p>
              ただし、多くの場合、スタックトレースだけがあっても問題の原因を見つけるために役立ちません。バグを見つけたり回避策を提供したりするためには、ほとんどの場合、<span class="command"><strong>mysqld</strong></span> が強制終了されたステートメントを知る必要があり、問題を再現できるテストケースがあれば役に立ちます。<a class="xref" href="introduction.html#bug-reports" title="1.7 質問またはバグをレポートする方法">セクション1.7「質問またはバグをレポートする方法」</a>を参照してください。
            </p></li></ol></div><p>
          新しいバージョンの <code class="literal">glibc</code> スタックトレース関数では、オブジェクトへの相対アドレスも出力されます。<code class="literal">glibc</code> ベースのシステム (Linux) では、プラグイン内でのクラッシュのトレースは次のようになります。
        </p><pre class="programlisting">
plugin/auth/auth_test_plugin.so(+0x9a6)[0x7ff4d11c29a6]
</pre><p>
          相対アドレス (<code class="literal">+0x9a6</code>) をファイル名および行番号に変換するには、次のコマンドを使用します。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>addr2line -fie auth_test_plugin.so 0x9a6</code></strong>
auth_test_plugin
mysql-trunk/plugin/auth/test_plugin.c:65
</pre><p>
          <span class="command"><strong>addr2line</strong></span> ユーティリティーは Linux の <code class="literal">binutils</code> パッケージの一部です。
        </p><p>
          Solaris でも手順は同様です。Solaris の <code class="literal">printstack()</code> では、相対アドレスがすでに出力されています。
        </p><pre class="programlisting">
plugin/auth/auth_test_plugin.so:0x1510
</pre><p>
          これを変換するには、次のコマンドを使用します。
        </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>gaddr2line -fie auth_test_plugin.so 0x1510</code></strong>
mysql-trunk/plugin/auth/test_plugin.c:88
</pre><p>
          Windows では、アドレス、関数名、および行がすでに出力されています。
        </p><pre class="programlisting">
000007FEF07E10A4 auth_test_plugin.dll!auth_test_plugin()[test_plugin.c:72]
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="using-log-files"></a>24.4.1.6 mysqld でのエラーの原因を見つけるためのサーバーログの使用</h4></div></div></div><p>
          一般クエリーログを有効にして <span class="command"><strong>mysqld</strong></span> を起動する前に、<span class="command"><strong>myisamchk</strong></span> を使用してすべてのテーブルをチェックしてください。<a class="xref" href="server-administration.html" title="第 5 章 MySQL サーバーの管理">第5章「<i>MySQL サーバーの管理</i>」</a> を参照してください。
        </p><p>
          <span class="command"><strong>mysqld</strong></span> が異常終了またはハングアップする場合は、一般クエリーログを有効にして <span class="command"><strong>mysqld</strong></span> を起動してください。<a class="xref" href="server-administration.html#query-log" title="5.2.3 一般クエリーログ">セクション5.2.3「一般クエリーログ」</a>を参照してください。<span class="command"><strong>mysqld</strong></span> がふたたび異常終了したら、ログファイルの最後の部分を調査して、<span class="command"><strong>mysqld</strong></span> が強制終了されたクエリーを見つけることができます。
        </p><p>
          デフォルトの一般クエリーログファイルを使用した場合、ログはデータベースディレクトリに <code class="filename"><em class="replaceable"><code>host_name</code></em>.log</code> として格納されます。ほとんどの場合、<span class="command"><strong>mysqld</strong></span> が強制終了されたのはログファイル内の最後のクエリーですが、可能であれば、<span class="command"><strong>mysqld</strong></span> を再起動して、見つかったクエリーを <span class="command"><strong>mysql</strong></span> コマンド行ツールから実行することによって、このことを検証してください。これが動作する場合は、完了しなかった複雑なクエリーもすべてテストしてください。
        </p><p>
          また、長い時間がかかるすべての <code class="literal">SELECT</code> ステートメントに対して <code class="literal">EXPLAIN</code> コマンドを試すことで、<span class="command"><strong>mysqld</strong></span> がインデックスを適切に使用していることを確認できます。<a class="xref" href="sql-syntax.html#explain" title="13.8.2 EXPLAIN 構文">セクション13.8.2「EXPLAIN 構文」</a>を参照してください。
        </p><p>
          実行に長い時間がかかるクエリーを見つけるには、スロークエリーログを有効にして <span class="command"><strong>mysqld</strong></span> を起動します。<a class="xref" href="server-administration.html#slow-query-log" title="5.2.5 スロークエリーログ">セクション5.2.5「スロークエリーログ」</a>を参照してください。
        </p><p>
          エラーログファイル (通常は <code class="filename">hostname.err</code> という名前) に <code class="literal">mysqld restarted</code> というテキストがあった場合は、<span class="command"><strong>mysqld</strong></span> でエラーが発生した原因であるクエリーが見つかった可能性があります。これが発生した場合、<span class="command"><strong>myisamchk</strong></span> を使用してすべてのテーブルをチェックし (<a class="xref" href="server-administration.html" title="第 5 章 MySQL サーバーの管理">第5章「<i>MySQL サーバーの管理</i>」</a>を参照してください)、MySQL ログファイル内のクエリーをテストして、失敗するかどうかを確認します。そのようなクエリーが見つかった場合は、まず最新バージョンの MySQL にアップグレードすることを試してください。これで解決されず、<code class="literal">mysql</code> のメールアーカイブで参考になる回答が見つからない場合は、MySQL メーリングリストにバグを報告してください。メーリングリストについては <a class="ulink" href="http://lists.mysql.com/" target="_top">http://lists.mysql.com/</a> で説明されており、アーカイブのオンラインリストへのリンクもあります。
        </p><p>
          <code class="option">--myisam-recover-options</code> を指定して <span class="command"><strong>mysqld</strong></span> を起動した場合、MySQL は「not closed properly」または「crashed」としてマークされている <code class="literal">MyISAM</code> テーブルを自動的にチェックして修復しようとします。これが発生した場合、MySQL は <code class="literal">hostname.err</code> ファイルに<code class="literal">「警告: テーブル ... をチェックしています」</code>と書き込み、テーブルを修復する必要がある場合は、<code class="literal">「警告: テーブルを修復しています」</code>がそのあとに書き込まれます。これらのエラーを多数受け取り、その直前に予期しない <span class="command"><strong>mysqld</strong></span> の停止がなかった場合は、何らかの問題があるため、さらに調査する必要があります。<a class="xref" href="server-administration.html#server-options" title="5.1.3 サーバーコマンドオプション">セクション5.1.3「サーバーコマンドオプション」</a>を参照してください。
        </p><p>
          MySQL 5.6 では、サーバーが <code class="literal">MyISAM</code> テーブルの破損を検出すると、追加の情報 (ソースファイルの名前と行番号、テーブルにアクセスしていたスレッドのリストなど) をエラーログに書き込みます。たとえば、<code class="literal">「thread_id=1 からエラーを受け取りました。mi_dynrec.c:368」</code>です。これは、バグレポートに含めると役に立つ情報です。
        </p><p>
          <span class="command"><strong>mysqld</strong></span> が予期せず異常終了することは良い兆候ではありませんが、この場合は <code class="literal">Checking table...</code> メッセージを調査するのではなく、<span class="command"><strong>mysqld</strong></span> が異常終了した原因を見つけるようにしてください。
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="reproducible-test-case"></a>24.4.1.7 テーブルが破損した場合のテストケースの作成</h4></div></div></div><p>
          テーブルが破損した場合、または一部の更新コマンドのあとに <span class="command"><strong>mysqld</strong></span> で常に障害が発生する場合は、次の手順を行うことによってこのバグが再現可能かどうかをテストできます。
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              MySQL デーモンを停止します (<span class="command"><strong>mysqladmin shutdown</strong></span> を使用します)。
            </p></li><li class="listitem"><p>
              テーブルのバックアップを作成します (非常にまれですが、修復によって何らかの障害が発生する場合に対して保護するため)。
            </p></li><li class="listitem"><p>
              <span class="command"><strong>myisamchk -s database/*.MYI</strong></span> を使用してすべてのテーブルをチェックします。不正なテーブルがあった場合は、<span class="command"><strong>myisamchk -r database/<em class="replaceable"><code>table</code></em>.MYI</strong></span> を使用して修復します。
            </p></li><li class="listitem"><p>
              テーブルの 2 番目のバックアップを作成します。
            </p></li><li class="listitem"><p>
              より多くの領域が必要な場合は、MySQL データディレクトリから古いログファイルを削除 (または移動) します。
            </p></li><li class="listitem"><p>
              バイナリログを有効にして <span class="command"><strong>mysqld</strong></span> を起動します。<span class="command"><strong>mysqld</strong></span> がクラッシュするクエリーを見つける場合は、一般クエリーログも有効にしてサーバーを起動します。<a class="xref" href="server-administration.html#query-log" title="5.2.3 一般クエリーログ">セクション5.2.3「一般クエリーログ」</a>および<a class="xref" href="server-administration.html#binary-log" title="5.2.4 バイナリログ">セクション5.2.4「バイナリログ」</a>を参照してください。
            </p></li><li class="listitem"><p>
              テーブルがクラッシュしたら、<code class="literal">mysqld サーバー</code>を停止します。
            </p></li><li class="listitem"><p>
              バックアップをリストアします。
            </p></li><li class="listitem"><p>
              バイナリログを有効に<span class="bold"><strong>せずに</strong></span>、<span class="command"><strong>mysqld</strong></span> サーバーを再起動します。
            </p></li><li class="listitem"><p>
              <span class="command"><strong>mysqlbinlog binary-log-file | mysql</strong></span> を指定してコマンドを再実行します。バイナリログは、<code class="literal">hostname-bin.<em class="replaceable"><code>NNNNNN</code></em></code> という名前で MySQL データベースディレクトリに保存されます。
            </p></li><li class="listitem"><p>
              テーブルがふたたび破損したか、上記のコマンドで <span class="command"><strong>mysqld</strong></span> が異常終了する場合は、簡単に修正できる可能性がある再現可能なバグが見つかりました。<a class="xref" href="introduction.html#bug-reports" title="1.7 質問またはバグをレポートする方法">セクション1.7「質問またはバグをレポートする方法」</a>の手順を使用して、テーブルおよびバイナリログをバグデータベースに FTP で送信してください。サポートのお客様の場合は、MySQL カスタマサポートセンター (<a class="ulink" href="http://www.mysql.com/support/" target="_top">http://www.mysql.com/support/</a>) を使用して MySQL チームにその問題を通知し、可能な限り早く修正してもらうことができます。
            </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="debugging-client"></a>24.4.2 MySQL クライアントのデバッグ</h3></div></div></div><a class="indexterm" name="idm139978996086656"></a><a class="indexterm" name="idm139978996084544"></a><p>
        統合デバッグパッケージを使用して MySQL クライアントをデバッグできるようにするには、<code class="option">-DWITH_DEBUG=1</code> を指定して MySQL を構成します。<a class="xref" href="installing.html#source-configuration-options" title="2.9.4 MySQL ソース構成オプション">セクション2.9.4「MySQL ソース構成オプション」</a>を参照してください。
      </p><a class="indexterm" name="idm139978996080448"></a><a class="indexterm" name="idm139978996078928"></a><p>
        クライアントを実行する前に、<code class="literal">MYSQL_DEBUG</code> 環境変数を設定します。
      </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>MYSQL_DEBUG=d:t:O,/tmp/client.trace</code></strong>
shell&gt; <strong class="userinput"><code>export MYSQL_DEBUG</code></strong>
</pre><p>
        これにより、クライアントは <code class="filename">/tmp/client.trace</code> にトレースファイルを生成します。
      </p><p>
        独自のクライアントコードに問題がある場合は、動作することがわかっているクライアントを使用してサーバーに接続し、クエリーを実行してください。これを行うには、<span class="command"><strong>mysql</strong></span> をデバッグモードで実行します (デバッグを有効にして MySQL をコンパイルしたことを想定しています)。
      </p><pre class="programlisting">
shell&gt; <strong class="userinput"><code>mysql --debug=d:t:O,/tmp/client.trace</code></strong>
</pre><p>
        これにより、バグレポートをメール送信するときに役立つ情報が得られます。<a class="xref" href="introduction.html#bug-reports" title="1.7 質問またはバグをレポートする方法">セクション1.7「質問またはバグをレポートする方法」</a>を参照してください。
      </p><p>
        クライアントが「正しい」ように見えるコードでクラッシュしている場合は、<code class="filename">mysql.h</code> インクルードファイルが MySQL のライブラリファイルと一致していることを確認してください。非常によくある間違いは、古い MySQL インストール環境にある古い <code class="filename">mysql.h</code> ファイルを新しい MySQL ライブラリとともに使用していることです。
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dbug-package"></a>24.4.3 DBUG パッケージ</h3></div></div></div><a class="indexterm" name="idm139978996063760"></a><p>
        MySQL サーバーおよびほとんどの MySQL クライアントは、もともと Fred Fish によって作成された DBUG パッケージとともにコンパイルされます。MySQL をデバッグ用に構成した場合は、このパッケージによって、プログラムが実行している内容のトレースファイルを取得できるようになります。<a class="xref" href="extending-mysql.html#making-trace-files" title="24.4.1.2 トレースファイルの作成">セクション24.4.1.2「トレースファイルの作成」</a>を参照してください。
      </p><p>
        このセクションでは、デバッグサポート付きでビルドされた MySQL プログラムのコマンド行のデバッグオプションに指定できる引数値をまとめています。DBUG パッケージを使用したプログラミングについては、MySQL ソース配布の <code class="filename">dbug</code> ディレクトリにある DBUG マニュアルを参照してください。最新の DBUG マニュアルを入手するには、最新の配布を使用してください。
      </p><p>
        DBUG パッケージは、<code class="option">--debug[=<em class="replaceable"><code>debug_options</code></em>]</code> または <code class="option">-# [<em class="replaceable"><code>debug_options</code></em>]</code> オプションを指定してプログラムを起動することによって使用できます。<code class="option">--debug</code> または <code class="option">-#</code> オプションを指定して、<em class="replaceable"><code>debug_options</code></em> 値を指定しない場合、ほとんどの MySQL プログラムではデフォルト値が使用されます。サーバーのデフォルトは、Unix の場合は <code class="literal">d:t:i:o,/tmp/mysqld.trace</code>、Windows の場合は <code class="literal">d:t:i:O,\mysqld.trace</code> です。このデフォルトには次のような効果があります。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="literal">d</code>: すべてのデバッグマクロの出力を有効にします
          </p></li><li class="listitem"><p>
            <code class="literal">t</code>: 関数の呼び出しおよび終了をトレースします
          </p></li><li class="listitem"><p>
            <code class="literal">i</code>: 出力行に PID を追加します
          </p></li><li class="listitem"><p>
            <code class="literal">o,/tmp/mysqld.trace</code>、<code class="literal">O,\mysqld.trace</code>: デバッグ出力ファイルを設定します
          </p></li></ul></div><p>
        ほとんどのクライアントプログラムでは、プラットフォームにかかわらず、デフォルトの <em class="replaceable"><code>debug_options</code></em> 値である <code class="literal">d:t:o,/tmp/<em class="replaceable"><code>program_name</code></em>.trace</code> が使用されます。
      </p><p>
        シェルのコマンド行で指定されることがある、デバッグ制御文字列のいくつかの例を次に示します。
      </p><pre class="programlisting">
--debug=d:t
--debug=d:f,main,subr1:F:L:t,20
--debug=d,input,output,files:n
--debug=d:t:i:O,\\mysqld.trace
</pre><p>
        <span class="command"><strong>mysqld</strong></span> の場合は、<code class="literal">debug</code> システム変数を設定することによって、DBUG 設定を実行時に変更することもできます。この変数にはグローバル値とセッション値があります。
      </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SET GLOBAL debug = '<em class="replaceable"><code>debug_options</code></em>';</code></strong>
mysql&gt; <strong class="userinput"><code>SET SESSION debug = '<em class="replaceable"><code>debug_options</code></em>';</code></strong>
</pre><p>
        実行時に変更するには、セッション値であっても <code class="literal">SUPER</code> 権限が必要となります。
      </p><p>
        <em class="replaceable"><code>debug_options</code></em> 値は、コロンで区切られた一連のフィールドです。
      </p><pre class="programlisting">
field_1:field_2:...:field_<em class="replaceable"><code>N</code></em>
</pre><p>
        この値内の各フィールドは必須のフラグ文字で構成され、フラグ文字の前に <code class="literal">+</code> 文字または <code class="literal">-</code> 文字、およびフラグ文字の後ろにカンマ区切りの修飾子のリストがオプションで付加されることがあります。
      </p><pre class="programlisting">
[+|-]flag[,modifier,modifier,...,modifier]
</pre><p>
        次の表は、許可されるフラグ文字を示しています。認識されないフラグ文字は暗黙のうちに無視されます。
      </p><div class="informaltable"><table border="1"><colgroup><col class="c1"><col class="c2"></colgroup><tbody><tr><td scope="row"><p>
                  <span class="bold"><strong>フラグ</strong></span>
                </p></td><td><p>
                  <span class="bold"><strong>説明</strong></span>
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">d</code>
                </p></td><td><p>
                  DBUG_<em class="replaceable"><code>XXX</code></em> マクロからの現在の状態に関する出力を有効にします。キーワードのリストがあとに続くことがあり、そのキーワードを使用する DBUG マクロの出力のみが有効になります。キーワードのリストが空の場合は、すべてのマクロの出力が有効になります。
                </p>



                <p>
                  MySQL では、一般的に有効にされるデバッグマクロのキーワードは、<code class="literal">enter</code>、<code class="literal">exit</code>、<code class="literal">error</code>、<code class="literal">warning</code>、<code class="literal">info</code>、および <code class="literal">loop</code> です。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">D</code>
                </p></td><td><p>
                  各デバッガの出力行のあとに待機します。引数は 0.1 秒単位の待機時間であり、マシンの能力の影響を受けます。たとえば、<code class="literal">D,20</code> は 2 秒の待機を指定します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">f</code>
                </p></td><td><p>
                  デバッグ、トレース、およびプロファイリングの対象を指定された関数のリストに制限します。空のリストの場合はすべての関数が有効になります。適切な <code class="literal">d</code> フラグまたは <code class="literal">t</code> フラグを指定する必要があり、それらのフラグが有効な場合にのみ、このフラグはそれらのフラグのアクションを制限します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">F</code>
                </p></td><td><p>
                  デバッグ出力またはトレース出力の各行にソースファイル名を示します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">i</code>
                </p></td><td><p>
                  デバッグ出力またはトレース出力の各行に PID またはスレッド ID でプロセスを示します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">L</code>
                </p></td><td><p>
                  デバッグ出力またはトレース出力の各行にソースファイルの行番号を示します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">n</code>
                </p></td><td><p>
                  デバッグ出力またはトレース出力の各行に現在の関数のネストの深さを出力します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">N</code>
                </p></td><td><p>
                  デバッグ出力の各行に番号を付けます。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">o</code>
                </p></td><td><p>
                  デバッガの出力ストリームを指定されたファイルにリダイレクトします。デフォルトの出力先は <code class="literal">stderr</code> です。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">O</code>
                </p></td><td><p>
                  <code class="literal">o</code> と似ていますが、ファイルは書き込みごとに実際にはフラッシュされます。必要な場合、ファイルが書き込みごとに閉じられてふたたび開きます。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">p</code>
                </p></td><td><p>
                  デバッガアクションを指定されたプロセスに限定します。デバッガアクションが実行されるためには、プロセスが <code class="literal">DBUG_PROCESS</code> マクロで識別され、リスト内のプロセスと一致する必要があります。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">P</code>
                </p></td><td><p>
                  デバッグ出力またはトレース出力の各行に現在のプロセス名を出力します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">r</code>
                </p></td><td><p>
                  新しい状態をプッシュするときに、前の状態の関数のネストレベルを継承しません。出力を左マージンから開始する場合に便利です。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">S</code>
                </p></td><td><p>
                  <code class="literal">_sanity()</code> から 0 以外が返されるまで、デバッグされる各関数で関数 <code class="literal">_sanity(_file_,_line_)</code> を実行します。
                </p></td></tr><tr><td scope="row"><p>
                  <code class="literal">t</code>
                </p></td><td><p>
                  関数の呼び出し/終了のトレース行を有効にします。最大のトレースレベルを示す数値を指定するリスト (修飾子が 1 つだけ含まれています) があとに続く場合があり、それを超えるとデバッグマクロまたはトレースマクロの出力は行われません。デフォルトはコンパイル時のオプションです。
                </p></td></tr></tbody></table></div><p>
        フラグの前の <code class="literal">+</code> 文字や <code class="literal">-</code> 文字、およびフラグの後ろに続く修飾子のリストは、<code class="literal">d</code>、<code class="literal">f</code> などのフラグ文字に対して使用して、該当するすべての修飾子または一部の修飾子に対してデバッグ操作を有効にできます。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            フラグの前に <code class="literal">+</code> または <code class="literal">-</code> がない場合、フラグ値は指定された修飾子リストのとおりに設定されます。
          </p></li><li class="listitem"><p>
            フラグの前に <code class="literal">+</code> または <code class="literal">-</code> がある場合は、リスト内の修飾子が現在の修飾子リストに対して追加または削除されます。
          </p></li></ul></div><p>
        次の例は、<code class="literal">d</code> フラグでのこの動作を示しています。<code class="literal">d</code> のリストが空の場合は、すべてのデバッグマクロの出力が有効になります。リストが空でない場合は、リスト内のマクロキーワードの出力のみが有効になります。
      </p><p>
        次のステートメントでは、指定されたとおりに <code class="literal">d</code> 値が修飾子リストに設定されます。
      </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SET debug = 'd';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+---------+
| @@debug |
+---------+
| d       |
+---------+
mysql&gt; <strong class="userinput"><code>SET debug = 'd,error,warning';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+-----------------+
| @@debug         |
+-----------------+
| d,error,warning |
+-----------------+
</pre><p>
        フラグの前の <code class="literal">+</code> または <code class="literal">-</code> は、現在の <code class="literal">d</code> 値に対して追加または削除を行います。
      </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SET debug = '+d,loop';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+----------------------+
| @@debug              |
+----------------------+
| d,error,warning,loop |
+----------------------+
mysql&gt; <strong class="userinput"><code>SET debug = '-d,error,loop';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+-----------+
| @@debug   |
+-----------+
| d,warning |
+-----------+
</pre><p>
        <span class="quote">「<span class="quote">すべてのマクロが有効な状態</span>」</span>に対して追加した場合は、何も変更されません。
      </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SET debug = 'd';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+---------+
| @@debug |
+---------+
| d       |
+---------+
mysql&gt; <strong class="userinput"><code>SET debug = '+d,loop';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+---------+
| @@debug |
+---------+
| d       |
+---------+
</pre><p>
        有効なすべてのマクロを無効にすると、<code class="literal">d</code> フラグは完全に無効になります。
      </p><pre class="programlisting">
mysql&gt; <strong class="userinput"><code>SET debug = 'd,error,loop';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+--------------+
| @@debug      |
+--------------+
| d,error,loop |
+--------------+
mysql&gt; <strong class="userinput"><code>SET debug = '-d,error,loop';</code></strong>
mysql&gt; <strong class="userinput"><code>SELECT @@debug;</code></strong>
+---------+
| @@debug |
+---------+
|         |
+---------+
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><div class="admon-title">注記</div><p>
          MySQL 5.6.12 より前では、<code class="literal">+</code> および <code class="literal">-</code> の修飾子が正しく処理されない場合があり、フラグ値が不正な状態のままになる可能性があります。<code class="literal">debug</code> の設定順序を事前に確認するか、<code class="literal">+</code> または <code class="literal">-</code> を使用せずに設定してください。
        </p></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="connectors-apis.html">前</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="mysql-enterprise.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">第 23 章 Connector および API </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 第 25 章 MySQL Enterprise Edition</td></tr></table></div><div class="copyright-footer"></div></body></html>
